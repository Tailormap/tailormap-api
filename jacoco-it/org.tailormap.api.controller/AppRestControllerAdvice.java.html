<?xml version="1.0" encoding="UTF-8"?><!DOCTYPE html PUBLIC "-//W3C//DTD XHTML 1.0 Strict//EN" "http://www.w3.org/TR/xhtml1/DTD/xhtml1-strict.dtd"><html xmlns="http://www.w3.org/1999/xhtml" lang="en"><head><meta http-equiv="Content-Type" content="text/html;charset=UTF-8"/><link rel="stylesheet" href="../jacoco-resources/report.css" type="text/css"/><link rel="shortcut icon" href="../jacoco-resources/report.gif" type="image/gif"/><title>AppRestControllerAdvice.java</title><link rel="stylesheet" href="../jacoco-resources/prettify.css" type="text/css"/><script type="text/javascript" src="../jacoco-resources/prettify.js"></script></head><body onload="window['PR_TAB_WIDTH']=4;prettyPrint()"><div class="breadcrumb" id="breadcrumb"><span class="info"><a href="../jacoco-sessions.html" class="el_session">Sessions</a></span><a href="../index.html" class="el_report">Tailormap API</a> &gt; <a href="index.source.html" class="el_package">org.tailormap.api.controller</a> &gt; <span class="el_source">AppRestControllerAdvice.java</span></div><h1>AppRestControllerAdvice.java</h1><pre class="source lang-java linenums">/*
 * Copyright (C) 2022 B3Partners B.V.
 *
 * SPDX-License-Identifier: MIT
 */
package org.tailormap.api.controller;

import jakarta.servlet.http.HttpServletRequest;
import org.springframework.beans.factory.annotation.Value;
import org.springframework.http.HttpStatus;
import org.springframework.http.MediaType;
import org.springframework.http.ResponseEntity;
import org.springframework.web.bind.WebDataBinder;
import org.springframework.web.bind.annotation.ExceptionHandler;
import org.springframework.web.bind.annotation.InitBinder;
import org.springframework.web.bind.annotation.ModelAttribute;
import org.springframework.web.bind.annotation.PathVariable;
import org.springframework.web.bind.annotation.RequestParam;
import org.springframework.web.bind.annotation.RestControllerAdvice;
import org.springframework.web.server.ResponseStatusException;
import org.tailormap.api.annotation.AppRestController;
import org.tailormap.api.persistence.Application;
import org.tailormap.api.persistence.GeoService;
import org.tailormap.api.persistence.helper.ApplicationHelper;
import org.tailormap.api.persistence.json.AppTreeLayerNode;
import org.tailormap.api.persistence.json.GeoServiceLayer;
import org.tailormap.api.repository.ApplicationRepository;
import org.tailormap.api.repository.GeoServiceRepository;
import org.tailormap.api.security.AuthorisationService;
import org.tailormap.api.viewer.model.ErrorResponse;
import org.tailormap.api.viewer.model.RedirectResponse;
import org.tailormap.api.viewer.model.ViewerResponse;

@RestControllerAdvice(annotations = AppRestController.class)
public class AppRestControllerAdvice {
  private final ApplicationRepository applicationRepository;
  private final GeoServiceRepository geoServiceRepository;
  private final ApplicationHelper applicationHelper;
  private final AuthorisationService authorisationService;

  @Value(&quot;${tailormap-api.base-path}&quot;)
  private String basePath;

  public AppRestControllerAdvice(
      ApplicationRepository applicationRepository,
      GeoServiceRepository geoServiceRepository,
      ApplicationHelper applicationHelper,
<span class="nc" id="L48">      AuthorisationService authorisationService) {</span>
<span class="nc" id="L49">    this.applicationRepository = applicationRepository;</span>
<span class="nc" id="L50">    this.geoServiceRepository = geoServiceRepository;</span>
<span class="nc" id="L51">    this.applicationHelper = applicationHelper;</span>
<span class="nc" id="L52">    this.authorisationService = authorisationService;</span>
<span class="nc" id="L53">  }</span>

  @InitBinder
  protected void initBinder(WebDataBinder binder) {
    // WARNING! These fields must NOT match properties of ModelAttribute classes, otherwise they
    // will be overwritten (for instance GeoServiceLayer.name might be set to the app name)
<span class="nc" id="L59">    binder.setAllowedFields(&quot;viewerName&quot;, &quot;appLayerId&quot;, &quot;base&quot;, &quot;projection&quot;);</span>
<span class="nc" id="L60">  }</span>

  @ExceptionHandler(ResponseStatusException.class)
  protected ResponseEntity&lt;?&gt; handleResponseStatusException(ResponseStatusException ex) {
<span class="nc bnc" id="L64" title="All 2 branches missed.">    if (HttpStatus.UNAUTHORIZED.equals(ex.getStatusCode())) {</span>
<span class="nc" id="L65">      return ResponseEntity.status(ex.getStatusCode())</span>
<span class="nc" id="L66">          .contentType(MediaType.APPLICATION_JSON)</span>
<span class="nc" id="L67">          .body(new RedirectResponse());</span>
    }
<span class="nc" id="L69">    return ResponseEntity.status(ex.getStatusCode())</span>
<span class="nc" id="L70">        .contentType(MediaType.APPLICATION_JSON)</span>
<span class="nc" id="L71">        .body(new ErrorResponse()</span>
<span class="nc" id="L72">            .message(</span>
<span class="nc bnc" id="L73" title="All 2 branches missed.">                ex.getReason() != null</span>
<span class="nc" id="L74">                    ? ex.getReason()</span>
<span class="nc" id="L75">                    : ex.getBody().getTitle())</span>
<span class="nc" id="L76">            .code(ex.getStatusCode().value()));</span>
  }

  @ModelAttribute
  public ViewerResponse.KindEnum populateViewerKind(HttpServletRequest request) {
<span class="nc bnc" id="L81" title="All 2 branches missed.">    if (request.getServletPath().startsWith(basePath + &quot;/app/&quot;)) {</span>
<span class="nc" id="L82">      return ViewerResponse.KindEnum.APP;</span>
<span class="nc bnc" id="L83" title="All 2 branches missed.">    } else if (request.getServletPath().startsWith(basePath + &quot;/service/&quot;)) {</span>
<span class="nc" id="L84">      return ViewerResponse.KindEnum.SERVICE;</span>
    } else {
<span class="nc" id="L86">      return null;</span>
    }
  }

  @ModelAttribute
  public Application populateApplication(
      @ModelAttribute ViewerResponse.KindEnum viewerKind,
      @PathVariable(required = false) String viewerName,
      @RequestParam(required = false) String base,
      @RequestParam(required = false) String projection) {
<span class="nc bnc" id="L96" title="All 4 branches missed.">    if (viewerKind == null || viewerName == null) {</span>
      // No binding required for ViewerController.defaultApp()
<span class="nc" id="L98">      return null;</span>
    }

    Application app;
<span class="nc bnc" id="L102" title="All 2 branches missed.">    if (viewerKind == ViewerResponse.KindEnum.APP) {</span>
<span class="nc" id="L103">      app = applicationRepository.findByName(viewerName);</span>
<span class="nc bnc" id="L104" title="All 2 branches missed.">      if (app == null) {</span>
<span class="nc" id="L105">        throw new ResponseStatusException(HttpStatus.NOT_FOUND);</span>
      }
<span class="nc bnc" id="L107" title="All 2 branches missed.">    } else if (viewerKind == ViewerResponse.KindEnum.SERVICE) {</span>
<span class="nc" id="L108">      GeoService service = geoServiceRepository.findById(viewerName).orElse(null);</span>

<span class="nc bnc" id="L110" title="All 2 branches missed.">      if (service == null) {</span>
<span class="nc" id="L111">        throw new ResponseStatusException(HttpStatus.NOT_FOUND);</span>
      }

<span class="nc bnc" id="L114" title="All 2 branches missed.">      if (!authorisationService.userAllowedToViewGeoService(service)) {</span>
<span class="nc" id="L115">        throw new ResponseStatusException(HttpStatus.UNAUTHORIZED);</span>
      }

      // TODO: skip this check for users with admin role
<span class="nc bnc" id="L119" title="All 2 branches missed.">      if (!service.isPublished()) {</span>
<span class="nc" id="L120">        throw new ResponseStatusException(HttpStatus.NOT_FOUND);</span>
      }
<span class="nc" id="L122">      app = applicationHelper.getServiceApplication(base, projection, service);</span>
<span class="nc" id="L123">    } else {</span>
<span class="nc" id="L124">      throw new ResponseStatusException(HttpStatus.BAD_REQUEST);</span>
    }

<span class="nc bnc" id="L127" title="All 2 branches missed.">    if (!this.authorisationService.userAllowedToViewApplication(app)) {</span>
<span class="nc" id="L128">      throw new ResponseStatusException(HttpStatus.UNAUTHORIZED);</span>
    }
<span class="nc" id="L130">    return app;</span>
  }

  @ModelAttribute
  public AppTreeLayerNode populateAppTreeLayerNode(
      @ModelAttribute Application app, @PathVariable(required = false) String appLayerId) {
<span class="nc bnc" id="L136" title="All 4 branches missed.">    if (app == null || appLayerId == null) {</span>
      // No binding
<span class="nc" id="L138">      return null;</span>
    }

<span class="nc" id="L141">    final AppTreeLayerNode layerNode = app.getAllAppTreeLayerNode()</span>
<span class="nc" id="L142">        .filter(r -&gt; r.getId().equals(appLayerId))</span>
<span class="nc" id="L143">        .findFirst()</span>
<span class="nc" id="L144">        .orElse(null);</span>
<span class="nc bnc" id="L145" title="All 2 branches missed.">    if (layerNode == null) {</span>
<span class="nc" id="L146">      throw new ResponseStatusException(</span>
          HttpStatus.NOT_FOUND, &quot;Application layer with id &quot; + appLayerId + &quot; not found&quot;);
    }

    // TODO
    //    if (!this.authorizationService.userAllowedToViewApplication(applicationLayer, application)) {
    //      throw new ResponseStatusException(HttpStatus.FORBIDDEN, &quot;Access denied&quot;);
    //    }
<span class="nc" id="L154">    return layerNode;</span>
  }

  @ModelAttribute
  public GeoService populateGeoService(
      @ModelAttribute Application app, @ModelAttribute AppTreeLayerNode appTreeLayerNode) {
<span class="nc bnc" id="L160" title="All 2 branches missed.">    if (appTreeLayerNode == null) {</span>
      // No binding
<span class="nc" id="L162">      return null;</span>
    }
<span class="nc bnc" id="L164" title="All 2 branches missed.">    if (appTreeLayerNode.getServiceId() == null) {</span>
<span class="nc" id="L165">      return null;</span>
    }
<span class="nc" id="L167">    GeoService service =</span>
<span class="nc" id="L168">        geoServiceRepository.findById(appTreeLayerNode.getServiceId()).orElse(null);</span>
<span class="nc bnc" id="L169" title="All 4 branches missed.">    if (service != null &amp;&amp; !authorisationService.userAllowedToViewGeoService(service)) {</span>
<span class="nc" id="L170">      throw new ResponseStatusException(HttpStatus.UNAUTHORIZED);</span>
    }

<span class="nc bnc" id="L173" title="All 4 branches missed.">    if (service != null &amp;&amp; authorisationService.mustDenyAccessForSecuredProxy(app, service)) {</span>
<span class="nc" id="L174">      throw new ResponseStatusException(HttpStatus.FORBIDDEN);</span>
    }

<span class="nc" id="L177">    return service;</span>
  }

  @ModelAttribute
  public GeoServiceLayer populateGeoServiceLayer(
      @ModelAttribute AppTreeLayerNode appTreeLayerNode, @ModelAttribute GeoService service) {
<span class="nc bnc" id="L183" title="All 2 branches missed.">    if (service == null) {</span>
      // No binding
<span class="nc" id="L185">      return null;</span>
    }
<span class="nc" id="L187">    GeoServiceLayer layer = service.getLayers().stream()</span>
<span class="nc" id="L188">        .filter(l -&gt; appTreeLayerNode.getLayerName().equals(l.getName()))</span>
<span class="nc" id="L189">        .findFirst()</span>
<span class="nc" id="L190">        .orElse(null);</span>

<span class="nc bnc" id="L192" title="All 4 branches missed.">    if (layer != null &amp;&amp; !authorisationService.userAllowedToViewGeoServiceLayer(service, layer)) {</span>
<span class="nc" id="L193">      throw new ResponseStatusException(HttpStatus.UNAUTHORIZED);</span>
    }

<span class="nc" id="L196">    return layer;</span>
  }
}
</pre><div class="footer"><span class="right">Created with <a href="http://www.jacoco.org/jacoco">JaCoCo</a> 0.8.13.202504020838</span></div></body></html>