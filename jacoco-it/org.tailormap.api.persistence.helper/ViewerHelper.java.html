<?xml version="1.0" encoding="UTF-8"?><!DOCTYPE html PUBLIC "-//W3C//DTD XHTML 1.0 Strict//EN" "http://www.w3.org/TR/xhtml1/DTD/xhtml1-strict.dtd"><html xmlns="http://www.w3.org/1999/xhtml" lang="en"><head><meta http-equiv="Content-Type" content="text/html;charset=UTF-8"/><link rel="stylesheet" href="../jacoco-resources/report.css" type="text/css"/><link rel="shortcut icon" href="../jacoco-resources/report.gif" type="image/gif"/><title>ViewerHelper.java</title><link rel="stylesheet" href="../jacoco-resources/prettify.css" type="text/css"/><script type="text/javascript" src="../jacoco-resources/prettify.js"></script></head><body onload="window['PR_TAB_WIDTH']=4;prettyPrint()"><div class="breadcrumb" id="breadcrumb"><span class="info"><a href="../jacoco-sessions.html" class="el_session">Sessions</a></span><a href="../index.html" class="el_report">Tailormap API</a> &gt; <a href="index.source.html" class="el_package">org.tailormap.api.persistence.helper</a> &gt; <span class="el_source">ViewerHelper.java</span></div><h1>ViewerHelper.java</h1><pre class="source lang-java linenums">/*
 * Copyright (C) 2025 B3Partners B.V.
 *
 * SPDX-License-Identifier: MIT
 */
package org.tailormap.api.persistence.helper;

import jakarta.validation.constraints.NotNull;
import jakarta.validation.constraints.Null;
import java.util.HashMap;
import java.util.List;
import java.util.Map;
import java.util.Objects;
import java.util.Optional;
import java.util.stream.Collectors;
import org.springframework.stereotype.Service;
import org.tailormap.api.persistence.Application;
import org.tailormap.api.persistence.GeoService;
import org.tailormap.api.persistence.TMFeatureSource;
import org.tailormap.api.persistence.TMFeatureType;
import org.tailormap.api.persistence.json.AppLayerSettings;
import org.tailormap.api.persistence.json.AppTreeLayerNode;
import org.tailormap.api.persistence.json.FeatureTypeRef;
import org.tailormap.api.persistence.json.GeoServiceLayer;
import org.tailormap.api.persistence.json.GeoServiceLayerSettings;
import org.tailormap.api.repository.FeatureSourceRepository;
import org.tailormap.api.repository.GeoServiceRepository;

@Service
public class ViewerHelper {
  private final GeoServiceRepository geoServiceRepository;
  private final FeatureSourceRepository featureSourceRepository;

<span class="fc" id="L34">  public ViewerHelper(GeoServiceRepository geoServiceRepository, FeatureSourceRepository featureSourceRepository) {</span>
<span class="fc" id="L35">    this.geoServiceRepository = geoServiceRepository;</span>
<span class="fc" id="L36">    this.featureSourceRepository = featureSourceRepository;</span>
<span class="fc" id="L37">  }</span>

<span class="nc" id="L39">  public record AppLayerContext(</span>
      @NotNull AppTreeLayerNode node,
      @NotNull AppLayerSettings appLayerSettings,
      @NotNull GeoService geoService,
      @NotNull GeoServiceLayer geoServiceLayer,
      @Null FeatureTypeRef featureTypeRef) {}

  /**
   * Returns a map of AppTreeLayerNode id to AppLayerContext, with only nodes that reference an existing
   * GeoServiceLayer, including base layer nodes.
   *
   * @param application the application
   * @return a map of appLayerId to AppLayerContext
   */
  public Map&lt;String, AppLayerContext&gt; getAppLayerContextMap(Application application) {
<span class="nc" id="L54">    return getAppLayerContextMap(application, null);</span>
  }

  /**
   * As #getAppLayerContextMap(), but only for the given appLayerIds.
   *
   * @param application the application
   * @param appLayerIds the list of appLayerIds to limit the result to
   * @return a map of appLayerId to AppLayerContext
   */
  public Map&lt;String, AppLayerContext&gt; getAppLayerContextMap(Application application, List&lt;String&gt; appLayerIds) {
<span class="nc" id="L65">    Map&lt;String, AppTreeLayerNode&gt; nodeMap = new HashMap&lt;&gt;();</span>
<span class="nc" id="L66">    application.getAllAppTreeLayerNode().forEach(node -&gt; {</span>
<span class="nc bnc" id="L67" title="All 4 branches missed.">      if (appLayerIds == null || appLayerIds.contains(node.getId())) {</span>
<span class="nc" id="L68">        nodeMap.put(node.getId(), node);</span>
      }
<span class="nc" id="L70">    });</span>

    // Efficiently retrieve all GeoServices in a single query
<span class="nc" id="L73">    Map&lt;String, GeoService&gt; geoServiceMap =</span>
        geoServiceRepository
<span class="nc" id="L75">            .findByIds(nodeMap.values().stream()</span>
<span class="nc" id="L76">                .map(AppTreeLayerNode::getServiceId)</span>
<span class="nc" id="L77">                .distinct()</span>
<span class="nc" id="L78">                .toList())</span>
<span class="nc" id="L79">            .stream()</span>
<span class="nc" id="L80">            .collect(Collectors.toMap(GeoService::getId, service -&gt; service));</span>

<span class="nc" id="L82">    Map&lt;String, AppLayerContext&gt; contextMap = new HashMap&lt;&gt;();</span>
<span class="nc bnc" id="L83" title="All 2 branches missed.">    for (Map.Entry&lt;String, AppTreeLayerNode&gt; entry : nodeMap.entrySet()) {</span>
<span class="nc" id="L84">      String appLayerId = entry.getKey();</span>
<span class="nc" id="L85">      AppTreeLayerNode lyrNode = entry.getValue();</span>

<span class="nc" id="L87">      GeoService service = geoServiceMap.get(lyrNode.getServiceId());</span>
<span class="nc bnc" id="L88" title="All 2 branches missed.">      if (service == null) {</span>
<span class="nc" id="L89">        continue;</span>
      }

<span class="nc" id="L92">      GeoServiceLayer layer = service.getLayers().stream()</span>
<span class="nc" id="L93">          .filter(l -&gt; Objects.equals(l.getName(), lyrNode.getLayerName()))</span>
<span class="nc" id="L94">          .findFirst()</span>
<span class="nc" id="L95">          .orElse(null);</span>
<span class="nc bnc" id="L96" title="All 2 branches missed.">      if (layer == null) {</span>
<span class="nc" id="L97">        continue;</span>
      }

<span class="nc" id="L100">      GeoServiceLayerSettings lyrSettings = service.getLayerSettings(lyrNode.getLayerName());</span>
<span class="nc bnc" id="L101" title="All 2 branches missed.">      if (lyrSettings == null) {</span>
<span class="nc" id="L102">        continue;</span>
      }
<span class="nc" id="L104">      FeatureTypeRef ftr = lyrSettings.getFeatureType();</span>
<span class="nc bnc" id="L105" title="All 2 branches missed.">      if (ftr == null) {</span>
<span class="nc" id="L106">        continue;</span>
      }
<span class="nc" id="L108">      contextMap.put(</span>
          appLayerId,
<span class="nc" id="L110">          new AppLayerContext(lyrNode, application.getAppLayerSettings(appLayerId), service, layer, ftr));</span>
<span class="nc" id="L111">    }</span>
<span class="nc" id="L112">    return contextMap;</span>
  }

<span class="nc" id="L115">  public record AppLayerFullContext(</span>
      @NotNull AppTreeLayerNode node,
      @NotNull AppLayerSettings appLayerSettings,
      @NotNull GeoService geoService,
      @NotNull GeoServiceLayer geoServiceLayer,
      @NotNull TMFeatureType featureType) {}

  /**
   * As #getAppLayerContextMap(), but only with nodes that reference an existing GeoServiceLayer that has a feature
   * type.
   *
   * @param application the application
   * @return a map of appLayerId to AppLayerFullContext
   */
  public Map&lt;String, AppLayerFullContext&gt; getAppLayerFullContextMap(Application application) {
<span class="nc" id="L130">    return getAppLayerFullContextMap(application, null);</span>
  }

  /**
   * As #getAppLayerFullContextMap(), but only for the given appLayerIds.
   *
   * @param application the application
   * @param appLayerIds the list of appLayerIds to limit the result to
   * @return a map of appLayerId to AppLayerFullContext
   */
  public Map&lt;String, AppLayerFullContext&gt; getAppLayerFullContextMap(
      Application application, List&lt;String&gt; appLayerIds) {
<span class="nc" id="L142">    Map&lt;String, AppLayerContext&gt; contextMap = getAppLayerContextMap(application, appLayerIds);</span>

    // Efficiently retrieve all TMFeatureSources in a single query
<span class="nc" id="L145">    Map&lt;Long, TMFeatureSource&gt; featureSourceMap = featureSourceRepository</span>
<span class="nc" id="L146">        .findByIds(contextMap.values().stream()</span>
<span class="nc" id="L147">            .map(appLayerFeatureTypeRef -&gt;</span>
<span class="nc" id="L148">                appLayerFeatureTypeRef.featureTypeRef().getFeatureSourceId())</span>
<span class="nc" id="L149">            .filter(Objects::nonNull)</span>
<span class="nc" id="L150">            .distinct()</span>
<span class="nc" id="L151">            .toList())</span>
<span class="nc" id="L152">        .stream()</span>
<span class="nc" id="L153">        .collect(Collectors.toMap(TMFeatureSource::getId, featureSource -&gt; featureSource));</span>

<span class="nc" id="L155">    Map&lt;String, AppLayerFullContext&gt; fullContextMap = new HashMap&lt;&gt;();</span>
<span class="nc bnc" id="L156" title="All 2 branches missed.">    for (Map.Entry&lt;String, AppLayerContext&gt; entry : contextMap.entrySet()) {</span>
<span class="nc" id="L157">      String appLayerId = entry.getKey();</span>
<span class="nc" id="L158">      AppLayerContext context = entry.getValue();</span>

<span class="nc" id="L160">      Optional.ofNullable(featureSourceMap.get(context.featureTypeRef().getFeatureSourceId()))</span>
<span class="nc" id="L161">          .map(featureSource -&gt; featureSource.findFeatureTypeByName(</span>
<span class="nc" id="L162">              context.featureTypeRef().getFeatureTypeName()))</span>
<span class="nc" id="L163">          .ifPresent(featureType -&gt; fullContextMap.put(</span>
              appLayerId,
              new AppLayerFullContext(
<span class="nc" id="L166">                  context.node(),</span>
<span class="nc" id="L167">                  context.appLayerSettings(),</span>
<span class="nc" id="L168">                  context.geoService(),</span>
<span class="nc" id="L169">                  context.geoServiceLayer(),</span>
                  featureType)));
<span class="nc" id="L171">    }</span>

<span class="nc" id="L173">    return fullContextMap;</span>
  }
}
</pre><div class="footer"><span class="right">Created with <a href="http://www.jacoco.org/jacoco">JaCoCo</a> 0.8.14.202510111229</span></div></body></html>