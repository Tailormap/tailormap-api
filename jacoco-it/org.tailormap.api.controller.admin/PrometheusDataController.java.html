<?xml version="1.0" encoding="UTF-8"?><!DOCTYPE html PUBLIC "-//W3C//DTD XHTML 1.0 Strict//EN" "http://www.w3.org/TR/xhtml1/DTD/xhtml1-strict.dtd"><html xmlns="http://www.w3.org/1999/xhtml" lang="en"><head><meta http-equiv="Content-Type" content="text/html;charset=UTF-8"/><link rel="stylesheet" href="../jacoco-resources/report.css" type="text/css"/><link rel="shortcut icon" href="../jacoco-resources/report.gif" type="image/gif"/><title>PrometheusDataController.java</title><link rel="stylesheet" href="../jacoco-resources/prettify.css" type="text/css"/><script type="text/javascript" src="../jacoco-resources/prettify.js"></script></head><body onload="window['PR_TAB_WIDTH']=4;prettyPrint()"><div class="breadcrumb" id="breadcrumb"><span class="info"><a href="../jacoco-sessions.html" class="el_session">Sessions</a></span><a href="../index.html" class="el_report">Tailormap API</a> &gt; <a href="index.source.html" class="el_package">org.tailormap.api.controller.admin</a> &gt; <span class="el_source">PrometheusDataController.java</span></div><h1>PrometheusDataController.java</h1><pre class="source lang-java linenums">/*
 * Copyright (C) 2025 B3Partners B.V.
 *
 * SPDX-License-Identifier: MIT
 */
package org.tailormap.api.controller.admin;

import com.fasterxml.jackson.databind.JsonNode;
import com.fasterxml.jackson.databind.ObjectMapper;
import io.swagger.v3.oas.annotations.Operation;
import io.swagger.v3.oas.annotations.media.Content;
import io.swagger.v3.oas.annotations.media.Schema;
import io.swagger.v3.oas.annotations.responses.ApiResponse;
import java.io.IOException;
import java.lang.invoke.MethodHandles;
import java.util.Collection;
import java.util.Map;
import java.util.UUID;
import org.slf4j.Logger;
import org.slf4j.LoggerFactory;
import org.springframework.beans.factory.InitializingBean;
import org.springframework.beans.factory.annotation.Value;
import org.springframework.http.HttpStatus;
import org.springframework.http.MediaType;
import org.springframework.http.ResponseEntity;
import org.springframework.web.bind.annotation.ExceptionHandler;
import org.springframework.web.bind.annotation.GetMapping;
import org.springframework.web.bind.annotation.PathVariable;
import org.springframework.web.bind.annotation.RequestParam;
import org.springframework.web.bind.annotation.RestController;
import org.springframework.web.server.ResponseStatusException;
import org.tailormap.api.prometheus.PrometheusResultProcessor;
import org.tailormap.api.prometheus.PrometheusService;
import org.tailormap.api.prometheus.TagNames;
import org.tailormap.api.repository.ApplicationRepository;
import org.tailormap.api.scheduling.PrometheusPingTask;
import org.tailormap.api.scheduling.TMJobDataMap;
import org.tailormap.api.scheduling.Task;
import org.tailormap.api.scheduling.TaskManagerService;
import org.tailormap.api.scheduling.TaskType;
import org.tailormap.api.viewer.model.ErrorResponse;

@RestController
public class PrometheusDataController implements TagNames, InitializingBean {
<span class="nc" id="L45">  private static final Logger logger =</span>
<span class="nc" id="L46">      LoggerFactory.getLogger(MethodHandles.lookup().lookupClass());</span>
  private final PrometheusService prometheusService;
  private final PrometheusResultProcessor prometheusResultProcessor;
  private final ApplicationRepository applicationRepository;
  private final TaskManagerService taskManagerService;

  @Value(&quot;${tailormap-api.prometheus-api-appmetrics-totals}&quot;)
  private String totalsQuery;

  @Value(&quot;${tailormap-api.prometheus-api-appmetrics-updated}&quot;)
  private String counterLastUpdatedQuery;

  @Value(&quot;${tailormap-api.prometheus-api-appmetrics-layer-switched-on}&quot;)
  private String appLayersSwitchedOnTotalsQuery;

  @Value(&quot;${tailormap-api.prometheus-api-appmetrics-layer-switched-on-updated}&quot;)
  private String appLayersSwitchedOnLastUpdatedQuery;

  @Value(&quot;${tailormap-api.prometheus-api-ping-cron:0 0/5 * 1/1 * ? *}&quot;)
  private String prometheusPingCron;

  public PrometheusDataController(
      PrometheusService prometheusService,
      PrometheusResultProcessor prometheusResultProcessor,
      ApplicationRepository applicationRepository,
<span class="nc" id="L71">      TaskManagerService taskManagerService) {</span>
<span class="nc" id="L72">    this.prometheusService = prometheusService;</span>
<span class="nc" id="L73">    this.prometheusResultProcessor = prometheusResultProcessor;</span>
<span class="nc" id="L74">    this.applicationRepository = applicationRepository;</span>
<span class="nc" id="L75">    this.taskManagerService = taskManagerService;</span>
<span class="nc" id="L76">  }</span>

  @Override
  public void afterPropertiesSet() throws Exception {
<span class="nc bnc" id="L80" title="All 2 branches missed.">    if (prometheusService.isPrometheusAvailable()) {</span>
<span class="nc" id="L81">      logger.info(&quot;Prometheus is available, initializing PrometheusDataController.&quot;);</span>
      try {
        // there should be only one Prometheus ping task, so we delete any existing ones
<span class="nc" id="L84">        taskManagerService.deleteTasksByGroupName(TaskType.PROMETHEUS_PING.getValue());</span>
<span class="nc" id="L85">        final UUID taskUuid = taskManagerService.createTask(</span>
            PrometheusPingTask.class,
<span class="nc" id="L87">            new TMJobDataMap(Map.of(</span>
                Task.TYPE_KEY,
<span class="nc" id="L89">                TaskType.PROMETHEUS_PING.getValue(),</span>
                Task.DESCRIPTION_KEY,
                &quot;Ping Prometheus service for availability.&quot;,
                Task.PRIORITY_KEY,
<span class="nc" id="L93">                57)),</span>
            prometheusPingCron);
<span class="nc" id="L95">        logger.debug(&quot;Added Prometheus ping task with UUID: {}&quot;, taskUuid);</span>
<span class="nc" id="L96">      } catch (Exception e) {</span>
<span class="nc" id="L97">        logger.error(&quot;Error initializing Prometheus ping task&quot;, e);</span>
<span class="nc" id="L98">      }</span>
    } else {
<span class="nc" id="L100">      logger.info(&quot;Prometheus is not available, /graph/ endpoint will not be functional.&quot;);</span>
    }
<span class="nc" id="L102">  }</span>

  @ExceptionHandler({ResponseStatusException.class})
  public ResponseEntity&lt;?&gt; handleException(ResponseStatusException ex) {
<span class="nc" id="L106">    return ResponseEntity.status(ex.getStatusCode())</span>
<span class="nc" id="L107">        .contentType(MediaType.APPLICATION_JSON)</span>
<span class="nc" id="L108">        .body(new ErrorResponse()</span>
<span class="nc" id="L109">            .message(</span>
<span class="nc bnc" id="L110" title="All 2 branches missed.">                ex.getReason() != null</span>
<span class="nc" id="L111">                    ? ex.getReason()</span>
<span class="nc" id="L112">                    : ex.getBody().getTitle())</span>
<span class="nc" id="L113">            .code(ex.getStatusCode().value()));</span>
  }

  @Operation(
      summary = &quot;retrieve application graph data&quot;,
      description = &quot;Fetches the totals and last updated time for application metrics from Prometheus.&quot;)
  @GetMapping(
      path = &quot;${tailormap-api.admin.base-path}/graph/applications&quot;,
      produces = MediaType.APPLICATION_JSON_VALUE)
  @ApiResponse(
      responseCode = &quot;200&quot;,
      description = &quot;Array of application metrics with totals and last updated times.&quot;,
      content =
          @Content(
              mediaType = MediaType.APPLICATION_JSON_VALUE,
              schema =
                  @Schema(
                      example =
                          &quot;&quot;&quot;
{&quot;applications&quot;:[
{&quot;lastUpdateSecondsAgo&quot;:&quot;85746&quot;,&quot;appName&quot;:&quot;default&quot;,&quot;appId&quot;:&quot;1&quot;,&quot;totalCount&quot;:&quot;4003&quot;},
{&quot;lastUpdateSecondsAgo&quot;:&quot;1345&quot;,&quot;appName&quot;:&quot;test&quot;,&quot;appId&quot;:&quot;5&quot;,&quot;totalCount&quot;:&quot;5&quot;}
]}
&quot;&quot;&quot;)))
  public ResponseEntity&lt;?&gt; getApplicationGraphicData(@RequestParam(defaultValue = &quot;30&quot;) int numberOfDays) {
<span class="nc bnc" id="L138" title="All 2 branches missed.">    if (numberOfDays &lt; 1) {</span>
<span class="nc" id="L139">      throw new ResponseStatusException(HttpStatus.BAD_REQUEST, &quot;Invalid number of days provided.&quot;);</span>
    }
<span class="nc bnc" id="L141" title="All 2 branches missed.">    if (!prometheusService.isPrometheusAvailable()) {</span>
<span class="nc" id="L142">      throw new ResponseStatusException(HttpStatus.SERVICE_UNAVAILABLE, &quot;Prometheus is not available.&quot;);</span>
    }
    // we need to (at least) relabel the &quot;__name__&quot; query result type to avoid conflicts and omissions in the
    // flattened results
<span class="nc" id="L146">    final String completeQuery =</span>
<span class="nc" id="L147">        &quot;label_replace(&quot; + totalsQuery.replace(NUMBER_OF_DAYS_REPLACE_TOKEN, String.valueOf(numberOfDays))</span>
            + &quot;, \&quot;type\&quot;, \&quot;totalCount\&quot;, \&quot;__name__\&quot;, \&quot;.*\&quot;)&quot;
            + &quot; or &quot; + &quot;label_replace(&quot;
<span class="nc" id="L150">            + counterLastUpdatedQuery.replace(NUMBER_OF_DAYS_REPLACE_TOKEN, String.valueOf(numberOfDays))</span>
            + &quot;, \&quot;type\&quot;, \&quot;lastUpdateSecondsAgo\&quot;, \&quot;__name__\&quot;, \&quot;.*\&quot;)&quot;;
<span class="nc" id="L152">    logger.trace(&quot;Fetching application graph data using query {}.&quot;, completeQuery);</span>
    try {
<span class="nc" id="L154">      JsonNode totals = prometheusService.executeQuery(completeQuery);</span>
<span class="nc" id="L155">      logger.trace(&quot;Application graph data fetched successfully. {}&quot;, totals.toPrettyString());</span>
<span class="nc" id="L156">      Collection&lt;Map&lt;String, String&gt;&gt; applications =</span>
<span class="nc" id="L157">          prometheusResultProcessor.processPrometheusResultsForApplications(totals);</span>
<span class="nc" id="L158">      return ResponseEntity.ok(new ObjectMapper()</span>
<span class="nc" id="L159">          .createObjectNode()</span>
<span class="nc" id="L160">          .set(&quot;applications&quot;, new ObjectMapper().valueToTree(applications)));</span>
<span class="nc" id="L161">    } catch (IOException e) {</span>
<span class="nc" id="L162">      logger.error(&quot;Error fetching application graph data&quot;, e);</span>
<span class="nc" id="L163">      throw new ResponseStatusException(HttpStatus.INTERNAL_SERVER_ERROR, e.getMessage());</span>
    }
  }

  @Operation(
      summary = &quot;retrieve application layers graph data&quot;,
      description = &quot;Fetches the totals and last updated time for application layer metrics from Prometheus.&quot;)
  @GetMapping(
      path = &quot;${tailormap-api.admin.base-path}/graph/applayers/{applicationId}&quot;,
      produces = MediaType.APPLICATION_JSON_VALUE)
  @ApiResponse(
      responseCode = &quot;200&quot;,
      description = &quot;Array of application layer metrics with totals and last updated times.&quot;,
      content =
          @Content(
              mediaType = MediaType.APPLICATION_JSON_VALUE,
              schema =
                  @Schema(
                      example =
                          &quot;&quot;&quot;
{&quot;applicationLayers&quot;:[
{&quot;lastUpdateSecondsAgo&quot;:&quot;3748&quot;,&quot;appLayerName&quot;:&quot;osm&quot;,&quot;appName&quot;:&quot;default&quot;,&quot;appId&quot;:&quot;1&quot;,&quot;appLayerId&quot;:&quot;lyr:openbasiskaart:osm&quot;,&quot;totalCount&quot;:&quot;1973&quot;,&quot;appLayerTitle&quot;:&quot;Openbasiskaart&quot;},
{&quot;lastUpdateSecondsAgo&quot;:&quot;3748&quot;,&quot;appLayerName&quot;:&quot;postgis:bak&quot;,&quot;appName&quot;:&quot;default&quot;,&quot;appId&quot;:&quot;1&quot;,&quot;appLayerId&quot;:&quot;lyr:snapshot-geoserver:postgis:bak&quot;,&quot;totalCount&quot;:&quot;2361&quot;,&quot;appLayerTitle&quot;:null},
{&quot;lastUpdateSecondsAgo&quot;:&quot;3748&quot;,&quot;appLayerName&quot;:&quot;postgis:begroeidterreindeel&quot;,&quot;appName&quot;:&quot;default&quot;,&quot;appId&quot;:&quot;1&quot;,&quot;appLayerId&quot;:&quot;lyr:snapshot-geoserver:postgis:begroeidterreindeel&quot;,&quot;totalCount&quot;:&quot;2323&quot;,&quot;appLayerTitle&quot;:null},
{&quot;lastUpdateSecondsAgo&quot;:&quot;3748&quot;,&quot;appLayerName&quot;:&quot;postgis:kadastraal_perceel&quot;,&quot;appName&quot;:&quot;default&quot;,&quot;appId&quot;:&quot;1&quot;,&quot;appLayerId&quot;:&quot;lyr:snapshot-geoserver:postgis:kadastraal_perceel&quot;,&quot;totalCount&quot;:&quot;1824&quot;,&quot;appLayerTitle&quot;:null}
]}
&quot;&quot;&quot;)))
  public ResponseEntity&lt;?&gt; getApplicationLayersGraphicData(
      @PathVariable Long applicationId, @RequestParam(defaultValue = &quot;30&quot;) int numberOfDays) {
<span class="nc bnc" id="L192" title="All 6 branches missed.">    if (applicationId == null || applicationId &lt;= 0 || numberOfDays &lt; 1) {</span>
<span class="nc" id="L193">      throw new ResponseStatusException(</span>
          HttpStatus.BAD_REQUEST, &quot;Invalid application id or number of days provided.&quot;);
      // not a problem to have an applicationId that does not exist, as the Prometheus query will
      // return an empty result set
    }
<span class="nc bnc" id="L198" title="All 2 branches missed.">    if (!prometheusService.isPrometheusAvailable()) {</span>
<span class="nc" id="L199">      throw new ResponseStatusException(HttpStatus.SERVICE_UNAVAILABLE, &quot;Prometheus is not available.&quot;);</span>
    }
    // relabel the &quot;__name__&quot; query result type to avoid conflicts and omissions in the flattened results and
    // replace the APP_ID_REPLACE_TOKEN with the actual applicationId and NUMBER_OF_DAYS_REPLACE_TOKEN
    // with the actual numberOfDays
<span class="nc" id="L204">    String completeQuery = &quot;label_replace(&quot;</span>
        + appLayersSwitchedOnTotalsQuery
<span class="nc" id="L206">            .replace(APP_ID_REPLACE_TOKEN, applicationId.toString())</span>
<span class="nc" id="L207">            .replace(NUMBER_OF_DAYS_REPLACE_TOKEN, String.valueOf(numberOfDays))</span>
        + &quot;, \&quot;type\&quot;, \&quot;totalCount\&quot;, \&quot;__name__\&quot;, \&quot;.*\&quot;)&quot;
        + &quot; or &quot;
        + &quot;label_replace(&quot;
        + appLayersSwitchedOnLastUpdatedQuery
<span class="nc" id="L212">            .replace(APP_ID_REPLACE_TOKEN, applicationId.toString())</span>
<span class="nc" id="L213">            .replace(NUMBER_OF_DAYS_REPLACE_TOKEN, String.valueOf(numberOfDays))</span>
        + &quot;, \&quot;type\&quot;, \&quot;lastUpdateSecondsAgo\&quot;, \&quot;__name__\&quot;, \&quot;.*\&quot;)&quot;;
<span class="nc" id="L215">    logger.trace(</span>
        &quot;Fetching application layers graph data for applicationId: {} with query: {}&quot;,
        applicationId,
        completeQuery);
    try {
<span class="nc" id="L220">      JsonNode results = prometheusService.executeQuery(completeQuery);</span>
<span class="nc" id="L221">      logger.trace(&quot;Application layers graph data fetched successfully. {}&quot;, results.toPrettyString());</span>
<span class="nc" id="L222">      Collection&lt;Map&lt;String, String&gt;&gt; data =</span>
<span class="nc" id="L223">          prometheusResultProcessor.processPrometheusResultsForApplicationLayers(results);</span>
<span class="nc bnc" id="L224" title="All 2 branches missed.">      if (!data.isEmpty()) {</span>
        // enrich data with additional information (appLayerName and/or appLayerTitle)
<span class="nc" id="L226">        applicationRepository</span>
<span class="nc" id="L227">            .findById(applicationId)</span>
<span class="nc" id="L228">            .ifPresent(application -&gt; data.forEach(metric -&gt; {</span>
<span class="nc" id="L229">              String appLayerId = metric.get(METRICS_APP_LAYER_ID_TAG);</span>
<span class="nc bnc" id="L230" title="All 4 branches missed.">              if (appLayerId != null &amp;&amp; !appLayerId.isEmpty()) {</span>
<span class="nc" id="L231">                application</span>
<span class="nc" id="L232">                    .getAllAppTreeLayerNode()</span>
<span class="nc" id="L233">                    .filter(node -&gt; appLayerId.equals(node.getId()))</span>
<span class="nc" id="L234">                    .findFirst()</span>
<span class="nc" id="L235">                    .ifPresent(node -&gt; {</span>
<span class="nc" id="L236">                      metric.put(METRICS_APP_LAYER_NAME_TAG, node.getLayerName());</span>
<span class="nc" id="L237">                      metric.put(</span>
                          METRICS_APP_LAYER_TITLE_TAG,
                          application
<span class="nc" id="L240">                              .getAppLayerSettings(node)</span>
<span class="nc" id="L241">                              .getTitle());</span>
<span class="nc" id="L242">                    });</span>
              }
<span class="nc" id="L244">            }));</span>
      }

<span class="nc" id="L247">      return ResponseEntity.ok(new ObjectMapper()</span>
<span class="nc" id="L248">          .createObjectNode()</span>
<span class="nc" id="L249">          .set(&quot;applicationLayers&quot;, new ObjectMapper().valueToTree(data)));</span>
<span class="nc" id="L250">    } catch (IOException e) {</span>
<span class="nc" id="L251">      logger.error(&quot;Error fetching application layers graph data&quot;, e);</span>
<span class="nc" id="L252">      throw new ResponseStatusException(HttpStatus.INTERNAL_SERVER_ERROR, e.getMessage());</span>
    }
  }
}
</pre><div class="footer"><span class="right">Created with <a href="http://www.jacoco.org/jacoco">JaCoCo</a> 0.8.13.202504020838</span></div></body></html>