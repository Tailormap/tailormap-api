<?xml version="1.0" encoding="UTF-8"?><!DOCTYPE html PUBLIC "-//W3C//DTD XHTML 1.0 Strict//EN" "http://www.w3.org/TR/xhtml1/DTD/xhtml1-strict.dtd"><html xmlns="http://www.w3.org/1999/xhtml" lang=""><head><meta http-equiv="Content-Type" content="text/html;charset=UTF-8"/><link rel="stylesheet" href="../jacoco-resources/report.css" type="text/css"/><link rel="shortcut icon" href="../jacoco-resources/report.gif" type="image/gif"/><title>TMFeatureSource.java</title><link rel="stylesheet" href="../jacoco-resources/prettify.css" type="text/css"/><script type="text/javascript" src="../jacoco-resources/prettify.js"></script></head><body onload="window['PR_TAB_WIDTH']=4;prettyPrint()"><div class="breadcrumb" id="breadcrumb"><span class="info"><a href="../jacoco-sessions.html" class="el_session">Sessions</a></span><a href="../index.html" class="el_report">Aggregate Test Coverage</a> &gt; <a href="index.source.html" class="el_package">org.tailormap.api.persistence</a> &gt; <span class="el_source">TMFeatureSource.java</span></div><h1>TMFeatureSource.java</h1><pre class="source lang-java linenums">/*
 * Copyright (C) 2023 B3Partners B.V.
 *
 * SPDX-License-Identifier: MIT
 */
package org.tailormap.api.persistence;

import com.fasterxml.jackson.core.JsonProcessingException;
import com.fasterxml.jackson.databind.ObjectMapper;
import jakarta.persistence.Basic;
import jakarta.persistence.CascadeType;
import jakarta.persistence.Column;
import jakarta.persistence.Entity;
import jakarta.persistence.EntityListeners;
import jakarta.persistence.EnumType;
import jakarta.persistence.Enumerated;
import jakarta.persistence.GeneratedValue;
import jakarta.persistence.GenerationType;
import jakarta.persistence.Id;
import jakarta.persistence.JoinColumn;
import jakarta.persistence.JoinTable;
import jakarta.persistence.ManyToOne;
import jakarta.persistence.OneToMany;
import jakarta.persistence.OrderBy;
import jakarta.persistence.Table;
import jakarta.persistence.Transient;
import jakarta.persistence.Version;
import jakarta.validation.constraints.NotNull;
import java.util.ArrayList;
import java.util.List;
import org.hibernate.annotations.JdbcTypeCode;
import org.hibernate.envers.Audited;
import org.hibernate.type.SqlTypes;
import org.springframework.data.jpa.domain.support.AuditingEntityListener;
import org.tailormap.api.persistence.json.JDBCConnectionProperties;
import org.tailormap.api.persistence.json.ServiceAuthentication;
import org.tailormap.api.persistence.json.TMServiceCaps;
import org.tailormap.api.persistence.listener.EntityEventPublisher;

@Audited
@Entity
@Table(name = &quot;feature_source&quot;)
@EntityListeners({EntityEventPublisher.class, AuditingEntityListener.class})
<span class="nc" id="L44">public class TMFeatureSource extends AuditMetadata {</span>

<span class="nc" id="L46">  public enum Protocol {</span>
<span class="nc" id="L47">    WFS(&quot;wfs&quot;),</span>

<span class="nc" id="L49">    JDBC(&quot;jdbc&quot;);</span>

    private final String value;

<span class="nc" id="L53">    Protocol(String value) {</span>
<span class="nc" id="L54">      this.value = value;</span>
<span class="nc" id="L55">    }</span>

    public String getValue() {
<span class="nc" id="L58">      return value;</span>
    }

    @Override
    public String toString() {
<span class="nc" id="L63">      return String.valueOf(value);</span>
    }

    public static TMFeatureSource.Protocol fromValue(String value) {
<span class="nc bnc" id="L67" title="All 2 branches missed.">      for (TMFeatureSource.Protocol p : TMFeatureSource.Protocol.values()) {</span>
<span class="nc bnc" id="L68" title="All 2 branches missed.">        if (p.value.equals(value)) {</span>
<span class="nc" id="L69">          return p;</span>
        }
      }
<span class="nc" id="L72">      throw new IllegalArgumentException(&quot;Unexpected value '&quot; + value + &quot;'&quot;);</span>
    }
  }

  @Id
  @GeneratedValue(strategy = GenerationType.IDENTITY)
  private Long id;

  @Version
  private Long version;

  @Transient
  private boolean refreshCapabilities;

  @Column(columnDefinition = &quot;text&quot;)
  private String notes;

  @NotNull @Enumerated(EnumType.STRING)
  private TMFeatureSource.Protocol protocol;

  @Basic
  private String title;

  @Column(length = 2048)
  private String url;

  @JdbcTypeCode(SqlTypes.JSON)
  @Column(columnDefinition = &quot;jsonb&quot;)
  private JDBCConnectionProperties jdbcConnection;

  @JdbcTypeCode(SqlTypes.JSON)
  @Column(columnDefinition = &quot;jsonb&quot;)
  private ServiceAuthentication authentication;

  @ManyToOne
  @JoinColumn(name = &quot;linked_service&quot;)
  private GeoService linkedService;

  @JdbcTypeCode(SqlTypes.JSON)
  @Column(columnDefinition = &quot;jsonb&quot;)
  private TMServiceCaps serviceCapabilities;

<span class="nc" id="L114">  @OneToMany(cascade = CascadeType.ALL, orphanRemoval = true)</span>
  @JoinTable(
      name = &quot;feature_source_feature_types&quot;,
      inverseJoinColumns = @JoinColumn(name = &quot;feature_type&quot;),
      joinColumns = @JoinColumn(name = &quot;feature_source&quot;, referencedColumnName = &quot;id&quot;))
  @OrderBy(&quot;name asc&quot;)
  private List&lt;TMFeatureType&gt; featureTypes = new ArrayList&lt;&gt;();

  @Override
  public String toString() {
    try {
<span class="nc" id="L125">      return &quot;TMFeatureSource{&quot;</span>
          + &quot;id=&quot;
          + id
          + &quot;, protocol=&quot;
          + protocol
          + &quot;, title='&quot;
          + title
          + '\''
          + &quot;, url='&quot;
          + url
          + '\''
          + &quot;, jdbcConnection=&quot;
<span class="nc" id="L137">          + new ObjectMapper().writeValueAsString(jdbcConnection)</span>
          + '}';
<span class="nc" id="L139">    } catch (JsonProcessingException e) {</span>
<span class="nc" id="L140">      throw new RuntimeException(e);</span>
    }
  }

  // &lt;editor-fold desc=&quot;getters and setters&quot;&gt;
  public Long getId() {
<span class="nc" id="L146">    return id;</span>
  }

  public TMFeatureSource setId(Long id) {
<span class="nc" id="L150">    this.id = id;</span>
<span class="nc" id="L151">    return this;</span>
  }

  public Long getVersion() {
<span class="nc" id="L155">    return version;</span>
  }

  public TMFeatureSource setVersion(Long version) {
<span class="nc" id="L159">    this.version = version;</span>
<span class="nc" id="L160">    return this;</span>
  }

  public boolean isRefreshCapabilities() {
<span class="nc" id="L164">    return refreshCapabilities;</span>
  }

  public void setRefreshCapabilities(boolean refreshCapabilities) {
<span class="nc" id="L168">    this.refreshCapabilities = refreshCapabilities;</span>
<span class="nc" id="L169">  }</span>

  public String getNotes() {
<span class="nc" id="L172">    return notes;</span>
  }

  public TMFeatureSource setNotes(String notes) {
<span class="nc" id="L176">    this.notes = notes;</span>
<span class="nc" id="L177">    return this;</span>
  }

  public Protocol getProtocol() {
<span class="nc" id="L181">    return protocol;</span>
  }

  public TMFeatureSource setProtocol(Protocol protocol) {
<span class="nc" id="L185">    this.protocol = protocol;</span>
<span class="nc" id="L186">    return this;</span>
  }

  public String getTitle() {
<span class="nc" id="L190">    return title;</span>
  }

  public TMFeatureSource setTitle(String title) {
<span class="nc" id="L194">    this.title = title;</span>
<span class="nc" id="L195">    return this;</span>
  }

  public String getUrl() {
<span class="nc" id="L199">    return url;</span>
  }

  public TMFeatureSource setUrl(String url) {
<span class="nc" id="L203">    this.url = url;</span>
<span class="nc" id="L204">    return this;</span>
  }

  public JDBCConnectionProperties getJdbcConnection() {
<span class="nc" id="L208">    return jdbcConnection;</span>
  }

  public TMFeatureSource setJdbcConnection(JDBCConnectionProperties jdbcConnection) {
<span class="nc" id="L212">    this.jdbcConnection = jdbcConnection;</span>
<span class="nc" id="L213">    return this;</span>
  }

  public ServiceAuthentication getAuthentication() {
<span class="nc" id="L217">    return authentication;</span>
  }

  public TMFeatureSource setAuthentication(ServiceAuthentication authentication) {
<span class="nc" id="L221">    this.authentication = authentication;</span>
<span class="nc" id="L222">    return this;</span>
  }

  public GeoService getLinkedService() {
<span class="nc" id="L226">    return linkedService;</span>
  }

  public TMFeatureSource setLinkedService(GeoService linkedService) {
<span class="nc" id="L230">    this.linkedService = linkedService;</span>
<span class="nc" id="L231">    return this;</span>
  }

  public TMServiceCaps getServiceCapabilities() {
<span class="nc" id="L235">    return serviceCapabilities;</span>
  }

  public TMFeatureSource setServiceCapabilities(TMServiceCaps serviceCapabilities) {
<span class="nc" id="L239">    this.serviceCapabilities = serviceCapabilities;</span>
<span class="nc" id="L240">    return this;</span>
  }

  // Added this extra getter to work around Spring Data Rest
  // By adding a repository for feature types SDR does not add feature types when fetching a feature
  // source, while the front-end currently depends on having all feature types available.
  // In the future we could refactor this to give only a list of names and fetch the type itself
  // when needed.
  public List&lt;TMFeatureType&gt; getAllFeatureTypes() {
<span class="nc" id="L249">    return featureTypes;</span>
  }

  public List&lt;TMFeatureType&gt; getFeatureTypes() {
<span class="nc" id="L253">    return featureTypes;</span>
  }

  public TMFeatureSource setFeatureTypes(List&lt;TMFeatureType&gt; featureTypes) {
<span class="nc" id="L257">    this.featureTypes = featureTypes;</span>
<span class="nc" id="L258">    return this;</span>
  }

  // &lt;/editor-fold&gt;

  public TMFeatureType findFeatureTypeByName(String featureTypeName) {
<span class="nc" id="L264">    return getFeatureTypes().stream()</span>
<span class="nc" id="L265">        .filter(ft -&gt; featureTypeName.equals(ft.getName()))</span>
<span class="nc" id="L266">        .findFirst()</span>
<span class="nc" id="L267">        .orElse(null);</span>
  }
}
</pre><div class="footer"><span class="right">Created with <a href="http://www.jacoco.org/jacoco">JaCoCo</a> 0.8.14.202510111229</span></div></body></html>