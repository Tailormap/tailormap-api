<?xml version="1.0" encoding="UTF-8"?><!DOCTYPE html PUBLIC "-//W3C//DTD XHTML 1.0 Strict//EN" "http://www.w3.org/TR/xhtml1/DTD/xhtml1-strict.dtd"><html xmlns="http://www.w3.org/1999/xhtml" lang=""><head><meta http-equiv="Content-Type" content="text/html;charset=UTF-8"/><link rel="stylesheet" href="../jacoco-resources/report.css" type="text/css"/><link rel="shortcut icon" href="../jacoco-resources/report.gif" type="image/gif"/><title>FrontControllerResolver.java</title><link rel="stylesheet" href="../jacoco-resources/prettify.css" type="text/css"/><script type="text/javascript" src="../jacoco-resources/prettify.js"></script></head><body onload="window['PR_TAB_WIDTH']=4;prettyPrint()"><div class="breadcrumb" id="breadcrumb"><span class="info"><a href="../jacoco-sessions.html" class="el_session">Sessions</a></span><a href="../index.html" class="el_report">Aggregate Test Coverage</a> &gt; <a href="index.source.html" class="el_package">org.tailormap.api.configuration.base</a> &gt; <span class="el_source">FrontControllerResolver.java</span></div><h1>FrontControllerResolver.java</h1><pre class="source lang-java linenums">/*
 * Copyright (C) 2024 B3Partners B.V.
 *
 * SPDX-License-Identifier: MIT
 */

package org.tailormap.api.configuration.base;

import jakarta.servlet.http.HttpServletRequest;
import java.io.File;
import java.lang.invoke.MethodHandles;
import java.nio.charset.StandardCharsets;
import java.nio.file.Path;
import java.util.Arrays;
import java.util.Collections;
import java.util.List;
import java.util.Locale;
import java.util.regex.Pattern;
import org.apache.commons.lang3.StringUtils;
import org.slf4j.Logger;
import org.slf4j.LoggerFactory;
import org.springframework.beans.factory.InitializingBean;
import org.springframework.beans.factory.annotation.Value;
import org.springframework.context.annotation.Lazy;
import org.springframework.core.io.Resource;
import org.springframework.lang.NonNull;
import org.springframework.stereotype.Component;
import org.springframework.web.servlet.i18n.AcceptHeaderLocaleResolver;
import org.springframework.web.servlet.resource.ResourceResolver;
import org.springframework.web.servlet.resource.ResourceResolverChain;
import org.springframework.web.util.UriUtils;
import org.tailormap.api.persistence.Application;
import org.tailormap.api.persistence.Configuration;
import org.tailormap.api.repository.ApplicationRepository;
import org.tailormap.api.repository.ConfigurationRepository;

/**
 * Resolver which returns index.html for requests to paths created by the Angular routing module. &lt;br&gt;
 * When the user refreshes the page such routes are requested from the server.
 */
@Component
public class FrontControllerResolver implements ResourceResolver, InitializingBean {
<span class="nc" id="L43">  private static final Logger logger =</span>
<span class="nc" id="L44">      LoggerFactory.getLogger(MethodHandles.lookup().lookupClass());</span>

  private final ConfigurationRepository configurationRepository;
  private final ApplicationRepository applicationRepository;

  @Value(&quot;${spring.profiles.active:}&quot;)
  private String activeProfile;

  @Value(&quot;#{'${spring.web.resources.static-locations:}'.split(',')}&quot;)
  private List&lt;String&gt; staticResourceLocations;

  @Value(&quot;${tailormap-api.default-language:en}&quot;)
  private String defaultLanguage;

<span class="nc" id="L58">  private List&lt;String&gt; supportedLanguages = Collections.emptyList();</span>

  private AcceptHeaderLocaleResolver localeResolver;

  private boolean staticOnly;

<span class="nc" id="L64">  private final Pattern localeBundlePrefixPattern = Pattern.compile(&quot;^[a-z]{2}/.*&quot;);</span>

  public FrontControllerResolver(
      // Inject these repositories lazily because in the static-only profile these are not needed
      // but also not configured
<span class="nc" id="L69">      @Lazy ConfigurationRepository configurationRepository, @Lazy ApplicationRepository applicationRepository) {</span>
<span class="nc" id="L70">    this.configurationRepository = configurationRepository;</span>
<span class="nc" id="L71">    this.applicationRepository = applicationRepository;</span>
<span class="nc" id="L72">  }</span>

  @Override
  public void afterPropertiesSet() {
<span class="nc" id="L76">    this.staticOnly = activeProfile.contains(&quot;static-only&quot;);</span>

<span class="nc" id="L78">    this.localeResolver = new AcceptHeaderLocaleResolver();</span>

    try {
<span class="nc bnc" id="L81" title="All 2 branches missed.">      for (String resourceLocation : staticResourceLocations) {</span>
<span class="nc bnc" id="L82" title="All 2 branches missed.">        Path resourcePath = resourceLocation.startsWith(&quot;file:&quot;)</span>
<span class="nc" id="L83">            ? Path.of(StringUtils.removeStart(resourceLocation, &quot;file:&quot;))</span>
<span class="nc" id="L84">            : null;</span>
        // Check whether the resource path has the Tailormap frontend which always has a version.json
<span class="nc bnc" id="L86" title="All 2 branches missed.">        if (resourcePath != null</span>
<span class="nc bnc" id="L87" title="All 2 branches missed.">            &amp;&amp; resourcePath.resolve(&quot;version.json&quot;).toFile().exists()) {</span>
          // Only check for locale bundle directories when the frontend is built with localization. When
          // index.html exists this is a non-localized build -- leave supportedLanguages empty
<span class="nc bnc" id="L90" title="All 2 branches missed.">          if (resourcePath.resolve(&quot;index.html&quot;).toFile().exists()) {</span>
<span class="nc" id="L91">            break;</span>
          }

<span class="nc" id="L94">          File[] languageBundleDirs =</span>
<span class="nc" id="L95">              resourcePath.toFile().listFiles((file, name) -&gt; name.matches(&quot;^[a-z]{2}$&quot;));</span>
<span class="nc bnc" id="L96" title="All 4 branches missed.">          if (languageBundleDirs != null &amp;&amp; languageBundleDirs.length &gt; 0) {</span>
<span class="nc" id="L97">            supportedLanguages = Arrays.stream(languageBundleDirs)</span>
<span class="nc" id="L98">                .map(File::getName)</span>
<span class="nc" id="L99">                .toList();</span>
<span class="nc" id="L100">            logger.info(&quot;Detected frontend bundles for languages: {}&quot;, supportedLanguages);</span>
          }
          break;
        }
<span class="nc" id="L104">      }</span>
<span class="nc" id="L105">    } catch (Exception e) {</span>
<span class="nc" id="L106">      logger.error(&quot;Error while trying to determine frontend languages bundles&quot;, e);</span>
<span class="nc" id="L107">    }</span>

<span class="nc bnc" id="L109" title="All 2 branches missed.">    if (!supportedLanguages.isEmpty()) {</span>
<span class="nc" id="L110">      localeResolver.setSupportedLocales(</span>
<span class="nc" id="L111">          supportedLanguages.stream().map(Locale::new).toList());</span>
<span class="nc bnc" id="L112" title="All 2 branches missed.">      Locale defaultLocale = supportedLanguages.contains(defaultLanguage)</span>
<span class="nc" id="L113">          ? new Locale(defaultLanguage)</span>
<span class="nc" id="L114">          : localeResolver.getSupportedLocales().get(0);</span>
<span class="nc" id="L115">      localeResolver.setDefaultLocale(defaultLocale);</span>
<span class="nc" id="L116">      logger.info(&quot;Default language set to: {}&quot;, defaultLocale.toLanguageTag());</span>
    }
<span class="nc" id="L118">  }</span>

  @Override
  public Resource resolveResource(
      HttpServletRequest request,
      @NonNull String requestPath,
      @NonNull List&lt;? extends Resource&gt; locations,
      ResourceResolverChain chain) {
    // Front controller logic: when routes used by the frontend are directly requested, return the
    // index.html instead of a 404.
    // Paths in @RequestMapping have higher priority than this resolver

    // When the resource exists (such as HTML, CSS, JS, etc.), return it
<span class="nc" id="L131">    Resource resource = chain.resolveResource(request, requestPath, locations);</span>
<span class="nc bnc" id="L132" title="All 2 branches missed.">    if (resource != null) {</span>
<span class="nc" id="L133">      return resource;</span>
    }

    // Check if the request path already starts with a locale prefix like en/ or nl/
<span class="nc" id="L137">    String localePrefix = StringUtils.left(requestPath, 2);</span>
<span class="nc bnc" id="L138" title="All 4 branches missed.">    if ((localeBundlePrefixPattern.matcher(requestPath).matches() &amp;&amp; supportedLanguages.contains(localePrefix))</span>
        // When the request is just &quot;GET /nl/&quot; or &quot;GET /nl&quot; the requestPath is &quot;nl&quot; without a
        // trailing slash
<span class="nc bnc" id="L141" title="All 2 branches missed.">        || supportedLanguages.contains(requestPath)) {</span>
<span class="nc" id="L142">      return chain.resolveResource(request, localePrefix + &quot;/index.html&quot;, locations);</span>
    }

    // When the request path denotes an app, return the index.html for the default language
    // configured for the app

<span class="nc bnc" id="L148" title="All 2 branches missed.">    if (!staticOnly) {</span>
<span class="nc" id="L149">      Application app = null;</span>
<span class="nc bnc" id="L150" title="All 4 branches missed.">      if (&quot;index.html&quot;.equals(requestPath) || requestPath.matches(&quot;^app/?&quot;)) {</span>
<span class="nc" id="L151">        String defaultAppName = configurationRepository.get(Configuration.DEFAULT_APP);</span>
<span class="nc" id="L152">        app = applicationRepository.findByName(defaultAppName);</span>
<span class="nc bnc" id="L153" title="All 2 branches missed.">      } else if (requestPath.startsWith(&quot;app/&quot;)) {</span>
<span class="nc" id="L154">        String[] parts = requestPath.split(&quot;/&quot;, -1);</span>
<span class="nc bnc" id="L155" title="All 2 branches missed.">        if (parts.length &gt; 1) {</span>
<span class="nc" id="L156">          String appName = UriUtils.decode(parts[1], StandardCharsets.UTF_8);</span>
<span class="nc" id="L157">          app = applicationRepository.findByName(appName);</span>
        }
      }

<span class="nc bnc" id="L161" title="All 4 branches missed.">      if (app != null &amp;&amp; app.getSettings().getI18nSettings() != null) {</span>
<span class="nc" id="L162">        String appLanguage = app.getSettings().getI18nSettings().getDefaultLanguage();</span>
<span class="nc bnc" id="L163" title="All 2 branches missed.">        if (appLanguage != null) {</span>
<span class="nc" id="L164">          resource = chain.resolveResource(request, appLanguage + &quot;/index.html&quot;, locations);</span>
<span class="nc bnc" id="L165" title="All 2 branches missed.">          if (resource != null) {</span>
<span class="nc" id="L166">            return resource;</span>
          }
        }
      }
    }

    // Otherwise use the LocaleResolver to return the index.html for the language of the
    // Accept-Language header
<span class="nc" id="L174">    Locale locale = localeResolver.resolveLocale(request);</span>
<span class="nc" id="L175">    resource = chain.resolveResource(request, locale.toLanguageTag() + &quot;/index.html&quot;, locations);</span>

    // When frontend is built without localization, return the index.html in the root
<span class="nc bnc" id="L178" title="All 2 branches missed.">    if (resource == null) {</span>
<span class="nc" id="L179">      resource = chain.resolveResource(request, &quot;/index.html&quot;, locations);</span>
    }
<span class="nc" id="L181">    return resource;</span>
  }

  @Override
  public String resolveUrlPath(
      @NonNull String resourcePath, @NonNull List&lt;? extends Resource&gt; locations, ResourceResolverChain chain) {
<span class="nc" id="L187">    return chain.resolveUrlPath(resourcePath, locations);</span>
  }
}
</pre><div class="footer"><span class="right">Created with <a href="http://www.jacoco.org/jacoco">JaCoCo</a> 0.8.12.202403310830</span></div></body></html>