<?xml version="1.0" encoding="UTF-8"?><!DOCTYPE html PUBLIC "-//W3C//DTD XHTML 1.0 Strict//EN" "http://www.w3.org/TR/xhtml1/DTD/xhtml1-strict.dtd"><html xmlns="http://www.w3.org/1999/xhtml" lang=""><head><meta http-equiv="Content-Type" content="text/html;charset=UTF-8"/><link rel="stylesheet" href="../jacoco-resources/report.css" type="text/css"/><link rel="shortcut icon" href="../jacoco-resources/report.gif" type="image/gif"/><title>FrontControllerResolver.java</title><link rel="stylesheet" href="../jacoco-resources/prettify.css" type="text/css"/><script type="text/javascript" src="../jacoco-resources/prettify.js"></script></head><body onload="window['PR_TAB_WIDTH']=4;prettyPrint()"><div class="breadcrumb" id="breadcrumb"><span class="info"><a href="../jacoco-sessions.html" class="el_session">Sessions</a></span><a href="../index.html" class="el_report">Aggregate Test Coverage</a> &gt; <a href="index.source.html" class="el_package">org.tailormap.api.configuration.base</a> &gt; <span class="el_source">FrontControllerResolver.java</span></div><h1>FrontControllerResolver.java</h1><pre class="source lang-java linenums">/*
 * Copyright (C) 2024 B3Partners B.V.
 *
 * SPDX-License-Identifier: MIT
 */

package org.tailormap.api.configuration.base;

import jakarta.servlet.http.HttpServletRequest;
import java.nio.charset.StandardCharsets;
import java.util.List;
import java.util.Locale;
import java.util.regex.Pattern;
import org.apache.commons.lang3.StringUtils;
import org.springframework.beans.factory.InitializingBean;
import org.springframework.beans.factory.annotation.Value;
import org.springframework.context.annotation.Lazy;
import org.springframework.core.io.Resource;
import org.springframework.lang.NonNull;
import org.springframework.stereotype.Component;
import org.springframework.web.servlet.i18n.AcceptHeaderLocaleResolver;
import org.springframework.web.servlet.resource.ResourceResolver;
import org.springframework.web.servlet.resource.ResourceResolverChain;
import org.springframework.web.util.UriUtils;
import org.tailormap.api.persistence.Application;
import org.tailormap.api.persistence.Configuration;
import org.tailormap.api.repository.ApplicationRepository;
import org.tailormap.api.repository.ConfigurationRepository;

/**
 * Resolver which returns index.html for requests to paths created by the Angular routing module. &lt;br&gt;
 * When the user refreshes the page such routes are requested from the server.
 */
@Component
public class FrontControllerResolver implements ResourceResolver, InitializingBean {

  private final ConfigurationRepository configurationRepository;
  private final ApplicationRepository applicationRepository;

  @Value(&quot;${spring.profiles.active:}&quot;)
  private String activeProfile;

  @Value(&quot;#{'${tailormap-api.supported-languages:en}'.split(',')}&quot;)
  private List&lt;String&gt; supportedLanguages;

  private AcceptHeaderLocaleResolver localeResolver;

  private boolean staticOnly;

<span class="nc" id="L50">  private final Pattern localeBundlePrefixPattern = Pattern.compile(&quot;^[a-z]{2}/.*&quot;);</span>

  public FrontControllerResolver(
      // Inject these repositories lazily because in the static-only profile these are not needed
      // but also not configured
<span class="nc" id="L55">      @Lazy ConfigurationRepository configurationRepository, @Lazy ApplicationRepository applicationRepository) {</span>
<span class="nc" id="L56">    this.configurationRepository = configurationRepository;</span>
<span class="nc" id="L57">    this.applicationRepository = applicationRepository;</span>
<span class="nc" id="L58">  }</span>

  @Override
  public void afterPropertiesSet() {
<span class="nc" id="L62">    this.staticOnly = activeProfile.contains(&quot;static-only&quot;);</span>

<span class="nc" id="L64">    this.localeResolver = new AcceptHeaderLocaleResolver();</span>
<span class="nc" id="L65">    localeResolver.setSupportedLocales(</span>
<span class="nc" id="L66">        supportedLanguages.stream().map(Locale::new).toList());</span>
<span class="nc" id="L67">    localeResolver.setDefaultLocale(localeResolver.getSupportedLocales().get(0));</span>
<span class="nc" id="L68">  }</span>

  @Override
  public Resource resolveResource(
      HttpServletRequest request,
      @NonNull String requestPath,
      @NonNull List&lt;? extends Resource&gt; locations,
      ResourceResolverChain chain) {
    // Front controller logic: when routes used by the frontend are directly requested, return the
    // index.html instead of a 404.
    // Paths in @RequestMapping have higher priority than this resolver

    // When the resource exists (such as HTML, CSS, JS, etc.), return it
<span class="nc" id="L81">    Resource resource = chain.resolveResource(request, requestPath, locations);</span>
<span class="nc bnc" id="L82" title="All 2 branches missed.">    if (resource != null) {</span>
<span class="nc" id="L83">      return resource;</span>
    }

    // Check if the request path already starts with a locale prefix like en/ or nl/
<span class="nc" id="L87">    String localePrefix = StringUtils.left(requestPath, 2);</span>
<span class="nc bnc" id="L88" title="All 4 branches missed.">    if ((localeBundlePrefixPattern.matcher(requestPath).matches() &amp;&amp; supportedLanguages.contains(localePrefix))</span>
        // When the request is just &quot;GET /nl/&quot; or &quot;GET /nl&quot; the requestPath is &quot;nl&quot; without a
        // trailing slash
<span class="nc bnc" id="L91" title="All 2 branches missed.">        || supportedLanguages.contains(requestPath)) {</span>
<span class="nc" id="L92">      return chain.resolveResource(request, localePrefix + &quot;/index.html&quot;, locations);</span>
    }

    // When the request path denotes an app, return the index.html for the default language
    // configured for the app

<span class="nc bnc" id="L98" title="All 2 branches missed.">    if (!staticOnly) {</span>
<span class="nc" id="L99">      Application app = null;</span>
<span class="nc bnc" id="L100" title="All 4 branches missed.">      if (&quot;index.html&quot;.equals(requestPath) || requestPath.matches(&quot;^app/?&quot;)) {</span>
<span class="nc" id="L101">        String defaultAppName = configurationRepository.get(Configuration.DEFAULT_APP);</span>
<span class="nc" id="L102">        app = applicationRepository.findByName(defaultAppName);</span>
<span class="nc bnc" id="L103" title="All 2 branches missed.">      } else if (requestPath.startsWith(&quot;app/&quot;)) {</span>
<span class="nc" id="L104">        String[] parts = requestPath.split(&quot;/&quot;, -1);</span>
<span class="nc bnc" id="L105" title="All 2 branches missed.">        if (parts.length &gt; 1) {</span>
<span class="nc" id="L106">          String appName = UriUtils.decode(parts[1], StandardCharsets.UTF_8);</span>
<span class="nc" id="L107">          app = applicationRepository.findByName(appName);</span>
        }
      }

<span class="nc bnc" id="L111" title="All 4 branches missed.">      if (app != null &amp;&amp; app.getSettings().getI18nSettings() != null) {</span>
<span class="nc" id="L112">        String appLanguage = app.getSettings().getI18nSettings().getDefaultLanguage();</span>
<span class="nc bnc" id="L113" title="All 2 branches missed.">        if (appLanguage != null) {</span>
<span class="nc" id="L114">          resource = chain.resolveResource(request, appLanguage + &quot;/index.html&quot;, locations);</span>
<span class="nc bnc" id="L115" title="All 2 branches missed.">          if (resource != null) {</span>
<span class="nc" id="L116">            return resource;</span>
          }
        }
      }
    }

    // Otherwise use the LocaleResolver to return the index.html for the language of the
    // Accept-Language header
<span class="nc" id="L124">    Locale locale = localeResolver.resolveLocale(request);</span>
<span class="nc" id="L125">    return chain.resolveResource(request, locale.toLanguageTag() + &quot;/index.html&quot;, locations);</span>
  }

  @Override
  public String resolveUrlPath(
      @NonNull String resourcePath, @NonNull List&lt;? extends Resource&gt; locations, ResourceResolverChain chain) {
<span class="nc" id="L131">    return chain.resolveUrlPath(resourcePath, locations);</span>
  }
}
</pre><div class="footer"><span class="right">Created with <a href="http://www.jacoco.org/jacoco">JaCoCo</a> 0.8.12.202403310830</span></div></body></html>