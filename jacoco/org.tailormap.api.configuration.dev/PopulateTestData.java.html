<?xml version="1.0" encoding="UTF-8"?><!DOCTYPE html PUBLIC "-//W3C//DTD XHTML 1.0 Strict//EN" "http://www.w3.org/TR/xhtml1/DTD/xhtml1-strict.dtd"><html xmlns="http://www.w3.org/1999/xhtml" lang=""><head><meta http-equiv="Content-Type" content="text/html;charset=UTF-8"/><link rel="stylesheet" href="../jacoco-resources/report.css" type="text/css"/><link rel="shortcut icon" href="../jacoco-resources/report.gif" type="image/gif"/><title>PopulateTestData.java</title><link rel="stylesheet" href="../jacoco-resources/prettify.css" type="text/css"/><script type="text/javascript" src="../jacoco-resources/prettify.js"></script></head><body onload="window['PR_TAB_WIDTH']=4;prettyPrint()"><div class="breadcrumb" id="breadcrumb"><span class="info"><a href="../jacoco-sessions.html" class="el_session">Sessions</a></span><a href="../index.html" class="el_report">Aggregate Test Coverage</a> &gt; <a href="index.source.html" class="el_package">org.tailormap.api.configuration.dev</a> &gt; <span class="el_source">PopulateTestData.java</span></div><h1>PopulateTestData.java</h1><pre class="source lang-java linenums">/*
 * Copyright (C) 2023 B3Partners B.V.
 *
 * SPDX-License-Identifier: MIT
 */
package org.tailormap.api.configuration.dev;

import static org.tailormap.api.persistence.Configuration.HOME_PAGE;
import static org.tailormap.api.persistence.Configuration.PORTAL_MENU;
import static org.tailormap.api.persistence.json.GeoServiceProtocol.QUANTIZEDMESH;
import static org.tailormap.api.persistence.json.GeoServiceProtocol.TILES3D;
import static org.tailormap.api.persistence.json.GeoServiceProtocol.WMS;
import static org.tailormap.api.persistence.json.GeoServiceProtocol.WMTS;
import static org.tailormap.api.persistence.json.GeoServiceProtocol.XYZ;
import static org.tailormap.api.persistence.json.HiddenLayerFunctionalityEnum.ATTRIBUTE_LIST;
import static org.tailormap.api.persistence.json.HiddenLayerFunctionalityEnum.EXPORT;
import static org.tailormap.api.persistence.json.HiddenLayerFunctionalityEnum.FEATURE_INFO;
import static org.tailormap.api.security.AuthorizationService.ACCESS_TYPE_READ;

import com.fasterxml.jackson.core.JsonProcessingException;
import com.fasterxml.jackson.databind.ObjectMapper;
import java.io.IOException;
import java.lang.invoke.MethodHandles;
import java.time.OffsetDateTime;
import java.time.ZoneId;
import java.util.ArrayList;
import java.util.Collection;
import java.util.List;
import java.util.Map;
import java.util.NoSuchElementException;
import java.util.Optional;
import java.util.Set;
import java.util.UUID;
import org.apache.solr.client.solrj.SolrServerException;
import org.quartz.SchedulerException;
import org.slf4j.Logger;
import org.slf4j.LoggerFactory;
import org.springframework.beans.factory.annotation.Value;
import org.springframework.boot.SpringApplication;
import org.springframework.boot.autoconfigure.condition.ConditionalOnProperty;
import org.springframework.boot.context.event.ApplicationReadyEvent;
import org.springframework.context.ApplicationContext;
import org.springframework.context.event.EventListener;
import org.springframework.core.io.ClassPathResource;
import org.springframework.jdbc.core.simple.JdbcClient;
import org.springframework.transaction.annotation.Transactional;
import org.tailormap.api.admin.model.TaskSchedule;
import org.tailormap.api.geotools.featuresources.FeatureSourceFactoryHelper;
import org.tailormap.api.geotools.featuresources.JDBCFeatureSourceHelper;
import org.tailormap.api.geotools.featuresources.WFSFeatureSourceHelper;
import org.tailormap.api.persistence.Application;
import org.tailormap.api.persistence.Catalog;
import org.tailormap.api.persistence.Configuration;
import org.tailormap.api.persistence.GeoService;
import org.tailormap.api.persistence.Group;
import org.tailormap.api.persistence.Page;
import org.tailormap.api.persistence.SearchIndex;
import org.tailormap.api.persistence.TMFeatureSource;
import org.tailormap.api.persistence.TMFeatureType;
import org.tailormap.api.persistence.Upload;
import org.tailormap.api.persistence.User;
import org.tailormap.api.persistence.helper.GeoServiceHelper;
import org.tailormap.api.persistence.json.AppContent;
import org.tailormap.api.persistence.json.AppLayerSettings;
import org.tailormap.api.persistence.json.AppSettings;
import org.tailormap.api.persistence.json.AppTreeLayerNode;
import org.tailormap.api.persistence.json.AppTreeLevelNode;
import org.tailormap.api.persistence.json.AppTreeNode;
import org.tailormap.api.persistence.json.AppUiSettings;
import org.tailormap.api.persistence.json.AttributeSettings;
import org.tailormap.api.persistence.json.AuthorizationRule;
import org.tailormap.api.persistence.json.AuthorizationRuleDecision;
import org.tailormap.api.persistence.json.Bounds;
import org.tailormap.api.persistence.json.CatalogNode;
import org.tailormap.api.persistence.json.FeatureTypeRef;
import org.tailormap.api.persistence.json.FeatureTypeTemplate;
import org.tailormap.api.persistence.json.GeoServiceDefaultLayerSettings;
import org.tailormap.api.persistence.json.GeoServiceLayerSettings;
import org.tailormap.api.persistence.json.GeoServiceSettings;
import org.tailormap.api.persistence.json.JDBCConnectionProperties;
import org.tailormap.api.persistence.json.MenuItem;
import org.tailormap.api.persistence.json.PageTile;
import org.tailormap.api.persistence.json.ServiceAuthentication;
import org.tailormap.api.persistence.json.TailormapObjectRef;
import org.tailormap.api.persistence.json.TileLayerHiDpiMode;
import org.tailormap.api.repository.ApplicationRepository;
import org.tailormap.api.repository.CatalogRepository;
import org.tailormap.api.repository.ConfigurationRepository;
import org.tailormap.api.repository.FeatureSourceRepository;
import org.tailormap.api.repository.GeoServiceRepository;
import org.tailormap.api.repository.GroupRepository;
import org.tailormap.api.repository.PageRepository;
import org.tailormap.api.repository.SearchIndexRepository;
import org.tailormap.api.repository.UploadRepository;
import org.tailormap.api.repository.UserRepository;
import org.tailormap.api.scheduling.FailingPocTask;
import org.tailormap.api.scheduling.IndexTask;
import org.tailormap.api.scheduling.InterruptablePocTask;
import org.tailormap.api.scheduling.PocTask;
import org.tailormap.api.scheduling.TMJobDataMap;
import org.tailormap.api.scheduling.Task;
import org.tailormap.api.scheduling.TaskManagerService;
import org.tailormap.api.scheduling.TaskType;
import org.tailormap.api.security.InternalAdminAuthentication;
import org.tailormap.api.solr.SolrHelper;
import org.tailormap.api.solr.SolrService;
import org.tailormap.api.viewer.model.AppStyling;
import org.tailormap.api.viewer.model.Component;
import org.tailormap.api.viewer.model.ComponentConfig;

/**
 * Populates entities to add services and applications to demo functionality, support development and use in integration
 * tests with a common set of test data. See README.md for usage details.
 */
@org.springframework.context.annotation.Configuration
@ConditionalOnProperty(name = &quot;tailormap-api.database.populate-testdata&quot;, havingValue = &quot;true&quot;)
public class PopulateTestData {

<span class="nc" id="L119">  private static final Logger logger =</span>
<span class="nc" id="L120">      LoggerFactory.getLogger(MethodHandles.lookup().lookupClass());</span>
  private final ApplicationContext appContext;
  private final UserRepository userRepository;
  private final GroupRepository groupRepository;
  private final CatalogRepository catalogRepository;
  private final GeoServiceRepository geoServiceRepository;
  private final GeoServiceHelper geoServiceHelper;
  private final SolrService solrService;
  private final TaskManagerService taskManagerService;
  private final FeatureSourceRepository featureSourceRepository;
  private final ApplicationRepository applicationRepository;
  private final ConfigurationRepository configurationRepository;
  private final SearchIndexRepository searchIndexRepository;
  private final FeatureSourceFactoryHelper featureSourceFactoryHelper;
  private final UploadRepository uploadRepository;
  private final PageRepository pageRepository;
  private final JdbcClient jdbcClient;

  @Value(&quot;${spatial.dbs.connect:false}&quot;)
  private boolean connectToSpatialDbs;

  @Value(&quot;#{'${tailormap-api.database.populate-testdata.categories}'.split(',')}&quot;)
  private Set&lt;String&gt; categories;

  @Value(&quot;${spatial.dbs.localhost:true}&quot;)
  private boolean connectToSpatialDbsAtLocalhost;

  @Value(&quot;${tailormap-api.database.populate-testdata.admin-hashed-password}&quot;)
  private String adminHashedPassword;

  @Value(&quot;${tailormap-api.database.populate-testdata.exit:false}&quot;)
  private boolean exit;

  @Value(&quot;${MAP5_URL:#{null}}&quot;)
  private String map5url;

  @Value(&quot;${tailormap-api.solr-batch-size:1000}&quot;)
  private int solrBatchSize;

  @Value(&quot;${tailormap-api.solr-geometry-validation-rule:repairBuffer0}&quot;)
  private String solrGeometryValidationRule;

  public PopulateTestData(
      ApplicationContext appContext,
      UserRepository userRepository,
      GroupRepository groupRepository,
      CatalogRepository catalogRepository,
      GeoServiceRepository geoServiceRepository,
      GeoServiceHelper geoServiceHelper,
      SolrService solrService,
      TaskManagerService taskManagerService,
      FeatureSourceRepository featureSourceRepository,
      ApplicationRepository applicationRepository,
      ConfigurationRepository configurationRepository,
      FeatureSourceFactoryHelper featureSourceFactoryHelper,
      SearchIndexRepository searchIndexRepository,
      UploadRepository uploadRepository,
      PageRepository pageRepository,
<span class="nc" id="L178">      JdbcClient jdbcClient) {</span>
<span class="nc" id="L179">    this.appContext = appContext;</span>
<span class="nc" id="L180">    this.userRepository = userRepository;</span>
<span class="nc" id="L181">    this.groupRepository = groupRepository;</span>
<span class="nc" id="L182">    this.catalogRepository = catalogRepository;</span>
<span class="nc" id="L183">    this.geoServiceRepository = geoServiceRepository;</span>
<span class="nc" id="L184">    this.geoServiceHelper = geoServiceHelper;</span>
<span class="nc" id="L185">    this.solrService = solrService;</span>
<span class="nc" id="L186">    this.taskManagerService = taskManagerService;</span>
<span class="nc" id="L187">    this.featureSourceRepository = featureSourceRepository;</span>
<span class="nc" id="L188">    this.applicationRepository = applicationRepository;</span>
<span class="nc" id="L189">    this.configurationRepository = configurationRepository;</span>
<span class="nc" id="L190">    this.featureSourceFactoryHelper = featureSourceFactoryHelper;</span>
<span class="nc" id="L191">    this.searchIndexRepository = searchIndexRepository;</span>
<span class="nc" id="L192">    this.uploadRepository = uploadRepository;</span>
<span class="nc" id="L193">    this.pageRepository = pageRepository;</span>
<span class="nc" id="L194">    this.jdbcClient = jdbcClient;</span>
<span class="nc" id="L195">  }</span>

  @EventListener(ApplicationReadyEvent.class)
  @Transactional
  public void populate() throws Exception {
<span class="nc" id="L200">    InternalAdminAuthentication.setInSecurityContext();</span>
    try {
      // Used in conjunction with tailormap-api.database.clean=true so the database has been cleaned
      // and the latest schema re-created
<span class="nc" id="L204">      createTestUsersAndGroups();</span>
<span class="nc" id="L205">      createConfigurationTestData();</span>
<span class="nc bnc" id="L206" title="All 2 branches missed.">      if (categories.contains(&quot;catalog&quot;)) {</span>
<span class="nc" id="L207">        createCatalogTestData();</span>
      }
<span class="nc bnc" id="L209" title="All 2 branches missed.">      if (categories.contains(&quot;apps&quot;)) {</span>
<span class="nc" id="L210">        createAppTestData();</span>
      }
<span class="nc bnc" id="L212" title="All 2 branches missed.">      if (categories.contains(&quot;search-index&quot;)) {</span>
        try {
<span class="nc" id="L214">          createSolrIndex();</span>
<span class="nc" id="L215">        } catch (Exception e) {</span>
<span class="nc" id="L216">          logger.error(&quot;Exception creating Solr Index for testdata (continuing)&quot;, e);</span>
<span class="nc" id="L217">        }</span>
      }
<span class="nc bnc" id="L219" title="All 2 branches missed.">      if (categories.contains(&quot;tasks&quot;)) {</span>
<span class="nc" id="L220">        createScheduledTasks();</span>
      }
<span class="nc bnc" id="L222" title="All 2 branches missed.">      if (categories.contains(&quot;pages&quot;)) {</span>
<span class="nc" id="L223">        createPages();</span>
      }
<span class="nc" id="L225">      logger.info(&quot;Test entities created&quot;);</span>
<span class="nc bnc" id="L226" title="All 2 branches missed.">      if (categories.contains(&quot;drawing&quot;)) {</span>
<span class="nc" id="L227">        insertTestDrawing();</span>
<span class="nc" id="L228">        logger.info(&quot;Test drawing created&quot;);</span>
      }
    } finally {
<span class="nc" id="L231">      InternalAdminAuthentication.clearSecurityContextAuthentication();</span>
    }
<span class="nc bnc" id="L233" title="All 2 branches missed.">    if (exit) {</span>
      // Exit after transaction is completed - for 'mvn verify' to populate testdata before
      // integration tests
<span class="nc" id="L236">      new Thread(() -&gt; {</span>
            try {
<span class="nc" id="L238">              logger.info(&quot;Exiting in 10 seconds&quot;);</span>
<span class="nc" id="L239">              Thread.sleep(10000);</span>
<span class="nc" id="L240">            } catch (InterruptedException ignored) {</span>
              // Ignore
<span class="nc" id="L242">            }</span>
<span class="nc" id="L243">            SpringApplication.exit(appContext, () -&gt; 0);</span>
<span class="nc" id="L244">            System.exit(0);</span>
<span class="nc" id="L245">          })</span>
<span class="nc" id="L246">          .start();</span>
    }
<span class="nc" id="L248">  }</span>

  public void createTestUsersAndGroups() throws NoSuchElementException {
<span class="nc" id="L251">    Group groupFoo = new Group().setName(&quot;test-foo&quot;).setDescription(&quot;Used for integration tests.&quot;);</span>
<span class="nc" id="L252">    groupRepository.save(groupFoo);</span>

<span class="nc" id="L254">    Group groupBar = new Group().setName(&quot;test-bar&quot;).setDescription(&quot;Used for integration tests.&quot;);</span>
<span class="nc" id="L255">    groupBar.addOrUpdateAdminProperty(&quot;group-property&quot;, true, true);</span>
<span class="nc" id="L256">    groupBar.addOrUpdateAdminProperty(&quot;group-private-property&quot;, 999.9, false);</span>
<span class="nc" id="L257">    groupRepository.save(groupBar);</span>

<span class="nc" id="L259">    Group groupBaz = new Group().setName(&quot;test-baz&quot;).setDescription(&quot;Used for integration tests.&quot;);</span>
<span class="nc" id="L260">    groupRepository.save(groupBaz);</span>

    // Normal user
<span class="nc" id="L263">    User u = new User().setUsername(&quot;user&quot;).setPassword(&quot;{noop}user&quot;).setEmail(&quot;user@example.com&quot;);</span>
<span class="nc" id="L264">    u.getGroups().addAll(List.of(groupFoo, groupBar, groupBaz));</span>
<span class="nc" id="L265">    userRepository.save(u);</span>

    // Superuser with all access
<span class="nc" id="L268">    u = new User().setUsername(&quot;tm-admin&quot;).setPassword(adminHashedPassword);</span>
<span class="nc" id="L269">    u.addOrUpdateAdminProperty(&quot;some-property&quot;, &quot;some-value&quot;, true);</span>
<span class="nc" id="L270">    u.addOrUpdateAdminProperty(&quot;admin-property&quot;, &quot;private-value&quot;, false);</span>
<span class="nc" id="L271">    u.getGroups().add(groupRepository.findById(Group.ADMIN).orElseThrow());</span>
<span class="nc" id="L272">    u.getGroups().add(groupBar);</span>
<span class="nc" id="L273">    userRepository.save(u);</span>
<span class="nc" id="L274">  }</span>

<span class="nc" id="L276">  private final List&lt;AuthorizationRule&gt; ruleAnonymousRead = List.of(new AuthorizationRule()</span>
<span class="nc" id="L277">      .groupName(Group.ANONYMOUS)</span>
<span class="nc" id="L278">      .decisions(Map.of(ACCESS_TYPE_READ, AuthorizationRuleDecision.ALLOW)));</span>

<span class="nc" id="L280">  private final List&lt;AuthorizationRule&gt; ruleLoggedIn = List.of(new AuthorizationRule()</span>
<span class="nc" id="L281">      .groupName(Group.AUTHENTICATED)</span>
<span class="nc" id="L282">      .decisions(Map.of(ACCESS_TYPE_READ, AuthorizationRuleDecision.ALLOW)));</span>

  @SuppressWarnings(&quot;PMD.AvoidUsingHardCodedIP&quot;)
  private void createCatalogTestData() throws Exception {
<span class="nc" id="L286">    Catalog catalog = catalogRepository.findById(Catalog.MAIN).orElseThrow();</span>
<span class="nc" id="L287">    CatalogNode rootCatalogNode = catalog.getNodes().get(0);</span>
<span class="nc" id="L288">    CatalogNode catalogNode = new CatalogNode().id(&quot;test&quot;).title(&quot;Test services&quot;);</span>
<span class="nc" id="L289">    rootCatalogNode.addChildrenItem(catalogNode.getId());</span>
<span class="nc" id="L290">    catalog.getNodes().add(catalogNode);</span>

<span class="nc" id="L292">    String osmAttribution = &quot;© [OpenStreetMap](https://www.openstreetmap.org/copyright) contributors&quot;;</span>

<span class="nc" id="L294">    Bounds rdTileGridExtent =</span>
<span class="nc" id="L295">        new Bounds().minx(-285401.92).maxx(595401.92).miny(22598.08).maxy(903401.92);</span>

<span class="nc" id="L297">    Upload legend = new Upload()</span>
<span class="nc" id="L298">        .setCategory(Upload.CATEGORY_LEGEND)</span>
<span class="nc" id="L299">        .setFilename(&quot;gemeentegebied-legend.png&quot;)</span>
<span class="nc" id="L300">        .setMimeType(&quot;image/png&quot;)</span>
<span class="nc" id="L301">        .setContent(new ClassPathResource(&quot;test/gemeentegebied-legend.png&quot;).getContentAsByteArray())</span>
<span class="nc" id="L302">        .setLastModified(OffsetDateTime.now(ZoneId.systemDefault()));</span>
<span class="nc" id="L303">    uploadRepository.save(legend);</span>

<span class="nc" id="L305">    Collection&lt;GeoService&gt; services = List.of(</span>
        new GeoService()
<span class="nc" id="L307">            .setId(&quot;demo&quot;)</span>
<span class="nc" id="L308">            .setProtocol(WMS)</span>
<span class="nc" id="L309">            .setTitle(&quot;Demo&quot;)</span>
<span class="nc" id="L310">            .setPublished(true)</span>
<span class="nc" id="L311">            .setAuthorizationRules(ruleAnonymousRead)</span>
<span class="nc" id="L312">            .setUrl(&quot;https://demo.tailormap.com/geoserver/geodata/ows?SERVICE=WMS&quot;),</span>
        new GeoService()
<span class="nc" id="L314">            .setId(&quot;osm&quot;)</span>
<span class="nc" id="L315">            .setProtocol(XYZ)</span>
<span class="nc" id="L316">            .setTitle(&quot;OSM&quot;)</span>
<span class="nc" id="L317">            .setUrl(&quot;https://tile.openstreetmap.org/{z}/{x}/{y}.png&quot;)</span>
<span class="nc" id="L318">            .setAuthorizationRules(ruleAnonymousRead)</span>
<span class="nc" id="L319">            .setSettings(new GeoServiceSettings()</span>
<span class="nc" id="L320">                .xyzCrs(&quot;EPSG:3857&quot;)</span>
<span class="nc" id="L321">                .layerSettings(Map.of(</span>
                    &quot;xyz&quot;,
                    new GeoServiceLayerSettings()
<span class="nc" id="L324">                        .attribution(osmAttribution)</span>
<span class="nc" id="L325">                        .maxZoom(19)))),</span>
        // Layer settings configured later, using the same settings for this one and proxied one
        new GeoService()
<span class="nc" id="L328">            .setId(&quot;snapshot-geoserver&quot;)</span>
<span class="nc" id="L329">            .setProtocol(WMS)</span>
<span class="nc" id="L330">            .setTitle(&quot;Test GeoServer&quot;)</span>
<span class="nc" id="L331">            .setUrl(&quot;https://snapshot.tailormap.nl/geoserver/wms&quot;)</span>
<span class="nc" id="L332">            .setAuthorizationRules(ruleAnonymousRead)</span>
<span class="nc" id="L333">            .setPublished(true),</span>
        new GeoService()
<span class="nc" id="L335">            .setId(&quot;filtered-snapshot-geoserver&quot;)</span>
<span class="nc" id="L336">            .setProtocol(WMS)</span>
<span class="nc" id="L337">            .setTitle(&quot;Test GeoServer (with authorization rules)&quot;)</span>
<span class="nc" id="L338">            .setUrl(&quot;https://snapshot.tailormap.nl/geoserver/wms&quot;)</span>
<span class="nc" id="L339">            .setAuthorizationRules(List.of(</span>
                new AuthorizationRule()
<span class="nc" id="L341">                    .groupName(&quot;test-foo&quot;)</span>
<span class="nc" id="L342">                    .decisions(Map.of(ACCESS_TYPE_READ, AuthorizationRuleDecision.ALLOW)),</span>
                new AuthorizationRule()
<span class="nc" id="L344">                    .groupName(&quot;test-baz&quot;)</span>
<span class="nc" id="L345">                    .decisions(Map.of(ACCESS_TYPE_READ, AuthorizationRuleDecision.ALLOW))))</span>
<span class="nc" id="L346">            .setSettings(new GeoServiceSettings()</span>
<span class="nc" id="L347">                .layerSettings(Map.of(</span>
                    &quot;BGT&quot;,
                    new GeoServiceLayerSettings()
<span class="nc" id="L350">                        .addAuthorizationRulesItem(new AuthorizationRule()</span>
<span class="nc" id="L351">                            .groupName(&quot;test-foo&quot;)</span>
<span class="nc" id="L352">                            .decisions(Map.of(</span>
                                ACCESS_TYPE_READ, AuthorizationRuleDecision.DENY)))
<span class="nc" id="L354">                        .addAuthorizationRulesItem(new AuthorizationRule()</span>
<span class="nc" id="L355">                            .groupName(&quot;test-baz&quot;)</span>
<span class="nc" id="L356">                            .decisions(Map.of(</span>
                                ACCESS_TYPE_READ, AuthorizationRuleDecision.ALLOW))))))
<span class="nc" id="L358">            .setPublished(true),</span>
        new GeoService()
<span class="nc" id="L360">            .setId(&quot;snapshot-geoserver-proxied&quot;)</span>
<span class="nc" id="L361">            .setProtocol(WMS)</span>
<span class="nc" id="L362">            .setTitle(&quot;Test GeoServer (proxied)&quot;)</span>
<span class="nc" id="L363">            .setUrl(&quot;https://snapshot.tailormap.nl/geoserver/wms&quot;)</span>
<span class="nc" id="L364">            .setAuthorizationRules(ruleAnonymousRead)</span>
<span class="nc" id="L365">            .setSettings(new GeoServiceSettings().useProxy(true)),</span>
        new GeoService()
<span class="nc" id="L367">            .setId(&quot;openbasiskaart&quot;)</span>
<span class="nc" id="L368">            .setProtocol(WMTS)</span>
<span class="nc" id="L369">            .setTitle(&quot;Openbasiskaart&quot;)</span>
<span class="nc" id="L370">            .setUrl(&quot;https://www.openbasiskaart.nl/mapcache/wmts&quot;)</span>
<span class="nc" id="L371">            .setAuthorizationRules(ruleAnonymousRead)</span>
<span class="nc" id="L372">            .setSettings(new GeoServiceSettings()</span>
<span class="nc" id="L373">                .defaultLayerSettings(new GeoServiceDefaultLayerSettings().attribution(osmAttribution))</span>
<span class="nc" id="L374">                .layerSettings(Map.of(</span>
                    &quot;osm&quot;,
                    new GeoServiceLayerSettings()
<span class="nc" id="L377">                        .title(&quot;Openbasiskaart&quot;)</span>
<span class="nc" id="L378">                        .hiDpiDisabled(false)</span>
<span class="nc" id="L379">                        .hiDpiMode(TileLayerHiDpiMode.SUBSTITUTELAYERSHOWNEXTZOOMLEVEL)</span>
<span class="nc" id="L380">                        .hiDpiSubstituteLayer(&quot;osm-hq&quot;)))),</span>
        new GeoService()
<span class="nc" id="L382">            .setId(&quot;openbasiskaart-proxied&quot;)</span>
<span class="nc" id="L383">            .setProtocol(WMTS)</span>
<span class="nc" id="L384">            .setTitle(&quot;Openbasiskaart (proxied)&quot;)</span>
<span class="nc" id="L385">            .setUrl(&quot;https://www.openbasiskaart.nl/mapcache/wmts&quot;)</span>
<span class="nc" id="L386">            .setAuthorizationRules(ruleAnonymousRead)</span>
            // The service actually doesn't require authentication, but also doesn't mind it
            // Just for testing
<span class="nc" id="L389">            .setAuthentication(new ServiceAuthentication()</span>
<span class="nc" id="L390">                .method(ServiceAuthentication.MethodEnum.PASSWORD)</span>
<span class="nc" id="L391">                .username(&quot;test&quot;)</span>
<span class="nc" id="L392">                .password(&quot;test&quot;))</span>
<span class="nc" id="L393">            .setSettings(new GeoServiceSettings()</span>
<span class="nc" id="L394">                .useProxy(true)</span>
<span class="nc" id="L395">                .defaultLayerSettings(new GeoServiceDefaultLayerSettings().attribution(osmAttribution))</span>
<span class="nc" id="L396">                .layerSettings(Map.of(</span>
                    &quot;osm&quot;,
                    new GeoServiceLayerSettings()
<span class="nc" id="L399">                        .hiDpiDisabled(false)</span>
<span class="nc" id="L400">                        .hiDpiMode(TileLayerHiDpiMode.SUBSTITUTELAYERSHOWNEXTZOOMLEVEL)</span>
<span class="nc" id="L401">                        .hiDpiSubstituteLayer(&quot;osm-hq&quot;)))),</span>
        new GeoService()
<span class="nc" id="L403">            .setId(&quot;openbasiskaart-tms&quot;)</span>
<span class="nc" id="L404">            .setProtocol(XYZ)</span>
<span class="nc" id="L405">            .setTitle(&quot;Openbasiskaart (TMS)&quot;)</span>
<span class="nc" id="L406">            .setUrl(&quot;https://openbasiskaart.nl/mapcache/tms/1.0.0/osm@rd/{z}/{x}/{-y}.png&quot;)</span>
<span class="nc" id="L407">            .setAuthorizationRules(ruleAnonymousRead)</span>
<span class="nc" id="L408">            .setSettings(</span>
                new GeoServiceSettings()
<span class="nc" id="L410">                    .xyzCrs(&quot;EPSG:28992&quot;)</span>
<span class="nc" id="L411">                    .defaultLayerSettings(</span>
<span class="nc" id="L412">                        new GeoServiceDefaultLayerSettings().attribution(osmAttribution))</span>
<span class="nc" id="L413">                    .layerSettings(</span>
<span class="nc" id="L414">                        Map.of(</span>
                            &quot;xyz&quot;,
                            new GeoServiceLayerSettings()
<span class="nc" id="L417">                                .maxZoom(15)</span>
<span class="nc" id="L418">                                .tileGridExtent(rdTileGridExtent)</span>
<span class="nc" id="L419">                                .hiDpiDisabled(false)</span>
<span class="nc" id="L420">                                .hiDpiMode(</span>
                                    TileLayerHiDpiMode
                                        .SUBSTITUTELAYERTILEPIXELRATIOONLY)
<span class="nc" id="L423">                                .hiDpiSubstituteLayer(</span>
                                    &quot;https://openbasiskaart.nl/mapcache/tms/1.0.0/osm-hq@rd-hq/{z}/{x}/{-y}.png&quot;)))),
        new GeoService()
<span class="nc" id="L426">            .setId(&quot;pdok-hwh-luchtfotorgb&quot;)</span>
<span class="nc" id="L427">            .setProtocol(WMTS)</span>
<span class="nc" id="L428">            .setTitle(&quot;PDOK HWH luchtfoto&quot;)</span>
<span class="nc" id="L429">            .setUrl(&quot;https://service.pdok.nl/hwh/luchtfotorgb/wmts/v1_0&quot;)</span>
<span class="nc" id="L430">            .setAuthorizationRules(ruleAnonymousRead)</span>
<span class="nc" id="L431">            .setPublished(true)</span>
<span class="nc" id="L432">            .setSettings(new GeoServiceSettings()</span>
<span class="nc" id="L433">                .defaultLayerSettings(new GeoServiceDefaultLayerSettings()</span>
<span class="nc" id="L434">                    .attribution(&quot;© [Beeldmateriaal.nl](https://beeldmateriaal.nl)&quot;)</span>
<span class="nc" id="L435">                    .hiDpiDisabled(false))</span>
<span class="nc" id="L436">                .putLayerSettingsItem(</span>
<span class="nc" id="L437">                    &quot;Actueel_orthoHR&quot;, new GeoServiceLayerSettings().title(&quot;Luchtfoto&quot;))),</span>
        new GeoService()
<span class="nc" id="L439">            .setId(&quot;b3p-mapproxy-luchtfoto&quot;)</span>
<span class="nc" id="L440">            .setProtocol(XYZ)</span>
<span class="nc" id="L441">            .setTitle(&quot;Luchtfoto (TMS)&quot;)</span>
<span class="nc" id="L442">            .setUrl(&quot;https://mapproxy.b3p.nl/tms/1.0.0/luchtfoto/EPSG28992/{z}/{x}/{-y}.jpeg&quot;)</span>
<span class="nc" id="L443">            .setAuthorizationRules(ruleAnonymousRead)</span>
<span class="nc" id="L444">            .setPublished(true)</span>
<span class="nc" id="L445">            .setSettings(new GeoServiceSettings()</span>
<span class="nc" id="L446">                .xyzCrs(&quot;EPSG:28992&quot;)</span>
<span class="nc" id="L447">                .defaultLayerSettings(new GeoServiceDefaultLayerSettings()</span>
<span class="nc" id="L448">                    .attribution(&quot;© [Beeldmateriaal.nl](https://beeldmateriaal.nl)&quot;)</span>
<span class="nc" id="L449">                    .hiDpiDisabled(false))</span>
<span class="nc" id="L450">                .layerSettings(Map.of(</span>
                    &quot;xyz&quot;,
                    new GeoServiceLayerSettings()
<span class="nc" id="L453">                        .maxZoom(14)</span>
<span class="nc" id="L454">                        .tileGridExtent(rdTileGridExtent)</span>
<span class="nc" id="L455">                        .hiDpiMode(TileLayerHiDpiMode.SHOWNEXTZOOMLEVEL)))),</span>
        new GeoService()
<span class="nc" id="L457">            .setId(&quot;at-basemap&quot;)</span>
<span class="nc" id="L458">            .setProtocol(WMTS)</span>
<span class="nc" id="L459">            .setTitle(&quot;basemap.at&quot;)</span>
<span class="nc" id="L460">            .setUrl(&quot;https://mapsneu.wien.gv.at/basemapneu/1.0.0/WMTSCapabilities.xml&quot;)</span>
<span class="nc" id="L461">            .setAuthorizationRules(ruleAnonymousRead)</span>
<span class="nc" id="L462">            .setPublished(true)</span>
<span class="nc" id="L463">            .setSettings(new GeoServiceSettings()</span>
<span class="nc" id="L464">                .defaultLayerSettings(new GeoServiceDefaultLayerSettings()</span>
<span class="nc" id="L465">                    .attribution(&quot;© [basemap.at](https://basemap.at)&quot;)</span>
<span class="nc" id="L466">                    .hiDpiDisabled(true))</span>
<span class="nc" id="L467">                .layerSettings(Map.of(</span>
                    &quot;geolandbasemap&quot;,
                    new GeoServiceLayerSettings()
<span class="nc" id="L470">                        .title(&quot;Basemap&quot;)</span>
<span class="nc" id="L471">                        .hiDpiDisabled(false)</span>
<span class="nc" id="L472">                        .hiDpiMode(TileLayerHiDpiMode.SUBSTITUTELAYERTILEPIXELRATIOONLY)</span>
<span class="nc" id="L473">                        .hiDpiSubstituteLayer(&quot;bmaphidpi&quot;),</span>
                    &quot;bmaporthofoto30cm&quot;,
                    new GeoServiceLayerSettings()
<span class="nc" id="L476">                        .title(&quot;Orthophoto&quot;)</span>
<span class="nc" id="L477">                        .hiDpiDisabled(false)))),</span>
        new GeoService()
<span class="nc" id="L479">            .setId(&quot;pdok-kadaster-bestuurlijkegebieden&quot;)</span>
<span class="nc" id="L480">            .setProtocol(WMS)</span>
<span class="nc" id="L481">            .setUrl(&quot;https://service.pdok.nl/kadaster/bestuurlijkegebieden/wms/v1_0?service=WMS&quot;)</span>
<span class="nc" id="L482">            .setAuthorizationRules(ruleAnonymousRead)</span>
<span class="nc" id="L483">            .setSettings(new GeoServiceSettings()</span>
<span class="nc" id="L484">                .defaultLayerSettings(new GeoServiceDefaultLayerSettings()</span>
<span class="nc" id="L485">                    .description(&quot;This layer shows an administrative boundary.&quot;))</span>
                // No attribution required: service is CC0
<span class="nc" id="L487">                .serverType(GeoServiceSettings.ServerTypeEnum.MAPSERVER)</span>
<span class="nc" id="L488">                .useProxy(true)</span>
<span class="nc" id="L489">                .putLayerSettingsItem(</span>
                    &quot;Gemeentegebied&quot;,
                    new GeoServiceLayerSettings()
<span class="nc" id="L492">                        .legendImageId(legend.getId().toString())))</span>
<span class="nc" id="L493">            .setPublished(true)</span>
<span class="nc" id="L494">            .setTitle(&quot;PDOK Kadaster bestuurlijke gebieden&quot;),</span>
        new GeoService()
<span class="nc" id="L496">            .setId(&quot;bestuurlijkegebieden-proxied&quot;)</span>
<span class="nc" id="L497">            .setProtocol(WMS)</span>
<span class="nc" id="L498">            .setUrl(&quot;https://service.pdok.nl/kadaster/bestuurlijkegebieden/wms/v1_0?service=WMS&quot;)</span>
<span class="nc" id="L499">            .setAuthorizationRules(ruleAnonymousRead)</span>
            // The service actually doesn't require authentication, but also doesn't mind it
            // Just for testing that proxied services with auth are not available in public
            // apps (even when logged in), in any controllers (map, proxy, features)
<span class="nc" id="L503">            .setAuthentication(new ServiceAuthentication()</span>
<span class="nc" id="L504">                .method(ServiceAuthentication.MethodEnum.PASSWORD)</span>
<span class="nc" id="L505">                .username(&quot;test&quot;)</span>
<span class="nc" id="L506">                .password(&quot;test&quot;))</span>
<span class="nc" id="L507">            .setSettings(new GeoServiceSettings()</span>
                // No attribution required: service is CC0
<span class="nc" id="L509">                .serverType(GeoServiceSettings.ServerTypeEnum.MAPSERVER)</span>
<span class="nc" id="L510">                .useProxy(true))</span>
<span class="nc" id="L511">            .setPublished(true)</span>
<span class="nc" id="L512">            .setTitle(&quot;Bestuurlijke gebieden (proxied met auth)&quot;),</span>
        new GeoService()
<span class="nc" id="L514">            .setId(&quot;3dbag_utrecht&quot;)</span>
<span class="nc" id="L515">            .setProtocol(TILES3D)</span>
<span class="nc" id="L516">            .setUrl(&quot;https://3dtilesnederland.nl/tiles/1.0/implicit/nederland/344.json&quot;)</span>
<span class="nc" id="L517">            .setTitle(&quot;3D BAG Utrecht&quot;)</span>
<span class="nc" id="L518">            .setPublished(true)</span>
<span class="nc" id="L519">            .setAuthorizationRules(ruleAnonymousRead),</span>
        new GeoService()
<span class="nc" id="L521">            .setId(&quot;ahn_terrain_model&quot;)</span>
<span class="nc" id="L522">            .setProtocol(QUANTIZEDMESH)</span>
<span class="nc" id="L523">            .setUrl(</span>
                &quot;https://api.pdok.nl/kadaster/3d-basisvoorziening/ogc/v1/collections/digitaalterreinmodel&quot;)
<span class="nc" id="L525">            .setTitle(&quot;AHN Terrain Model&quot;)</span>
<span class="nc" id="L526">            .setPublished(true)</span>
<span class="nc" id="L527">            .setAuthorizationRules(ruleAnonymousRead)</span>
        // TODO MapServer WMS &quot;https://wms.geonorge.no/skwms1/wms.adm_enheter_historisk&quot;
        );

<span class="nc bnc" id="L531" title="All 2 branches missed.">    if (map5url != null) {</span>
<span class="nc" id="L532">      GeoServiceLayerSettings osmAttr = new GeoServiceLayerSettings().attribution(osmAttribution);</span>
<span class="nc" id="L533">      GeoServiceLayerSettings map5Attr = new GeoServiceLayerSettings()</span>
<span class="nc" id="L534">          .attribution(&quot;Kaarten: [Map5.nl](https://map5.nl), data: &quot; + osmAttribution);</span>
<span class="nc" id="L535">      services = new ArrayList&lt;&gt;(services);</span>
<span class="nc" id="L536">      services.add(new GeoService()</span>
<span class="nc" id="L537">          .setId(&quot;map5&quot;)</span>
<span class="nc" id="L538">          .setProtocol(WMTS)</span>
<span class="nc" id="L539">          .setTitle(&quot;Map5&quot;)</span>
<span class="nc" id="L540">          .setUrl(map5url)</span>
<span class="nc" id="L541">          .setAuthorizationRules(ruleAnonymousRead)</span>
<span class="nc" id="L542">          .setSettings(new GeoServiceSettings()</span>
<span class="nc" id="L543">              .defaultLayerSettings(new GeoServiceDefaultLayerSettings().hiDpiDisabled(true))</span>
<span class="nc" id="L544">              .layerSettings(Map.of(</span>
                  &quot;openlufo&quot;,
                  new GeoServiceLayerSettings()
<span class="nc" id="L547">                      .attribution(&quot;© [Beeldmateriaal.nl](https://beeldmateriaal.nl), &quot;</span>
                          + osmAttribution),
                  &quot;luforoadslabels&quot;,
                  osmAttr,
                  &quot;map5topo&quot;,
                  new GeoServiceLayerSettings()
<span class="nc" id="L553">                      .attribution(map5Attr.getAttribution())</span>
<span class="nc" id="L554">                      .hiDpiDisabled(false)</span>
<span class="nc" id="L555">                      .hiDpiMode(TileLayerHiDpiMode.SUBSTITUTELAYERSHOWNEXTZOOMLEVEL)</span>
<span class="nc" id="L556">                      .hiDpiSubstituteLayer(&quot;map5topo_hq&quot;),</span>
                  &quot;map5topo_gray&quot;,
                  map5Attr,
                  &quot;map5topo_simple&quot;,
                  map5Attr,
                  &quot;map5topo_simple_gray&quot;,
                  map5Attr,
                  &quot;opensimpletopo&quot;,
                  osmAttr,
                  &quot;opensimpletopo_gray&quot;,
                  osmAttr,
                  &quot;opentopo&quot;,
                  osmAttr,
                  &quot;opentopo_gray&quot;,
                  osmAttr))));
    }

<span class="nc bnc" id="L573" title="All 2 branches missed.">    for (GeoService geoService : services) {</span>
<span class="nc" id="L574">      geoServiceHelper.loadServiceCapabilities(geoService);</span>

<span class="nc" id="L576">      geoServiceRepository.save(geoService);</span>
<span class="nc" id="L577">      catalogNode.addItemsItem(new TailormapObjectRef()</span>
<span class="nc" id="L578">          .kind(TailormapObjectRef.KindEnum.GEO_SERVICE)</span>
<span class="nc" id="L579">          .id(geoService.getId()));</span>
<span class="nc" id="L580">    }</span>

<span class="nc" id="L582">    CatalogNode wfsFeatureSourceCatalogNode =</span>
<span class="nc" id="L583">        new CatalogNode().id(&quot;wfs_feature_sources&quot;).title(&quot;WFS feature sources&quot;);</span>
<span class="nc" id="L584">    rootCatalogNode.addChildrenItem(wfsFeatureSourceCatalogNode.getId());</span>
<span class="nc" id="L585">    catalog.getNodes().add(wfsFeatureSourceCatalogNode);</span>

<span class="nc bnc" id="L587" title="All 2 branches missed.">    services.stream().filter(s -&gt; s.getProtocol() == WMS).forEach(s -&gt; {</span>
<span class="nc" id="L588">      geoServiceHelper.findAndSaveRelatedWFS(s);</span>
<span class="nc" id="L589">      List&lt;TMFeatureSource&gt; linkedSources = featureSourceRepository.findByLinkedServiceId(s.getId());</span>
<span class="nc bnc" id="L590" title="All 2 branches missed.">      for (TMFeatureSource linkedSource : linkedSources) {</span>
<span class="nc" id="L591">        wfsFeatureSourceCatalogNode.addItemsItem(new TailormapObjectRef()</span>
<span class="nc" id="L592">            .kind(TailormapObjectRef.KindEnum.FEATURE_SOURCE)</span>
<span class="nc" id="L593">            .id(linkedSource.getId().toString()));</span>
<span class="nc" id="L594">      }</span>
<span class="nc" id="L595">    });</span>

<span class="nc" id="L597">    String geodataPassword = &quot;980f1c8A-25933b2&quot;;</span>

<span class="nc" id="L599">    Map&lt;String, TMFeatureSource&gt; featureSources = Map.of(</span>
        &quot;postgis&quot;,
        new TMFeatureSource()
<span class="nc" id="L602">            .setProtocol(TMFeatureSource.Protocol.JDBC)</span>
<span class="nc" id="L603">            .setTitle(&quot;PostGIS&quot;)</span>
<span class="nc" id="L604">            .setJdbcConnection(new JDBCConnectionProperties()</span>
<span class="nc" id="L605">                .dbtype(JDBCConnectionProperties.DbtypeEnum.POSTGIS)</span>
<span class="nc bnc" id="L606" title="All 2 branches missed.">                .host(connectToSpatialDbsAtLocalhost ? &quot;127.0.0.1&quot; : &quot;postgis&quot;)</span>
<span class="nc bnc" id="L607" title="All 2 branches missed.">                .port(connectToSpatialDbsAtLocalhost ? 54322 : 5432)</span>
<span class="nc" id="L608">                .database(&quot;geodata&quot;)</span>
<span class="nc" id="L609">                .schema(&quot;public&quot;)</span>
<span class="nc" id="L610">                .additionalProperties(Map.of(&quot;connectionOptions&quot;, &quot;?ApplicationName=tailormap-api&quot;)))</span>
<span class="nc" id="L611">            .setAuthentication(new ServiceAuthentication()</span>
<span class="nc" id="L612">                .method(ServiceAuthentication.MethodEnum.PASSWORD)</span>
<span class="nc" id="L613">                .username(&quot;geodata&quot;)</span>
<span class="nc" id="L614">                .password(geodataPassword)),</span>
        &quot;postgis_osm&quot;,
        new TMFeatureSource()
<span class="nc" id="L617">            .setProtocol(TMFeatureSource.Protocol.JDBC)</span>
<span class="nc" id="L618">            .setTitle(&quot;PostGIS OSM&quot;)</span>
<span class="nc" id="L619">            .setJdbcConnection(new JDBCConnectionProperties()</span>
<span class="nc" id="L620">                .dbtype(JDBCConnectionProperties.DbtypeEnum.POSTGIS)</span>
<span class="nc bnc" id="L621" title="All 2 branches missed.">                .host(connectToSpatialDbsAtLocalhost ? &quot;127.0.0.1&quot; : &quot;postgis&quot;)</span>
<span class="nc bnc" id="L622" title="All 2 branches missed.">                .port(connectToSpatialDbsAtLocalhost ? 54322 : 5432)</span>
<span class="nc" id="L623">                .database(&quot;geodata&quot;)</span>
<span class="nc" id="L624">                .schema(&quot;osm&quot;)</span>
<span class="nc" id="L625">                .additionalProperties(Map.of(&quot;connectionOptions&quot;, &quot;?ApplicationName=tailormap-api&quot;)))</span>
<span class="nc" id="L626">            .setAuthentication(new ServiceAuthentication()</span>
<span class="nc" id="L627">                .method(ServiceAuthentication.MethodEnum.PASSWORD)</span>
<span class="nc" id="L628">                .username(&quot;geodata&quot;)</span>
<span class="nc" id="L629">                .password(geodataPassword)),</span>
        &quot;oracle&quot;,
        new TMFeatureSource()
<span class="nc" id="L632">            .setProtocol(TMFeatureSource.Protocol.JDBC)</span>
<span class="nc" id="L633">            .setTitle(&quot;Oracle&quot;)</span>
<span class="nc" id="L634">            .setJdbcConnection(new JDBCConnectionProperties()</span>
<span class="nc" id="L635">                .dbtype(JDBCConnectionProperties.DbtypeEnum.ORACLE)</span>
<span class="nc bnc" id="L636" title="All 2 branches missed.">                .host(connectToSpatialDbsAtLocalhost ? &quot;127.0.0.1&quot; : &quot;oracle&quot;)</span>
<span class="nc" id="L637">                .database(&quot;/FREEPDB1&quot;)</span>
<span class="nc" id="L638">                .schema(&quot;GEODATA&quot;)</span>
<span class="nc" id="L639">                .additionalProperties(Map.of(&quot;connectionOptions&quot;, &quot;?oracle.jdbc.J2EE13Compliant=true&quot;)))</span>
<span class="nc" id="L640">            .setAuthentication(new ServiceAuthentication()</span>
<span class="nc" id="L641">                .method(ServiceAuthentication.MethodEnum.PASSWORD)</span>
<span class="nc" id="L642">                .username(&quot;geodata&quot;)</span>
<span class="nc" id="L643">                .password(geodataPassword)),</span>
        &quot;sqlserver&quot;,
        new TMFeatureSource()
<span class="nc" id="L646">            .setProtocol(TMFeatureSource.Protocol.JDBC)</span>
<span class="nc" id="L647">            .setTitle(&quot;MS SQL Server&quot;)</span>
<span class="nc" id="L648">            .setJdbcConnection(new JDBCConnectionProperties()</span>
<span class="nc" id="L649">                .dbtype(JDBCConnectionProperties.DbtypeEnum.SQLSERVER)</span>
<span class="nc bnc" id="L650" title="All 2 branches missed.">                .host(connectToSpatialDbsAtLocalhost ? &quot;127.0.0.1&quot; : &quot;sqlserver&quot;)</span>
<span class="nc" id="L651">                .database(&quot;geodata&quot;)</span>
<span class="nc" id="L652">                .schema(&quot;dbo&quot;)</span>
<span class="nc" id="L653">                .additionalProperties(Map.of(&quot;connectionOptions&quot;, &quot;;encrypt=false&quot;)))</span>
<span class="nc" id="L654">            .setAuthentication(new ServiceAuthentication()</span>
<span class="nc" id="L655">                .method(ServiceAuthentication.MethodEnum.PASSWORD)</span>
<span class="nc" id="L656">                .username(&quot;geodata&quot;)</span>
<span class="nc" id="L657">                .password(geodataPassword)),</span>
        &quot;pdok-kadaster-bestuurlijkegebieden&quot;,
        new TMFeatureSource()
<span class="nc" id="L660">            .setProtocol(TMFeatureSource.Protocol.WFS)</span>
<span class="nc" id="L661">            .setUrl(</span>
                &quot;https://service.pdok.nl/kadaster/bestuurlijkegebieden/wfs/v1_0?service=WFS&amp;VERSION=2.0.0&quot;)
<span class="nc" id="L663">            .setTitle(&quot;Bestuurlijke gebieden&quot;)</span>
<span class="nc" id="L664">            .setNotes(</span>
                &quot;Overzicht van de bestuurlijke indeling van Nederland in gemeenten en provincies alsmede de rijksgrens. Gegevens zijn afgeleid uit de Basisregistratie Kadaster (BRK).&quot;));
<span class="nc" id="L666">    featureSourceRepository.saveAll(featureSources.values());</span>

<span class="nc" id="L668">    new WFSFeatureSourceHelper().loadCapabilities(featureSources.get(&quot;pdok-kadaster-bestuurlijkegebieden&quot;));</span>
<span class="nc" id="L669">    geoServiceRepository.findById(&quot;pdok-kadaster-bestuurlijkegebieden&quot;).ifPresent(geoService -&gt; {</span>
<span class="nc" id="L670">      geoService</span>
<span class="nc" id="L671">          .getSettings()</span>
<span class="nc" id="L672">          .getLayerSettings()</span>
<span class="nc" id="L673">          .put(</span>
              &quot;Provinciegebied&quot;,
              new GeoServiceLayerSettings()
<span class="nc" id="L676">                  .description(&quot;The administrative boundary of Dutch Provinces, connected to a WFS.&quot;)</span>
<span class="nc" id="L677">                  .featureType(new FeatureTypeRef()</span>
<span class="nc" id="L678">                      .featureSourceId(featureSources</span>
<span class="nc" id="L679">                          .get(&quot;pdok-kadaster-bestuurlijkegebieden&quot;)</span>
<span class="nc" id="L680">                          .getId())</span>
<span class="nc" id="L681">                      .featureTypeName(&quot;bestuurlijkegebieden:Provinciegebied&quot;))</span>
<span class="nc" id="L682">                  .title(&quot;Provinciegebied (WFS)&quot;));</span>
<span class="nc" id="L683">      geoServiceRepository.save(geoService);</span>
<span class="nc" id="L684">    });</span>

<span class="nc" id="L686">    geoServiceRepository.findById(&quot;bestuurlijkegebieden-proxied&quot;).ifPresent(geoService -&gt; {</span>
<span class="nc" id="L687">      geoService</span>
<span class="nc" id="L688">          .getSettings()</span>
<span class="nc" id="L689">          .getLayerSettings()</span>
<span class="nc" id="L690">          .put(</span>
              &quot;Provinciegebied&quot;,
              new GeoServiceLayerSettings()
<span class="nc" id="L693">                  .featureType(new FeatureTypeRef()</span>
<span class="nc" id="L694">                      .featureSourceId(featureSources</span>
<span class="nc" id="L695">                          .get(&quot;pdok-kadaster-bestuurlijkegebieden&quot;)</span>
<span class="nc" id="L696">                          .getId())</span>
<span class="nc" id="L697">                      .featureTypeName(&quot;bestuurlijkegebieden:Provinciegebied&quot;))</span>
<span class="nc" id="L698">                  .title(&quot;Provinciegebied (WFS, proxied met auth)&quot;));</span>
<span class="nc" id="L699">      geoServiceRepository.save(geoService);</span>
<span class="nc" id="L700">    });</span>

<span class="nc" id="L702">    CatalogNode featureSourceCatalogNode =</span>
<span class="nc" id="L703">        new CatalogNode().id(&quot;feature_sources&quot;).title(&quot;Test feature sources&quot;);</span>
<span class="nc" id="L704">    rootCatalogNode.addChildrenItem(featureSourceCatalogNode.getId());</span>
<span class="nc" id="L705">    catalog.getNodes().add(featureSourceCatalogNode);</span>

<span class="nc bnc" id="L707" title="All 2 branches missed.">    for (TMFeatureSource featureSource : featureSources.values()) {</span>
<span class="nc" id="L708">      featureSourceCatalogNode.addItemsItem(new TailormapObjectRef()</span>
<span class="nc" id="L709">          .kind(TailormapObjectRef.KindEnum.FEATURE_SOURCE)</span>
<span class="nc" id="L710">          .id(featureSource.getId().toString()));</span>
<span class="nc" id="L711">    }</span>
<span class="nc" id="L712">    catalogRepository.save(catalog);</span>

<span class="nc bnc" id="L714" title="All 2 branches missed.">    if (connectToSpatialDbs) {</span>
<span class="nc" id="L715">      featureSources.values().forEach(fs -&gt; {</span>
        try {
<span class="nc bnc" id="L717" title="All 2 branches missed.">          if (fs.getProtocol() == TMFeatureSource.Protocol.JDBC) {</span>
<span class="nc" id="L718">            new JDBCFeatureSourceHelper().loadCapabilities(fs);</span>
<span class="nc bnc" id="L719" title="All 2 branches missed.">          } else if (fs.getProtocol() == TMFeatureSource.Protocol.WFS) {</span>
<span class="nc" id="L720">            new WFSFeatureSourceHelper().loadCapabilities(fs);</span>
          }
<span class="nc" id="L722">        } catch (Exception e) {</span>
<span class="nc" id="L723">          logger.error(&quot;Error loading capabilities for feature source {}&quot;, fs.getTitle(), e);</span>
<span class="nc" id="L724">        }</span>
<span class="nc" id="L725">      });</span>

<span class="nc" id="L727">      services.stream()</span>
          // Set layer settings for both the proxied and non-proxied one, but don't overwrite the
          // authorization rules for the &quot;filtered-snapshot-geoserver&quot; service
<span class="nc" id="L730">          .filter(s -&gt; s.getId().startsWith(&quot;snapshot-geoserver&quot;))</span>
<span class="nc" id="L731">          .forEach(s -&gt; s.getSettings()</span>
<span class="nc" id="L732">              .layerSettings(Map.of(</span>
                  &quot;postgis:begroeidterreindeel&quot;,
                  new GeoServiceLayerSettings()
<span class="nc" id="L735">                      .description(</span>
                          &quot;&quot;&quot;
This layer shows data from https://www.postgis.net/

https://postgis.net/brand.svg&quot;&quot;&quot;)
<span class="nc" id="L740">                      .featureType(new FeatureTypeRef()</span>
<span class="nc" id="L741">                          .featureSourceId(featureSources</span>
<span class="nc" id="L742">                              .get(&quot;postgis&quot;)</span>
<span class="nc" id="L743">                              .getId())</span>
<span class="nc" id="L744">                          .featureTypeName(&quot;begroeidterreindeel&quot;)),</span>
                  &quot;postgis:bak&quot;,
                  new GeoServiceLayerSettings()
<span class="nc" id="L747">                      .featureType(new FeatureTypeRef()</span>
<span class="nc" id="L748">                          .featureSourceId(featureSources</span>
<span class="nc" id="L749">                              .get(&quot;postgis&quot;)</span>
<span class="nc" id="L750">                              .getId())</span>
<span class="nc" id="L751">                          .featureTypeName(&quot;bak&quot;)),</span>
                  &quot;postgis:kadastraal_perceel&quot;,
                  new GeoServiceLayerSettings()
<span class="nc" id="L754">                      .description(&quot;cadastral parcel label points&quot;)</span>
<span class="nc" id="L755">                      .featureType(new FeatureTypeRef()</span>
<span class="nc" id="L756">                          .featureSourceId(featureSources</span>
<span class="nc" id="L757">                              .get(&quot;postgis&quot;)</span>
<span class="nc" id="L758">                              .getId())</span>
<span class="nc" id="L759">                          .featureTypeName(&quot;kadastraal_perceel&quot;)),</span>
                  &quot;sqlserver:wegdeel&quot;,
                  new GeoServiceLayerSettings()
<span class="nc" id="L762">                      .attribution(</span>
                          &quot;CC BY 4.0 [BGT/Kadaster](https://www.nationaalgeoregister.nl/geonetwork/srv/api/records/2cb4769c-b56e-48fa-8685-c48f61b9a319)&quot;)
<span class="nc" id="L764">                      .description(</span>
                          &quot;&quot;&quot;
This layer shows data from [MS SQL Server](https://learn.microsoft.com/en-us/sql/relational-databases/spatial/spatial-data-sql-server).

https://social.technet.microsoft.com/wiki/cfs-filesystemfile.ashx/__key/communityserver-components-imagefileviewer/communityserver-wikis-components-files-00-00-00-00-05/1884.SQL_5F00_h_5F00_rgb.png_2D00_550x0.png&quot;&quot;&quot;)
<span class="nc" id="L769">                      .featureType(new FeatureTypeRef()</span>
<span class="nc" id="L770">                          .featureSourceId(featureSources</span>
<span class="nc" id="L771">                              .get(&quot;sqlserver&quot;)</span>
<span class="nc" id="L772">                              .getId())</span>
<span class="nc" id="L773">                          .featureTypeName(&quot;wegdeel&quot;)),</span>
                  &quot;oracle:WATERDEEL&quot;,
                  new GeoServiceLayerSettings()
<span class="nc" id="L776">                      .description(&quot;This layer shows data from Oracle Spatial.&quot;)</span>
<span class="nc" id="L777">                      .featureType(new FeatureTypeRef()</span>
<span class="nc" id="L778">                          .featureSourceId(featureSources</span>
<span class="nc" id="L779">                              .get(&quot;oracle&quot;)</span>
<span class="nc" id="L780">                              .getId())</span>
<span class="nc" id="L781">                          .featureTypeName(&quot;WATERDEEL&quot;)),</span>
                  &quot;postgis:osm_polygon&quot;,
                  new GeoServiceLayerSettings()
<span class="nc" id="L784">                      .description(&quot;This layer shows OSM data from postgis.&quot;)</span>
<span class="nc" id="L785">                      .featureType(new FeatureTypeRef()</span>
<span class="nc" id="L786">                          .featureSourceId(featureSources</span>
<span class="nc" id="L787">                              .get(&quot;postgis_osm&quot;)</span>
<span class="nc" id="L788">                              .getId())</span>
<span class="nc" id="L789">                          .featureTypeName(&quot;osm_polygon&quot;)))));</span>
    }

<span class="nc" id="L792">    featureSources.get(&quot;pdok-kadaster-bestuurlijkegebieden&quot;).getFeatureTypes().stream()</span>
<span class="nc" id="L793">        .filter(ft -&gt; ft.getName().equals(&quot;bestuurlijkegebieden:Provinciegebied&quot;))</span>
<span class="nc" id="L794">        .findFirst()</span>
<span class="nc" id="L795">        .ifPresent(ft -&gt; {</span>
<span class="nc" id="L796">          ft.getSettings().addHideAttributesItem(&quot;identificatie&quot;);</span>
<span class="nc" id="L797">          ft.getSettings().addHideAttributesItem(&quot;ligtInLandCode&quot;);</span>
<span class="nc" id="L798">          ft.getSettings().addHideAttributesItem(&quot;fuuid&quot;);</span>
<span class="nc" id="L799">          ft.getSettings().putAttributeSettingsItem(&quot;naam&quot;, new AttributeSettings().title(&quot;Naam&quot;));</span>
<span class="nc" id="L800">          ft.getSettings()</span>
<span class="nc" id="L801">              .setTemplate(</span>
                  new FeatureTypeTemplate()
<span class="nc" id="L803">                      .templateLanguage(&quot;simple&quot;)</span>
<span class="nc" id="L804">                      .markupLanguage(&quot;markdown&quot;)</span>
<span class="nc" id="L805">                      .template(</span>
                          &quot;&quot;&quot;
### Provincie
Deze provincie heet **{{naam}}** en ligt in _{{ligtInLandNaam}}_.

| Attribuut | Waarde             |
| --------- | ------------------ |
| `code`    | {{code}}           |
| `naam`    | {{naam}}           |
| `ligt in` | {{ligtInLandNaam}} |&quot;&quot;&quot;));
<span class="nc" id="L815">        });</span>

<span class="nc" id="L817">    featureSources.get(&quot;postgis&quot;).getFeatureTypes().stream()</span>
<span class="nc" id="L818">        .filter(ft -&gt; ft.getName().equals(&quot;begroeidterreindeel&quot;))</span>
<span class="nc" id="L819">        .findFirst()</span>
<span class="nc" id="L820">        .ifPresent(ft -&gt; {</span>
<span class="nc" id="L821">          ft.getSettings().addHideAttributesItem(&quot;terminationdate&quot;);</span>
<span class="nc" id="L822">          ft.getSettings().addHideAttributesItem(&quot;geom_kruinlijn&quot;);</span>
<span class="nc" id="L823">          ft.getSettings().putAttributeSettingsItem(&quot;gmlid&quot;, new AttributeSettings().title(&quot;GML ID&quot;));</span>
<span class="nc" id="L824">          ft.getSettings()</span>
<span class="nc" id="L825">              .putAttributeSettingsItem(&quot;identificatie&quot;, new AttributeSettings().title(&quot;Identificatie&quot;));</span>
<span class="nc" id="L826">          ft.getSettings()</span>
<span class="nc" id="L827">              .putAttributeSettingsItem(</span>
<span class="nc" id="L828">                  &quot;tijdstipregistratie&quot;, new AttributeSettings().title(&quot;Registratie&quot;));</span>
<span class="nc" id="L829">          ft.getSettings()</span>
<span class="nc" id="L830">              .putAttributeSettingsItem(</span>
<span class="nc" id="L831">                  &quot;eindregistratie&quot;, new AttributeSettings().title(&quot;Eind registratie&quot;));</span>
<span class="nc" id="L832">          ft.getSettings().putAttributeSettingsItem(&quot;class&quot;, new AttributeSettings().title(&quot;Klasse&quot;));</span>
<span class="nc" id="L833">          ft.getSettings()</span>
<span class="nc" id="L834">              .putAttributeSettingsItem(&quot;bronhouder&quot;, new AttributeSettings().title(&quot;Bronhouder&quot;));</span>
<span class="nc" id="L835">          ft.getSettings()</span>
<span class="nc" id="L836">              .putAttributeSettingsItem(&quot;inonderzoek&quot;, new AttributeSettings().title(&quot;In onderzoek&quot;));</span>
<span class="nc" id="L837">          ft.getSettings()</span>
<span class="nc" id="L838">              .putAttributeSettingsItem(</span>
<span class="nc" id="L839">                  &quot;relatievehoogteligging&quot;, new AttributeSettings().title(&quot;Relatieve hoogteligging&quot;));</span>
<span class="nc" id="L840">          ft.getSettings()</span>
<span class="nc" id="L841">              .putAttributeSettingsItem(&quot;bgt_status&quot;, new AttributeSettings().title(&quot;BGT status&quot;));</span>
<span class="nc" id="L842">          ft.getSettings()</span>
<span class="nc" id="L843">              .putAttributeSettingsItem(&quot;plus_status&quot;, new AttributeSettings().title(&quot;Plus-status&quot;));</span>
<span class="nc" id="L844">          ft.getSettings()</span>
<span class="nc" id="L845">              .putAttributeSettingsItem(</span>
<span class="nc" id="L846">                  &quot;plus_fysiekvoorkomen&quot;, new AttributeSettings().title(&quot;Plus-fysiek voorkomen&quot;));</span>
<span class="nc" id="L847">          ft.getSettings()</span>
<span class="nc" id="L848">              .putAttributeSettingsItem(</span>
<span class="nc" id="L849">                  &quot;begroeidterreindeeloptalud&quot;, new AttributeSettings().title(&quot;Op talud&quot;));</span>
<span class="nc" id="L850">          ft.getSettings().addAttributeOrderItem(&quot;identificatie&quot;);</span>
<span class="nc" id="L851">          ft.getSettings().addAttributeOrderItem(&quot;bronhouder&quot;);</span>
<span class="nc" id="L852">          ft.getSettings().addAttributeOrderItem(&quot;class&quot;);</span>
<span class="nc" id="L853">        });</span>

<span class="nc" id="L855">    featureSources.get(&quot;postgis&quot;).getFeatureTypes().stream()</span>
<span class="nc" id="L856">        .filter(ft -&gt; ft.getName().equals(&quot;bak&quot;))</span>
<span class="nc" id="L857">        .findFirst()</span>
<span class="nc" id="L858">        .ifPresent(ft -&gt; {</span>
<span class="nc" id="L859">          ft.getSettings().addHideAttributesItem(&quot;gmlid&quot;);</span>
<span class="nc" id="L860">          ft.getSettings().addHideAttributesItem(&quot;lv_publicatiedatum&quot;);</span>
<span class="nc" id="L861">          ft.getSettings().addHideAttributesItem(&quot;creationdate&quot;);</span>
<span class="nc" id="L862">          ft.getSettings().addHideAttributesItem(&quot;tijdstipregistratie&quot;);</span>
<span class="nc" id="L863">          ft.getSettings().addHideAttributesItem(&quot;eindregistratie&quot;);</span>
<span class="nc" id="L864">          ft.getSettings().addHideAttributesItem(&quot;terminationdate&quot;);</span>
<span class="nc" id="L865">          ft.getSettings().addHideAttributesItem(&quot;inonderzoek&quot;);</span>
<span class="nc" id="L866">          ft.getSettings().addHideAttributesItem(&quot;relatievehoogteligging&quot;);</span>
<span class="nc" id="L867">          ft.getSettings().addHideAttributesItem(&quot;bgt_status&quot;);</span>
<span class="nc" id="L868">          ft.getSettings().addHideAttributesItem(&quot;plus_status&quot;);</span>
<span class="nc" id="L869">          ft.getSettings().addHideAttributesItem(&quot;function_&quot;);</span>
<span class="nc" id="L870">          ft.getSettings().addHideAttributesItem(&quot;plus_type&quot;);</span>
<span class="nc" id="L871">        });</span>

<span class="nc" id="L873">    featureSources.get(&quot;postgis&quot;).getFeatureTypes().stream()</span>
<span class="nc" id="L874">        .filter(ft -&gt; ft.getName().equals(&quot;kadastraal_perceel&quot;))</span>
<span class="nc" id="L875">        .findFirst()</span>
<span class="nc" id="L876">        .ifPresent(ft -&gt; ft.getSettings().addHideAttributesItem(&quot;gml_id&quot;));</span>
<span class="nc" id="L877">  }</span>

  public void createAppTestData() throws Exception {
<span class="nc" id="L880">    Upload logo = new Upload()</span>
<span class="nc" id="L881">        .setCategory(Upload.CATEGORY_APP_LOGO)</span>
<span class="nc" id="L882">        .setFilename(&quot;gradient.svg&quot;)</span>
<span class="nc" id="L883">        .setMimeType(&quot;image/svg+xml&quot;)</span>
<span class="nc" id="L884">        .setContent(new ClassPathResource(&quot;test/gradient-logo.svg&quot;).getContentAsByteArray())</span>
<span class="nc" id="L885">        .setLastModified(OffsetDateTime.now(ZoneId.systemDefault()));</span>
<span class="nc" id="L886">    uploadRepository.save(logo);</span>

<span class="nc" id="L888">    List&lt;AppTreeNode&gt; baseNodes = List.of(</span>
        new AppTreeLayerNode()
<span class="nc" id="L890">            .objectType(&quot;AppTreeLayerNode&quot;)</span>
<span class="nc" id="L891">            .id(&quot;lyr:openbasiskaart:osm&quot;)</span>
<span class="nc" id="L892">            .serviceId(&quot;openbasiskaart&quot;)</span>
<span class="nc" id="L893">            .layerName(&quot;osm&quot;)</span>
<span class="nc" id="L894">            .visible(true),</span>
        new AppTreeLayerNode()
<span class="nc" id="L896">            .objectType(&quot;AppTreeLayerNode&quot;)</span>
<span class="nc" id="L897">            .id(&quot;lyr:pdok-hwh-luchtfotorgb:Actueel_orthoHR&quot;)</span>
<span class="nc" id="L898">            .serviceId(&quot;pdok-hwh-luchtfotorgb&quot;)</span>
<span class="nc" id="L899">            .layerName(&quot;Actueel_orthoHR&quot;)</span>
<span class="nc" id="L900">            .visible(false));</span>

<span class="nc" id="L902">    Application app = new Application()</span>
<span class="nc" id="L903">        .setName(&quot;default&quot;)</span>
<span class="nc" id="L904">        .setTitle(&quot;Tailormap demo&quot;)</span>
<span class="nc" id="L905">        .setCrs(&quot;EPSG:28992&quot;)</span>
<span class="nc" id="L906">        .setAuthorizationRules(ruleAnonymousRead)</span>
<span class="nc" id="L907">        .setComponents(List.of(</span>
            new Component()
<span class="nc" id="L909">                .type(&quot;SIMPLE_SEARCH&quot;)</span>
<span class="nc" id="L910">                .config(new ComponentConfig()</span>
<span class="nc" id="L911">                    .enabled(true)</span>
<span class="nc" id="L912">                    .putAdditionalProperty(&quot;municipalities&quot;, List.of(&quot;0344&quot;))),</span>
<span class="nc" id="L913">            new Component().type(&quot;EDIT&quot;).config(new ComponentConfig().enabled(true)),</span>
            new Component()
<span class="nc" id="L915">                .type(&quot;COORDINATE_LINK_WINDOW&quot;)</span>
<span class="nc" id="L916">                .config(new ComponentConfig()</span>
<span class="nc" id="L917">                    .enabled(true)</span>
<span class="nc" id="L918">                    .putAdditionalProperty(</span>
                        &quot;urls&quot;,
<span class="nc" id="L920">                        List.of(</span>
<span class="nc" id="L921">                            Map.of(</span>
                                &quot;id&quot;,
                                &quot;google-maps&quot;,
                                &quot;url&quot;,
                                &quot;https://www.google.com/maps/@[lat],[lon],18z&quot;,
                                &quot;alias&quot;,
                                &quot;Google Maps&quot;,
                                &quot;projection&quot;,
                                &quot;EPSG:4326&quot;),
<span class="nc" id="L930">                            Map.of(</span>
                                &quot;id&quot;,
                                &quot;tm-demo&quot;,
                                &quot;url&quot;,
                                &quot;https://demo.tailormap.com/#@[X],[Y],18&quot;,
                                &quot;alias&quot;,
                                &quot;Tailormap demo&quot;,
                                &quot;projection&quot;,
                                &quot;EPSG:28992&quot;))))))
<span class="nc" id="L939">        .setContentRoot(new AppContent()</span>
<span class="nc" id="L940">            .addBaseLayerNodesItem(new AppTreeLevelNode()</span>
<span class="nc" id="L941">                .objectType(&quot;AppTreeLevelNode&quot;)</span>
<span class="nc" id="L942">                .id(&quot;root-base-layers&quot;)</span>
<span class="nc" id="L943">                .root(true)</span>
<span class="nc" id="L944">                .title(&quot;Base layers&quot;)</span>
<span class="nc" id="L945">                .childrenIds(List.of(</span>
                    &quot;lyr:openbasiskaart:osm&quot;,
                    &quot;lyr:pdok-hwh-luchtfotorgb:Actueel_orthoHR&quot;,
                    &quot;lyr:openbasiskaart-proxied:osm&quot;,
                    &quot;lyr:openbasiskaart-tms:xyz&quot;,
                    &quot;lyr:b3p-mapproxy-luchtfoto:xyz&quot;)))
<span class="nc" id="L951">            .addBaseLayerNodesItem(</span>
                // This layer from a secured proxied service should not be proxyable in a
                // public app, see test_wms_secured_proxy_not_in_public_app() testcase
                new AppTreeLayerNode()
<span class="nc" id="L955">                    .objectType(&quot;AppTreeLayerNode&quot;)</span>
<span class="nc" id="L956">                    .id(&quot;lyr:openbasiskaart-proxied:osm&quot;)</span>
<span class="nc" id="L957">                    .serviceId(&quot;openbasiskaart-proxied&quot;)</span>
<span class="nc" id="L958">                    .layerName(&quot;osm&quot;)</span>
<span class="nc" id="L959">                    .visible(false))</span>
<span class="nc" id="L960">            .addBaseLayerNodesItem(new AppTreeLayerNode()</span>
<span class="nc" id="L961">                .objectType(&quot;AppTreeLayerNode&quot;)</span>
<span class="nc" id="L962">                .id(&quot;lyr:openbasiskaart-tms:xyz&quot;)</span>
<span class="nc" id="L963">                .serviceId(&quot;openbasiskaart-tms&quot;)</span>
<span class="nc" id="L964">                .layerName(&quot;xyz&quot;)</span>
<span class="nc" id="L965">                .visible(false))</span>
<span class="nc" id="L966">            .addBaseLayerNodesItem(new AppTreeLayerNode()</span>
<span class="nc" id="L967">                .objectType(&quot;AppTreeLayerNode&quot;)</span>
<span class="nc" id="L968">                .id(&quot;lyr:b3p-mapproxy-luchtfoto:xyz&quot;)</span>
<span class="nc" id="L969">                .serviceId(&quot;b3p-mapproxy-luchtfoto&quot;)</span>
<span class="nc" id="L970">                .layerName(&quot;xyz&quot;)</span>
<span class="nc" id="L971">                .visible(false))</span>
<span class="nc" id="L972">            .addLayerNodesItem(new AppTreeLevelNode()</span>
<span class="nc" id="L973">                .objectType(&quot;AppTreeLevelNode&quot;)</span>
<span class="nc" id="L974">                .id(&quot;root&quot;)</span>
<span class="nc" id="L975">                .root(true)</span>
<span class="nc" id="L976">                .title(&quot;Layers&quot;)</span>
<span class="nc" id="L977">                .childrenIds(List.of(</span>
                    &quot;lyr:pdok-kadaster-bestuurlijkegebieden:Provinciegebied&quot;,
                    &quot;lyr:bestuurlijkegebieden-proxied:Provinciegebied&quot;,
                    &quot;lyr:pdok-kadaster-bestuurlijkegebieden:Gemeentegebied&quot;,
                    &quot;lyr:snapshot-geoserver:postgis:begroeidterreindeel&quot;,
                    &quot;lyr:snapshot-geoserver:postgis:bak&quot;,
                    &quot;lyr:snapshot-geoserver:postgis:kadastraal_perceel&quot;,
                    &quot;lyr:snapshot-geoserver:sqlserver:wegdeel&quot;,
                    &quot;lyr:snapshot-geoserver:oracle:WATERDEEL&quot;,
                    &quot;lyr:snapshot-geoserver:BGT&quot;,
                    &quot;lvl:proxied&quot;,
                    &quot;lvl:osm&quot;,
                    &quot;lvl:archeo&quot;)))
<span class="nc" id="L990">            .addLayerNodesItem(new AppTreeLayerNode()</span>
<span class="nc" id="L991">                .objectType(&quot;AppTreeLayerNode&quot;)</span>
<span class="nc" id="L992">                .id(&quot;lyr:pdok-kadaster-bestuurlijkegebieden:Provinciegebied&quot;)</span>
<span class="nc" id="L993">                .serviceId(&quot;pdok-kadaster-bestuurlijkegebieden&quot;)</span>
<span class="nc" id="L994">                .layerName(&quot;Provinciegebied&quot;)</span>
<span class="nc" id="L995">                .visible(true))</span>
            // This is a layer from proxied service with auth that should also not be
            // visible, but it has a feature source attached, should also be denied for
            // features access and not be included in TOC
<span class="nc" id="L999">            .addLayerNodesItem(new AppTreeLayerNode()</span>
<span class="nc" id="L1000">                .objectType(&quot;AppTreeLayerNode&quot;)</span>
<span class="nc" id="L1001">                .id(&quot;lyr:bestuurlijkegebieden-proxied:Provinciegebied&quot;)</span>
<span class="nc" id="L1002">                .serviceId(&quot;bestuurlijkegebieden-proxied&quot;)</span>
<span class="nc" id="L1003">                .layerName(&quot;Provinciegebied&quot;)</span>
<span class="nc" id="L1004">                .visible(false))</span>
<span class="nc" id="L1005">            .addLayerNodesItem(new AppTreeLayerNode()</span>
<span class="nc" id="L1006">                .objectType(&quot;AppTreeLayerNode&quot;)</span>
<span class="nc" id="L1007">                .id(&quot;lyr:pdok-kadaster-bestuurlijkegebieden:Gemeentegebied&quot;)</span>
<span class="nc" id="L1008">                .serviceId(&quot;pdok-kadaster-bestuurlijkegebieden&quot;)</span>
<span class="nc" id="L1009">                .layerName(&quot;Gemeentegebied&quot;)</span>
<span class="nc" id="L1010">                .visible(true))</span>
<span class="nc" id="L1011">            .addLayerNodesItem(new AppTreeLayerNode()</span>
<span class="nc" id="L1012">                .objectType(&quot;AppTreeLayerNode&quot;)</span>
<span class="nc" id="L1013">                .id(&quot;lyr:snapshot-geoserver:postgis:begroeidterreindeel&quot;)</span>
<span class="nc" id="L1014">                .serviceId(&quot;snapshot-geoserver&quot;)</span>
<span class="nc" id="L1015">                .layerName(&quot;postgis:begroeidterreindeel&quot;)</span>
<span class="nc" id="L1016">                .visible(true))</span>
<span class="nc" id="L1017">            .addLayerNodesItem(new AppTreeLayerNode()</span>
<span class="nc" id="L1018">                .objectType(&quot;AppTreeLayerNode&quot;)</span>
<span class="nc" id="L1019">                .id(&quot;lyr:snapshot-geoserver:postgis:bak&quot;)</span>
<span class="nc" id="L1020">                .serviceId(&quot;snapshot-geoserver&quot;)</span>
<span class="nc" id="L1021">                .layerName(&quot;postgis:bak&quot;)</span>
<span class="nc" id="L1022">                .visible(false))</span>
<span class="nc" id="L1023">            .addLayerNodesItem(new AppTreeLayerNode()</span>
<span class="nc" id="L1024">                .objectType(&quot;AppTreeLayerNode&quot;)</span>
<span class="nc" id="L1025">                .id(&quot;lyr:snapshot-geoserver:postgis:kadastraal_perceel&quot;)</span>
<span class="nc" id="L1026">                .serviceId(&quot;snapshot-geoserver&quot;)</span>
<span class="nc" id="L1027">                .layerName(&quot;postgis:kadastraal_perceel&quot;)</span>
<span class="nc" id="L1028">                .visible(false))</span>
<span class="nc" id="L1029">            .addLayerNodesItem(new AppTreeLayerNode()</span>
<span class="nc" id="L1030">                .objectType(&quot;AppTreeLayerNode&quot;)</span>
<span class="nc" id="L1031">                .id(&quot;lyr:snapshot-geoserver:sqlserver:wegdeel&quot;)</span>
<span class="nc" id="L1032">                .serviceId(&quot;snapshot-geoserver&quot;)</span>
<span class="nc" id="L1033">                .layerName(&quot;sqlserver:wegdeel&quot;)</span>
<span class="nc" id="L1034">                .visible(true))</span>
<span class="nc" id="L1035">            .addLayerNodesItem(new AppTreeLayerNode()</span>
<span class="nc" id="L1036">                .objectType(&quot;AppTreeLayerNode&quot;)</span>
<span class="nc" id="L1037">                .id(&quot;lyr:snapshot-geoserver:oracle:WATERDEEL&quot;)</span>
<span class="nc" id="L1038">                .serviceId(&quot;snapshot-geoserver&quot;)</span>
<span class="nc" id="L1039">                .layerName(&quot;oracle:WATERDEEL&quot;)</span>
<span class="nc" id="L1040">                .visible(true))</span>
<span class="nc" id="L1041">            .addLayerNodesItem(new AppTreeLayerNode()</span>
<span class="nc" id="L1042">                .objectType(&quot;AppTreeLayerNode&quot;)</span>
<span class="nc" id="L1043">                .id(&quot;lyr:snapshot-geoserver:BGT&quot;)</span>
<span class="nc" id="L1044">                .serviceId(&quot;snapshot-geoserver&quot;)</span>
<span class="nc" id="L1045">                .layerName(&quot;BGT&quot;)</span>
<span class="nc" id="L1046">                .visible(false))</span>
<span class="nc" id="L1047">            .addLayerNodesItem(new AppTreeLevelNode()</span>
<span class="nc" id="L1048">                .objectType(&quot;AppTreeLevelNode&quot;)</span>
<span class="nc" id="L1049">                .id(&quot;lvl:proxied&quot;)</span>
<span class="nc" id="L1050">                .title(&quot;Proxied&quot;)</span>
<span class="nc" id="L1051">                .childrenIds(List.of(&quot;lyr:snapshot-geoserver-proxied:postgis:begroeidterreindeel&quot;)))</span>
<span class="nc" id="L1052">            .addLayerNodesItem(new AppTreeLayerNode()</span>
<span class="nc" id="L1053">                .objectType(&quot;AppTreeLayerNode&quot;)</span>
<span class="nc" id="L1054">                .id(&quot;lyr:snapshot-geoserver-proxied:postgis:begroeidterreindeel&quot;)</span>
<span class="nc" id="L1055">                .serviceId(&quot;snapshot-geoserver-proxied&quot;)</span>
<span class="nc" id="L1056">                .layerName(&quot;postgis:begroeidterreindeel&quot;)</span>
<span class="nc" id="L1057">                .visible(false))</span>
<span class="nc" id="L1058">            .addLayerNodesItem(new AppTreeLevelNode()</span>
<span class="nc" id="L1059">                .objectType(&quot;AppTreeLevelNode&quot;)</span>
<span class="nc" id="L1060">                .id(&quot;lvl:osm&quot;)</span>
<span class="nc" id="L1061">                .title(&quot;OSM&quot;)</span>
<span class="nc" id="L1062">                .childrenIds(List.of(&quot;lyr:snapshot-geoserver:postgis:osm_polygon&quot;)))</span>
<span class="nc" id="L1063">            .addLayerNodesItem(new AppTreeLayerNode()</span>
<span class="nc" id="L1064">                .objectType(&quot;AppTreeLayerNode&quot;)</span>
<span class="nc" id="L1065">                .id(&quot;lyr:snapshot-geoserver:postgis:osm_polygon&quot;)</span>
<span class="nc" id="L1066">                .serviceId(&quot;snapshot-geoserver&quot;)</span>
<span class="nc" id="L1067">                .layerName(&quot;postgis:osm_polygon&quot;)</span>
<span class="nc" id="L1068">                .visible(false))</span>
<span class="nc" id="L1069">            .addLayerNodesItem(new AppTreeLevelNode()</span>
<span class="nc" id="L1070">                .objectType(&quot;AppTreeLevelNode&quot;)</span>
<span class="nc" id="L1071">                .id(&quot;lvl:archeo&quot;)</span>
<span class="nc" id="L1072">                .title(&quot;Archeology&quot;)</span>
<span class="nc" id="L1073">                .childrenIds(List.of(&quot;lyr:demo:geomorfologie&quot;)))</span>
<span class="nc" id="L1074">            .addLayerNodesItem(new AppTreeLayerNode()</span>
<span class="nc" id="L1075">                .objectType(&quot;AppTreeLayerNode&quot;)</span>
<span class="nc" id="L1076">                .id(&quot;lyr:demo:geomorfologie&quot;)</span>
<span class="nc" id="L1077">                .serviceId(&quot;demo&quot;)</span>
<span class="nc" id="L1078">                .layerName(&quot;geomorfologie&quot;)</span>
<span class="nc" id="L1079">                .visible(true)))</span>
<span class="nc" id="L1080">        .setStyling(new AppStyling().logo(logo.getId().toString()))</span>
<span class="nc" id="L1081">        .setSettings(new AppSettings()</span>
<span class="nc" id="L1082">            .putLayerSettingsItem(&quot;lyr:openbasiskaart:osm&quot;, new AppLayerSettings().title(&quot;Openbasiskaart&quot;))</span>
<span class="nc" id="L1083">            .putLayerSettingsItem(</span>
<span class="nc" id="L1084">                &quot;lyr:pdok-hwh-luchtfotorgb:Actueel_orthoHR&quot;, new AppLayerSettings().title(&quot;Luchtfoto&quot;))</span>
<span class="nc" id="L1085">            .putLayerSettingsItem(</span>
                &quot;lyr:openbasiskaart-proxied:osm&quot;,
<span class="nc" id="L1087">                new AppLayerSettings().title(&quot;Openbasiskaart (proxied)&quot;))</span>
<span class="nc" id="L1088">            .putLayerSettingsItem(</span>
                &quot;lyr:snapshot-geoserver:oracle:WATERDEEL&quot;,
                new AppLayerSettings()
<span class="nc" id="L1091">                    .opacity(50)</span>
<span class="nc" id="L1092">                    .title(&quot;Waterdeel overridden title&quot;)</span>
<span class="nc" id="L1093">                    .editable(true)</span>
<span class="nc" id="L1094">                    .description(&quot;This is the layer description from the app layer setting.&quot;)</span>
<span class="nc" id="L1095">                    .attribution(</span>
                        &quot;CC BY 4.0 [BGT/Kadaster](https://www.nationaalgeoregister.nl/geonetwork/srv/api/records/2cb4769c-b56e-48fa-8685-c48f61b9a319)&quot;))
<span class="nc" id="L1097">            .putLayerSettingsItem(</span>
                &quot;lyr:snapshot-geoserver:postgis:osm_polygon&quot;,
                new AppLayerSettings()
<span class="nc" id="L1100">                    .description(&quot;OpenStreetMap polygon data in EPSG:3857&quot;)</span>
<span class="nc" id="L1101">                    .opacity(60)</span>
<span class="nc" id="L1102">                    .editable(true)</span>
<span class="nc" id="L1103">                    .title(&quot;OSM Polygon (EPSG:3857)&quot;)</span>
<span class="nc" id="L1104">                    .attribution(</span>
                        &quot;© [OpenStreetMap](https://www.openstreetmap.org/copyright) contributors&quot;))
<span class="nc" id="L1106">            .putLayerSettingsItem(</span>
                &quot;lyr:snapshot-geoserver:postgis:begroeidterreindeel&quot;,
                new AppLayerSettings()
<span class="nc" id="L1109">                    .editable(true)</span>
<span class="nc" id="L1110">                    .addHideAttributesItem(&quot;begroeidterreindeeloptalud&quot;)</span>
<span class="nc" id="L1111">                    .addReadOnlyAttributesItem(&quot;eindregistratie&quot;))</span>
<span class="nc" id="L1112">            .putLayerSettingsItem(</span>
                &quot;lyr:snapshot-geoserver:postgis:kadastraal_perceel&quot;,
<span class="nc" id="L1114">                new AppLayerSettings().editable(true).addReadOnlyAttributesItem(&quot;aanduiding&quot;))</span>
<span class="nc" id="L1115">            .putLayerSettingsItem(</span>
<span class="nc" id="L1116">                &quot;lyr:snapshot-geoserver:sqlserver:wegdeel&quot;, new AppLayerSettings().editable(true))</span>
<span class="nc" id="L1117">            .putLayerSettingsItem(</span>
                &quot;lyr:snapshot-geoserver-proxied:postgis:begroeidterreindeel&quot;,
<span class="nc" id="L1119">                new AppLayerSettings().editable(false))</span>
<span class="nc" id="L1120">            .putLayerSettingsItem(</span>
                &quot;lyr:pdok-kadaster-bestuurlijkegebieden:Provinciegebied&quot;,
                new AppLayerSettings()
<span class="nc" id="L1123">                    .hiddenFunctionality(Set.of(FEATURE_INFO, ATTRIBUTE_LIST, EXPORT))));</span>

<span class="nc" id="L1125">    app.getContentRoot().getBaseLayerNodes().addAll(baseNodes);</span>
<span class="nc" id="L1126">    app.setInitialExtent(</span>
<span class="nc" id="L1127">        new Bounds().minx(130011d).miny(458031d).maxx(132703d).maxy(459995d));</span>
<span class="nc" id="L1128">    app.setMaxExtent(new Bounds().minx(-285401d).miny(22598d).maxx(595401d).maxy(903401d));</span>

<span class="nc bnc" id="L1130" title="All 2 branches missed.">    if (map5url != null) {</span>
<span class="nc" id="L1131">      AppTreeLevelNode root =</span>
<span class="nc" id="L1132">          (AppTreeLevelNode) app.getContentRoot().getBaseLayerNodes().get(0);</span>
<span class="nc" id="L1133">      List&lt;String&gt; childrenIds = new ArrayList&lt;&gt;(root.getChildrenIds());</span>
<span class="nc" id="L1134">      childrenIds.add(&quot;lyr:map5:map5topo&quot;);</span>
<span class="nc" id="L1135">      childrenIds.add(&quot;lyr:map5:map5topo_simple&quot;);</span>
<span class="nc" id="L1136">      childrenIds.add(&quot;lvl:luchtfoto-labels&quot;);</span>
<span class="nc" id="L1137">      root.setChildrenIds(childrenIds);</span>
<span class="nc" id="L1138">      app.getSettings()</span>
<span class="nc" id="L1139">          .putLayerSettingsItem(&quot;lyr:map5:map5topo&quot;, new AppLayerSettings().title(&quot;Map5&quot;))</span>
<span class="nc" id="L1140">          .putLayerSettingsItem(&quot;lyr:map5:map5topo_simple&quot;, new AppLayerSettings().title(&quot;Map5 simple&quot;));</span>
<span class="nc" id="L1141">      app.getContentRoot()</span>
<span class="nc" id="L1142">          .addBaseLayerNodesItem(new AppTreeLayerNode()</span>
<span class="nc" id="L1143">              .objectType(&quot;AppTreeLayerNode&quot;)</span>
<span class="nc" id="L1144">              .id(&quot;lyr:map5:map5topo&quot;)</span>
<span class="nc" id="L1145">              .serviceId(&quot;map5&quot;)</span>
<span class="nc" id="L1146">              .layerName(&quot;map5topo&quot;)</span>
<span class="nc" id="L1147">              .visible(false))</span>
<span class="nc" id="L1148">          .addBaseLayerNodesItem(new AppTreeLayerNode()</span>
<span class="nc" id="L1149">              .objectType(&quot;AppTreeLayerNode&quot;)</span>
<span class="nc" id="L1150">              .id(&quot;lyr:map5:map5topo_simple&quot;)</span>
<span class="nc" id="L1151">              .serviceId(&quot;map5&quot;)</span>
<span class="nc" id="L1152">              .layerName(&quot;map5topo_simple&quot;)</span>
<span class="nc" id="L1153">              .visible(false))</span>
<span class="nc" id="L1154">          .addBaseLayerNodesItem(new AppTreeLevelNode()</span>
<span class="nc" id="L1155">              .objectType(&quot;AppTreeLevelNode&quot;)</span>
<span class="nc" id="L1156">              .id(&quot;lvl:luchtfoto-labels&quot;)</span>
<span class="nc" id="L1157">              .title(&quot;Luchtfoto met labels&quot;)</span>
<span class="nc" id="L1158">              .addChildrenIdsItem(&quot;lyr:map5:luforoadslabels&quot;)</span>
<span class="nc" id="L1159">              .addChildrenIdsItem(&quot;lyr:pdok-hwh-luchtfotorgb:Actueel_orthoHR2&quot;))</span>
<span class="nc" id="L1160">          .addBaseLayerNodesItem(new AppTreeLayerNode()</span>
<span class="nc" id="L1161">              .objectType(&quot;AppTreeLayerNode&quot;)</span>
<span class="nc" id="L1162">              .id(&quot;lyr:map5:luforoadslabels&quot;)</span>
<span class="nc" id="L1163">              .serviceId(&quot;map5&quot;)</span>
<span class="nc" id="L1164">              .layerName(&quot;luforoadslabels&quot;)</span>
<span class="nc" id="L1165">              .visible(false))</span>
<span class="nc" id="L1166">          .addBaseLayerNodesItem(new AppTreeLayerNode()</span>
<span class="nc" id="L1167">              .objectType(&quot;AppTreeLayerNode&quot;)</span>
<span class="nc" id="L1168">              .id(&quot;lyr:pdok-hwh-luchtfotorgb:Actueel_orthoHR2&quot;)</span>
<span class="nc" id="L1169">              .serviceId(&quot;pdok-hwh-luchtfotorgb&quot;)</span>
<span class="nc" id="L1170">              .layerName(&quot;Actueel_orthoHR&quot;)</span>
<span class="nc" id="L1171">              .visible(false));</span>
    }

<span class="nc" id="L1174">    applicationRepository.save(app);</span>

<span class="nc" id="L1176">    app = new Application()</span>
<span class="nc" id="L1177">        .setName(&quot;base&quot;)</span>
<span class="nc" id="L1178">        .setTitle(&quot;Service base app&quot;)</span>
<span class="nc" id="L1179">        .setCrs(&quot;EPSG:28992&quot;)</span>
<span class="nc" id="L1180">        .setAuthorizationRules(ruleAnonymousRead)</span>
<span class="nc" id="L1181">        .setContentRoot(new AppContent()</span>
<span class="nc" id="L1182">            .addBaseLayerNodesItem(new AppTreeLevelNode()</span>
<span class="nc" id="L1183">                .objectType(&quot;AppTreeLevelNode&quot;)</span>
<span class="nc" id="L1184">                .id(&quot;root-base-layers&quot;)</span>
<span class="nc" id="L1185">                .root(true)</span>
<span class="nc" id="L1186">                .title(&quot;Base layers&quot;)</span>
<span class="nc" id="L1187">                .childrenIds(List.of(</span>
                    &quot;lyr:openbasiskaart:osm&quot;, &quot;lyr:pdok-hwh-luchtfotorgb:Actueel_orthoHR&quot;))));
<span class="nc" id="L1189">    app.getContentRoot().getBaseLayerNodes().addAll(baseNodes);</span>
<span class="nc" id="L1190">    applicationRepository.save(app);</span>

<span class="nc" id="L1192">    app = new Application()</span>
<span class="nc" id="L1193">        .setName(&quot;secured&quot;)</span>
<span class="nc" id="L1194">        .setTitle(&quot;secured app&quot;)</span>
<span class="nc" id="L1195">        .setCrs(&quot;EPSG:28992&quot;)</span>
<span class="nc" id="L1196">        .setAuthorizationRules(ruleLoggedIn)</span>
<span class="nc" id="L1197">        .setContentRoot(new AppContent()</span>
<span class="nc" id="L1198">            .addBaseLayerNodesItem(new AppTreeLevelNode()</span>
<span class="nc" id="L1199">                .objectType(&quot;AppTreeLevelNode&quot;)</span>
<span class="nc" id="L1200">                .id(&quot;root-base-layers&quot;)</span>
<span class="nc" id="L1201">                .root(true)</span>
<span class="nc" id="L1202">                .title(&quot;Base layers&quot;)</span>
<span class="nc" id="L1203">                .childrenIds(List.of(</span>
                    &quot;lyr:openbasiskaart:osm&quot;,
                    &quot;lyr:pdok-hwh-luchtfotorgb:Actueel_orthoHR&quot;,
                    &quot;lyr:openbasiskaart-proxied:osm&quot;)))
<span class="nc" id="L1207">            .addBaseLayerNodesItem(new AppTreeLayerNode()</span>
<span class="nc" id="L1208">                .objectType(&quot;AppTreeLayerNode&quot;)</span>
<span class="nc" id="L1209">                .id(&quot;lyr:openbasiskaart-proxied:osm&quot;)</span>
<span class="nc" id="L1210">                .serviceId(&quot;openbasiskaart-proxied&quot;)</span>
<span class="nc" id="L1211">                .layerName(&quot;osm&quot;)</span>
<span class="nc" id="L1212">                .visible(false))</span>
<span class="nc" id="L1213">            .addLayerNodesItem(new AppTreeLevelNode()</span>
<span class="nc" id="L1214">                .objectType(&quot;AppTreeLevelNode&quot;)</span>
<span class="nc" id="L1215">                .id(&quot;root&quot;)</span>
<span class="nc" id="L1216">                .root(true)</span>
<span class="nc" id="L1217">                .title(&quot;Layers&quot;)</span>
<span class="nc" id="L1218">                .childrenIds(List.of(</span>
                    &quot;lyr:pdok-kadaster-bestuurlijkegebieden:Provinciegebied&quot;,
                    &quot;lyr:pdok-kadaster-bestuurlijkegebieden:Gemeentegebied&quot;,
                    &quot;lvl:proxied&quot;)))
<span class="nc" id="L1222">            .addLayerNodesItem(new AppTreeLayerNode()</span>
<span class="nc" id="L1223">                .objectType(&quot;AppTreeLayerNode&quot;)</span>
<span class="nc" id="L1224">                .id(&quot;lyr:pdok-kadaster-bestuurlijkegebieden:Gemeentegebied&quot;)</span>
<span class="nc" id="L1225">                .serviceId(&quot;pdok-kadaster-bestuurlijkegebieden&quot;)</span>
<span class="nc" id="L1226">                .layerName(&quot;Gemeentegebied&quot;)</span>
<span class="nc" id="L1227">                .visible(true))</span>
<span class="nc" id="L1228">            .addLayerNodesItem(new AppTreeLayerNode()</span>
<span class="nc" id="L1229">                .objectType(&quot;AppTreeLayerNode&quot;)</span>
<span class="nc" id="L1230">                .id(&quot;lyr:pdok-kadaster-bestuurlijkegebieden:Provinciegebied&quot;)</span>
<span class="nc" id="L1231">                .serviceId(&quot;pdok-kadaster-bestuurlijkegebieden&quot;)</span>
<span class="nc" id="L1232">                .layerName(&quot;Provinciegebied&quot;)</span>
<span class="nc" id="L1233">                .visible(false))</span>
<span class="nc" id="L1234">            .addLayerNodesItem(new AppTreeLevelNode()</span>
<span class="nc" id="L1235">                .objectType(&quot;AppTreeLevelNode&quot;)</span>
<span class="nc" id="L1236">                .id(&quot;lvl:proxied&quot;)</span>
<span class="nc" id="L1237">                .title(&quot;Proxied&quot;)</span>
<span class="nc" id="L1238">                .childrenIds(List.of(&quot;lyr:snapshot-geoserver-proxied:postgis:begroeidterreindeel&quot;)))</span>
<span class="nc" id="L1239">            .addLayerNodesItem(new AppTreeLayerNode()</span>
<span class="nc" id="L1240">                .objectType(&quot;AppTreeLayerNode&quot;)</span>
<span class="nc" id="L1241">                .id(&quot;lyr:snapshot-geoserver-proxied:postgis:begroeidterreindeel&quot;)</span>
<span class="nc" id="L1242">                .serviceId(&quot;snapshot-geoserver-proxied&quot;)</span>
<span class="nc" id="L1243">                .layerName(&quot;postgis:begroeidterreindeel&quot;)</span>
<span class="nc" id="L1244">                .visible(false)))</span>
<span class="nc" id="L1245">        .setSettings(new AppSettings()</span>
<span class="nc" id="L1246">            .putLayerSettingsItem(</span>
                &quot;lyr:openbasiskaart-proxied:osm&quot;,
<span class="nc" id="L1248">                new AppLayerSettings().title(&quot;Openbasiskaart (proxied)&quot;)));</span>

<span class="nc" id="L1250">    app.getContentRoot().getBaseLayerNodes().addAll(baseNodes);</span>
<span class="nc" id="L1251">    applicationRepository.save(app);</span>

<span class="nc" id="L1253">    app = new Application()</span>
<span class="nc" id="L1254">        .setName(&quot;secured-auth&quot;)</span>
<span class="nc" id="L1255">        .setTitle(&quot;secured (with authorizations)&quot;)</span>
<span class="nc" id="L1256">        .setCrs(&quot;EPSG:28992&quot;)</span>
<span class="nc" id="L1257">        .setAuthorizationRules(List.of(</span>
            new AuthorizationRule()
<span class="nc" id="L1259">                .groupName(&quot;test-foo&quot;)</span>
<span class="nc" id="L1260">                .decisions(Map.of(ACCESS_TYPE_READ, AuthorizationRuleDecision.ALLOW)),</span>
            new AuthorizationRule()
<span class="nc" id="L1262">                .groupName(&quot;test-bar&quot;)</span>
<span class="nc" id="L1263">                .decisions(Map.of(ACCESS_TYPE_READ, AuthorizationRuleDecision.ALLOW))))</span>
<span class="nc" id="L1264">        .setContentRoot(new AppContent()</span>
<span class="nc" id="L1265">            .addLayerNodesItem(new AppTreeLevelNode()</span>
<span class="nc" id="L1266">                .objectType(&quot;AppTreeLevelNode&quot;)</span>
<span class="nc" id="L1267">                .id(&quot;root&quot;)</span>
<span class="nc" id="L1268">                .root(true)</span>
<span class="nc" id="L1269">                .title(&quot;Layers&quot;)</span>
<span class="nc" id="L1270">                .childrenIds(List.of(&quot;lyr:needs-auth&quot;, &quot;lyr:public&quot;)))</span>
<span class="nc" id="L1271">            .addLayerNodesItem(new AppTreeLevelNode()</span>
<span class="nc" id="L1272">                .objectType(&quot;AppTreeLevelNode&quot;)</span>
<span class="nc" id="L1273">                .id(&quot;lvl:public&quot;)</span>
<span class="nc" id="L1274">                .title(&quot;Public&quot;)</span>
<span class="nc" id="L1275">                .childrenIds(List.of(&quot;lyr:snapshot-geoserver:BGT&quot;)))</span>
<span class="nc" id="L1276">            .addLayerNodesItem(new AppTreeLevelNode()</span>
<span class="nc" id="L1277">                .objectType(&quot;AppTreeLevelNode&quot;)</span>
<span class="nc" id="L1278">                .id(&quot;lvl:needs-auth&quot;)</span>
<span class="nc" id="L1279">                .title(&quot;Needs auth&quot;)</span>
<span class="nc" id="L1280">                .childrenIds(List.of(</span>
                    &quot;lyr:filtered-snapshot-geoserver:BGT&quot;,
                    &quot;lyr:filtered-snapshot-geoserver:postgis:begroeidterreindeel&quot;)))
<span class="nc" id="L1283">            .addLayerNodesItem(new AppTreeLayerNode()</span>
<span class="nc" id="L1284">                .objectType(&quot;AppTreeLayerNode&quot;)</span>
<span class="nc" id="L1285">                .id(&quot;lyr:filtered-snapshot-geoserver:BGT&quot;)</span>
<span class="nc" id="L1286">                .serviceId(&quot;filtered-snapshot-geoserver&quot;)</span>
<span class="nc" id="L1287">                .layerName(&quot;BGT&quot;)</span>
<span class="nc" id="L1288">                .visible(true))</span>
<span class="nc" id="L1289">            .addLayerNodesItem(new AppTreeLayerNode()</span>
<span class="nc" id="L1290">                .objectType(&quot;AppTreeLayerNode&quot;)</span>
<span class="nc" id="L1291">                .id(&quot;lyr:filtered-snapshot-geoserver:postgis:begroeidterreindeel&quot;)</span>
<span class="nc" id="L1292">                .serviceId(&quot;filtered-snapshot-geoserver&quot;)</span>
<span class="nc" id="L1293">                .layerName(&quot;postgis:begroeidterreindeel&quot;)</span>
<span class="nc" id="L1294">                .visible(true))</span>
<span class="nc" id="L1295">            .addLayerNodesItem(new AppTreeLayerNode()</span>
<span class="nc" id="L1296">                .objectType(&quot;AppTreeLayerNode&quot;)</span>
<span class="nc" id="L1297">                .id(&quot;lyr:snapshot-geoserver:BGT&quot;)</span>
<span class="nc" id="L1298">                .serviceId(&quot;snapshot-geoserver&quot;)</span>
<span class="nc" id="L1299">                .layerName(&quot;BGT&quot;)</span>
<span class="nc" id="L1300">                .visible(true)));</span>

<span class="nc" id="L1302">    applicationRepository.save(app);</span>

<span class="nc" id="L1304">    app = new Application()</span>
<span class="nc" id="L1305">        .setName(&quot;austria&quot;)</span>
<span class="nc" id="L1306">        .setCrs(&quot;EPSG:3857&quot;)</span>
<span class="nc" id="L1307">        .setAuthorizationRules(ruleAnonymousRead)</span>
<span class="nc" id="L1308">        .setTitle(&quot;Austria&quot;)</span>
<span class="nc" id="L1309">        .setInitialExtent(</span>
<span class="nc" id="L1310">            new Bounds().minx(987982d).miny(5799551d).maxx(1963423d).maxy(6320708d))</span>
<span class="nc" id="L1311">        .setMaxExtent(</span>
<span class="nc" id="L1312">            new Bounds().minx(206516d).miny(5095461d).maxx(3146930d).maxy(7096232d))</span>
<span class="nc" id="L1313">        .setContentRoot(new AppContent()</span>
<span class="nc" id="L1314">            .addBaseLayerNodesItem(new AppTreeLevelNode()</span>
<span class="nc" id="L1315">                .objectType(&quot;AppTreeLevelNode&quot;)</span>
<span class="nc" id="L1316">                .id(&quot;root-base-layers&quot;)</span>
<span class="nc" id="L1317">                .root(true)</span>
<span class="nc" id="L1318">                .title(&quot;Base layers&quot;)</span>
<span class="nc" id="L1319">                .childrenIds(List.of(</span>
                    &quot;lyr:at-basemap:geolandbasemap&quot;,
                    &quot;lyr:at-basemap:orthofoto&quot;,
                    &quot;lvl:orthofoto-labels&quot;,
                    &quot;lyr:osm:xyz&quot;)))
<span class="nc" id="L1324">            .addBaseLayerNodesItem(new AppTreeLayerNode()</span>
<span class="nc" id="L1325">                .objectType(&quot;AppTreeLayerNode&quot;)</span>
<span class="nc" id="L1326">                .id(&quot;lyr:at-basemap:geolandbasemap&quot;)</span>
<span class="nc" id="L1327">                .serviceId(&quot;at-basemap&quot;)</span>
<span class="nc" id="L1328">                .layerName(&quot;geolandbasemap&quot;)</span>
<span class="nc" id="L1329">                .visible(true))</span>
<span class="nc" id="L1330">            .addBaseLayerNodesItem(new AppTreeLayerNode()</span>
<span class="nc" id="L1331">                .objectType(&quot;AppTreeLayerNode&quot;)</span>
<span class="nc" id="L1332">                .id(&quot;lyr:at-basemap:orthofoto&quot;)</span>
<span class="nc" id="L1333">                .serviceId(&quot;at-basemap&quot;)</span>
<span class="nc" id="L1334">                .layerName(&quot;bmaporthofoto30cm&quot;)</span>
<span class="nc" id="L1335">                .visible(false))</span>
<span class="nc" id="L1336">            .addBaseLayerNodesItem(new AppTreeLevelNode()</span>
<span class="nc" id="L1337">                .objectType(&quot;AppTreeLevelNode&quot;)</span>
<span class="nc" id="L1338">                .id(&quot;lvl:orthofoto-labels&quot;)</span>
<span class="nc" id="L1339">                .title(&quot;Orthophoto with labels&quot;)</span>
<span class="nc" id="L1340">                .childrenIds(List.of(&quot;lyr:at-basemap:bmapoverlay&quot;, &quot;lyr:at-basemap:orthofoto_2&quot;)))</span>
<span class="nc" id="L1341">            .addBaseLayerNodesItem(new AppTreeLayerNode()</span>
<span class="nc" id="L1342">                .objectType(&quot;AppTreeLayerNode&quot;)</span>
<span class="nc" id="L1343">                .id(&quot;lyr:at-basemap:bmapoverlay&quot;)</span>
<span class="nc" id="L1344">                .serviceId(&quot;at-basemap&quot;)</span>
<span class="nc" id="L1345">                .layerName(&quot;bmapoverlay&quot;)</span>
<span class="nc" id="L1346">                .visible(false))</span>
<span class="nc" id="L1347">            .addBaseLayerNodesItem(new AppTreeLayerNode()</span>
<span class="nc" id="L1348">                .objectType(&quot;AppTreeLayerNode&quot;)</span>
<span class="nc" id="L1349">                .id(&quot;lyr:at-basemap:orthofoto_2&quot;)</span>
<span class="nc" id="L1350">                .serviceId(&quot;at-basemap&quot;)</span>
<span class="nc" id="L1351">                .layerName(&quot;bmaporthofoto30cm&quot;)</span>
<span class="nc" id="L1352">                .visible(false))</span>
<span class="nc" id="L1353">            .addBaseLayerNodesItem(new AppTreeLayerNode()</span>
<span class="nc" id="L1354">                .objectType(&quot;AppTreeLayerNode&quot;)</span>
<span class="nc" id="L1355">                .id(&quot;lyr:osm:xyz&quot;)</span>
<span class="nc" id="L1356">                .serviceId(&quot;osm&quot;)</span>
<span class="nc" id="L1357">                .layerName(&quot;xyz&quot;)</span>
<span class="nc" id="L1358">                .visible(false)));</span>

<span class="nc" id="L1360">    applicationRepository.save(app);</span>

<span class="nc" id="L1362">    app = new Application()</span>
<span class="nc" id="L1363">        .setName(&quot;3d_utrecht&quot;)</span>
<span class="nc" id="L1364">        .setCrs(&quot;EPSG:3857&quot;)</span>
<span class="nc" id="L1365">        .setAuthorizationRules(ruleAnonymousRead)</span>
<span class="nc" id="L1366">        .setTitle(&quot;3D Utrecht&quot;)</span>
<span class="nc" id="L1367">        .setInitialExtent(</span>
<span class="nc" id="L1368">            new Bounds().minx(558390d).miny(6818485d).maxx(566751d).maxy(6824036d))</span>
<span class="nc" id="L1369">        .setMaxExtent(</span>
<span class="nc" id="L1370">            new Bounds().minx(91467d).miny(6496479d).maxx(1037043d).maxy(7147453d))</span>
<span class="nc" id="L1371">        .setSettings(new AppSettings().uiSettings(new AppUiSettings().enable3D(true)))</span>
<span class="nc" id="L1372">        .setContentRoot(new AppContent()</span>
<span class="nc" id="L1373">            .addBaseLayerNodesItem(new AppTreeLevelNode()</span>
<span class="nc" id="L1374">                .objectType(&quot;AppTreeLevelNode&quot;)</span>
<span class="nc" id="L1375">                .id(&quot;root-base-layers&quot;)</span>
<span class="nc" id="L1376">                .root(true)</span>
<span class="nc" id="L1377">                .title(&quot;Base layers&quot;)</span>
<span class="nc" id="L1378">                .childrenIds(List.of(&quot;lyr:pdok-hwh-luchtfotorgb:Actueel_orthoHR&quot;, &quot;lyr:osm:xyz&quot;)))</span>
<span class="nc" id="L1379">            .addBaseLayerNodesItem(new AppTreeLayerNode()</span>
<span class="nc" id="L1380">                .objectType(&quot;AppTreeLayerNode&quot;)</span>
<span class="nc" id="L1381">                .id(&quot;lyr:pdok-hwh-luchtfotorgb:Actueel_orthoHR&quot;)</span>
<span class="nc" id="L1382">                .serviceId(&quot;pdok-hwh-luchtfotorgb&quot;)</span>
<span class="nc" id="L1383">                .layerName(&quot;Actueel_orthoHR&quot;)</span>
<span class="nc" id="L1384">                .visible(true))</span>
<span class="nc" id="L1385">            .addBaseLayerNodesItem(new AppTreeLayerNode()</span>
<span class="nc" id="L1386">                .objectType(&quot;AppTreeLayerNode&quot;)</span>
<span class="nc" id="L1387">                .id(&quot;lyr:osm:xyz&quot;)</span>
<span class="nc" id="L1388">                .serviceId(&quot;osm&quot;)</span>
<span class="nc" id="L1389">                .layerName(&quot;xyz&quot;)</span>
<span class="nc" id="L1390">                .visible(false))</span>
<span class="nc" id="L1391">            .addLayerNodesItem(new AppTreeLevelNode()</span>
<span class="nc" id="L1392">                .objectType(&quot;AppTreeLevelNode&quot;)</span>
<span class="nc" id="L1393">                .id(&quot;root&quot;)</span>
<span class="nc" id="L1394">                .root(true)</span>
<span class="nc" id="L1395">                .title(&quot;Layers&quot;)</span>
<span class="nc" id="L1396">                .childrenIds(List.of(</span>
                    &quot;lyr:3dbag_utrecht:tiles3d&quot;,
                    &quot;lyr:snapshot-geoserver:postgis:begroeidterreindeel&quot;)))
<span class="nc" id="L1399">            .addLayerNodesItem(new AppTreeLayerNode()</span>
<span class="nc" id="L1400">                .objectType(&quot;AppTreeLayerNode&quot;)</span>
<span class="nc" id="L1401">                .id(&quot;lyr:3dbag_utrecht:tiles3d&quot;)</span>
<span class="nc" id="L1402">                .serviceId(&quot;3dbag_utrecht&quot;)</span>
<span class="nc" id="L1403">                .layerName(&quot;tiles3d&quot;)</span>
<span class="nc" id="L1404">                .visible(true))</span>
<span class="nc" id="L1405">            .addLayerNodesItem(new AppTreeLayerNode()</span>
<span class="nc" id="L1406">                .objectType(&quot;AppTreeLayerNode&quot;)</span>
<span class="nc" id="L1407">                .id(&quot;lyr:snapshot-geoserver:postgis:begroeidterreindeel&quot;)</span>
<span class="nc" id="L1408">                .serviceId(&quot;snapshot-geoserver&quot;)</span>
<span class="nc" id="L1409">                .layerName(&quot;postgis:begroeidterreindeel&quot;)</span>
<span class="nc" id="L1410">                .visible(true))</span>
<span class="nc" id="L1411">            .addTerrainLayerNodesItem(new AppTreeLevelNode()</span>
<span class="nc" id="L1412">                .objectType(&quot;AppTreeLevelNode&quot;)</span>
<span class="nc" id="L1413">                .id(&quot;root-terrain-layers&quot;)</span>
<span class="nc" id="L1414">                .root(true)</span>
<span class="nc" id="L1415">                .title(&quot;Terrain Layers&quot;)</span>
<span class="nc" id="L1416">                .childrenIds(List.of(&quot;lyr:ahn_terrain_model:quantizedmesh&quot;)))</span>
<span class="nc" id="L1417">            .addTerrainLayerNodesItem(new AppTreeLayerNode()</span>
<span class="nc" id="L1418">                .objectType(&quot;AppTreeLayerNode&quot;)</span>
<span class="nc" id="L1419">                .id(&quot;lyr:ahn_terrain_model:quantizedmesh&quot;)</span>
<span class="nc" id="L1420">                .serviceId(&quot;ahn_terrain_model&quot;)</span>
<span class="nc" id="L1421">                .layerName(&quot;quantizedmesh&quot;)</span>
<span class="nc" id="L1422">                .visible(false)));</span>

<span class="nc" id="L1424">    applicationRepository.save(app);</span>

<span class="nc" id="L1426">    Configuration config = new Configuration();</span>
<span class="nc" id="L1427">    config.setKey(Configuration.DEFAULT_APP);</span>
<span class="nc" id="L1428">    config.setValue(&quot;default&quot;);</span>
<span class="nc" id="L1429">    configurationRepository.save(config);</span>
<span class="nc" id="L1430">    config = new Configuration();</span>
<span class="nc" id="L1431">    config.setKey(Configuration.DEFAULT_BASE_APP);</span>
<span class="nc" id="L1432">    config.setValue(&quot;base&quot;);</span>
<span class="nc" id="L1433">    configurationRepository.save(config);</span>
<span class="nc" id="L1434">  }</span>

  private void createConfigurationTestData() throws JsonProcessingException {
<span class="nc" id="L1437">    Configuration config = new Configuration();</span>
<span class="nc" id="L1438">    config.setKey(&quot;test&quot;);</span>
<span class="nc" id="L1439">    config.setAvailableForViewer(true);</span>
<span class="nc" id="L1440">    config.setValue(&quot;test value&quot;);</span>
<span class="nc" id="L1441">    config.setJsonValue(new ObjectMapper().readTree(&quot;{ \&quot;someProperty\&quot;: 1, \&quot;nestedObject\&quot;: { \&quot;num\&quot;: 42 } }&quot;));</span>
<span class="nc" id="L1442">    configurationRepository.save(config);</span>
<span class="nc" id="L1443">  }</span>

  @Transactional
  public void createSolrIndex() throws Exception {
<span class="nc bnc" id="L1447" title="All 2 branches missed.">    if (connectToSpatialDbs) {</span>
      // flush() the repo because we need to make sure feature type testdata is fully stored
      // before creating the Solr index (which requires access to the feature type settings)
<span class="nc" id="L1450">      featureSourceRepository.flush();</span>

<span class="nc" id="L1452">      logger.info(&quot;Creating Solr index&quot;);</span>
      @SuppressWarnings(&quot;PMD.AvoidUsingHardCodedIP&quot;)
<span class="nc bnc" id="L1454" title="All 2 branches missed.">      final String solrUrl = &quot;http://&quot; + (connectToSpatialDbsAtLocalhost ? &quot;127.0.0.1&quot; : &quot;solr&quot;) + &quot;:8983/solr/&quot;;</span>
<span class="nc" id="L1455">      this.solrService.setSolrUrl(solrUrl);</span>
<span class="nc" id="L1456">      SolrHelper solrHelper = new SolrHelper(this.solrService.getSolrClientForIndexing())</span>
<span class="nc" id="L1457">          .withBatchSize(solrBatchSize)</span>
<span class="nc" id="L1458">          .withGeometryValidationRule(solrGeometryValidationRule);</span>
<span class="nc" id="L1459">      GeoService geoService =</span>
<span class="nc" id="L1460">          geoServiceRepository.findById(&quot;snapshot-geoserver&quot;).orElseThrow();</span>
<span class="nc" id="L1461">      Application defaultApp = applicationRepository.findByName(&quot;default&quot;);</span>

<span class="nc" id="L1463">      TMFeatureType begroeidterreindeelFT = geoService.findFeatureTypeForLayer(</span>
<span class="nc" id="L1464">          geoService.findLayer(&quot;postgis:begroeidterreindeel&quot;), featureSourceRepository);</span>

<span class="nc" id="L1466">      TMFeatureType wegdeelFT = geoService.findFeatureTypeForLayer(</span>
<span class="nc" id="L1467">          geoService.findLayer(&quot;sqlserver:wegdeel&quot;), featureSourceRepository);</span>

<span class="nc" id="L1469">      TMFeatureType kadastraalPerceelFT = geoService.findFeatureTypeForLayer(</span>
<span class="nc" id="L1470">          geoService.findLayer(&quot;postgis:kadastraal_perceel&quot;), featureSourceRepository);</span>

<span class="nc" id="L1472">      try (solrHelper) {</span>
<span class="nc" id="L1473">        SearchIndex begroeidterreindeelIndex = null;</span>
<span class="nc bnc" id="L1474" title="All 2 branches missed.">        if (begroeidterreindeelFT != null) {</span>
<span class="nc" id="L1475">          begroeidterreindeelIndex = new SearchIndex()</span>
<span class="nc" id="L1476">              .setName(&quot;Begroeidterreindeel&quot;)</span>
<span class="nc" id="L1477">              .setFeatureTypeId(begroeidterreindeelFT.getId())</span>
<span class="nc" id="L1478">              .setSearchFieldsUsed(List.of(&quot;class&quot;, &quot;plus_fysiekvoorkomen&quot;, &quot;bronhouder&quot;))</span>
<span class="nc" id="L1479">              .setSearchDisplayFieldsUsed(List.of(&quot;class&quot;, &quot;plus_fysiekvoorkomen&quot;));</span>
<span class="nc" id="L1480">          begroeidterreindeelIndex = searchIndexRepository.save(begroeidterreindeelIndex);</span>
<span class="nc" id="L1481">          begroeidterreindeelIndex = solrHelper.addFeatureTypeIndex(</span>
              begroeidterreindeelIndex,
              begroeidterreindeelFT,
              featureSourceFactoryHelper,
              searchIndexRepository);
<span class="nc" id="L1486">          begroeidterreindeelIndex = searchIndexRepository.save(begroeidterreindeelIndex);</span>
        }

<span class="nc" id="L1489">        SearchIndex kadastraalPerceelIndex = null;</span>
<span class="nc bnc" id="L1490" title="All 2 branches missed.">        if (kadastraalPerceelFT != null) {</span>
<span class="nc" id="L1491">          kadastraalPerceelIndex = new SearchIndex()</span>
<span class="nc" id="L1492">              .setName(&quot;kadastraal_perceel&quot;)</span>
<span class="nc" id="L1493">              .setFeatureTypeId(kadastraalPerceelFT.getId())</span>
<span class="nc" id="L1494">              .setSearchFieldsUsed(List.of(&quot;aanduiding&quot;))</span>
<span class="nc" id="L1495">              .setSearchDisplayFieldsUsed(List.of(&quot;aanduiding&quot;));</span>
<span class="nc" id="L1496">          kadastraalPerceelIndex = searchIndexRepository.save(kadastraalPerceelIndex);</span>
<span class="nc" id="L1497">          kadastraalPerceelIndex = solrHelper.addFeatureTypeIndex(</span>
              kadastraalPerceelIndex,
              kadastraalPerceelFT,
              featureSourceFactoryHelper,
              searchIndexRepository);
<span class="nc" id="L1502">          kadastraalPerceelIndex = searchIndexRepository.save(kadastraalPerceelIndex);</span>
        }

<span class="nc" id="L1505">        SearchIndex wegdeelIndex = null;</span>
<span class="nc bnc" id="L1506" title="All 2 branches missed.">        if (wegdeelFT != null) {</span>
<span class="nc" id="L1507">          wegdeelIndex = new SearchIndex()</span>
<span class="nc" id="L1508">              .setName(&quot;Wegdeel&quot;)</span>
<span class="nc" id="L1509">              .setFeatureTypeId(wegdeelFT.getId())</span>
<span class="nc" id="L1510">              .setSearchFieldsUsed(List.of(</span>
                  &quot;function_&quot;, &quot;plus_fysiekvoorkomenwegdeel&quot;, &quot;surfacematerial&quot;, &quot;bronhouder&quot;))
<span class="nc" id="L1512">              .setSearchDisplayFieldsUsed(List.of(&quot;function_&quot;, &quot;plus_fysiekvoorkomenwegdeel&quot;));</span>
<span class="nc" id="L1513">          wegdeelIndex = searchIndexRepository.save(wegdeelIndex);</span>
<span class="nc" id="L1514">          wegdeelIndex = solrHelper.addFeatureTypeIndex(</span>
              wegdeelIndex, wegdeelFT, featureSourceFactoryHelper, searchIndexRepository);
<span class="nc" id="L1516">          wegdeelIndex = searchIndexRepository.save(wegdeelIndex);</span>
        }

<span class="nc" id="L1519">        featureSourceRepository</span>
<span class="nc" id="L1520">            .getByTitle(&quot;PostGIS&quot;)</span>
<span class="nc" id="L1521">            .flatMap(fs -&gt; fs.getFeatureTypes().stream()</span>
<span class="nc" id="L1522">                .filter(ft -&gt; ft.getName().equals(&quot;bak&quot;))</span>
<span class="nc" id="L1523">                .findFirst())</span>
<span class="nc" id="L1524">            .ifPresent(ft -&gt; {</span>
<span class="nc" id="L1525">              SearchIndex bak = new SearchIndex()</span>
<span class="nc" id="L1526">                  .setName(&quot;bak&quot;)</span>
<span class="nc" id="L1527">                  .setFeatureTypeId(ft.getId())</span>
<span class="nc" id="L1528">                  .setSearchFieldsUsed(List.of(&quot;gmlid&quot;, &quot;identificatie&quot;, &quot;plus_type&quot;))</span>
<span class="nc" id="L1529">                  .setSearchDisplayFieldsUsed(List.of(&quot;gmlid&quot;, &quot;plus_type&quot;, &quot;bronhouder&quot;));</span>
<span class="nc" id="L1530">              searchIndexRepository.save(bak);</span>
              try {
<span class="nc" id="L1532">                bak = solrHelper.addFeatureTypeIndex(</span>
                    bak, ft, featureSourceFactoryHelper, searchIndexRepository);
<span class="nc" id="L1534">                searchIndexRepository.save(bak);</span>
<span class="nc" id="L1535">              } catch (IOException | SolrServerException e) {</span>
<span class="nc" id="L1536">                throw new RuntimeException(e);</span>
<span class="nc" id="L1537">              }</span>
<span class="nc" id="L1538">            });</span>

        // creating a solr index of config this will/should fail because there is no primary key in the FT
<span class="nc" id="L1541">        featureSourceRepository</span>
<span class="nc" id="L1542">            .getByTitle(&quot;PostGIS OSM&quot;)</span>
<span class="nc" id="L1543">            .flatMap(fs -&gt; fs.getFeatureTypes().stream()</span>
<span class="nc" id="L1544">                .filter(ft -&gt; ft.getName().equals(&quot;osm_roads&quot;))</span>
<span class="nc" id="L1545">                .findFirst())</span>
<span class="nc" id="L1546">            .ifPresent(ft -&gt; {</span>
<span class="nc" id="L1547">              SearchIndex osm_no_pk = new SearchIndex()</span>
<span class="nc" id="L1548">                  .setName(&quot;osm_no_pk&quot;)</span>
<span class="nc" id="L1549">                  .setFeatureTypeId(ft.getId())</span>
<span class="nc" id="L1550">                  .setSearchFieldsUsed(List.of(&quot;landuse&quot;, &quot;osm_id&quot;, &quot;natural&quot;, &quot;boundary&quot;))</span>
<span class="nc" id="L1551">                  .setSearchDisplayFieldsUsed(</span>
<span class="nc" id="L1552">                      List.of(&quot;landuse&quot;, &quot;osm_id&quot;, &quot;natural&quot;, &quot;amenity&quot;, &quot;boundary&quot;));</span>
<span class="nc" id="L1553">              searchIndexRepository.save(osm_no_pk);</span>
<span class="nc" id="L1554">            });</span>

<span class="nc" id="L1556">        AppTreeLayerNode begroeidTerreindeelLayerNode = defaultApp</span>
<span class="nc" id="L1557">            .getAllAppTreeLayerNode()</span>
<span class="nc" id="L1558">            .filter(node -&gt; node.getId().equals(&quot;lyr:snapshot-geoserver:postgis:begroeidterreindeel&quot;))</span>
<span class="nc" id="L1559">            .findFirst()</span>
<span class="nc" id="L1560">            .orElse(null);</span>

<span class="nc bnc" id="L1562" title="All 4 branches missed.">        if (begroeidTerreindeelLayerNode != null &amp;&amp; begroeidterreindeelIndex != null) {</span>
<span class="nc" id="L1563">          defaultApp</span>
<span class="nc" id="L1564">              .getAppLayerSettings(begroeidTerreindeelLayerNode)</span>
<span class="nc" id="L1565">              .setSearchIndexId(begroeidterreindeelIndex.getId());</span>
        }

<span class="nc" id="L1568">        AppTreeLayerNode kadastraalPerceelLayerNode = defaultApp</span>
<span class="nc" id="L1569">            .getAllAppTreeLayerNode()</span>
<span class="nc" id="L1570">            .filter(node -&gt; node.getId().equals(&quot;lyr:snapshot-geoserver:postgis:kadastraal_perceel&quot;))</span>
<span class="nc" id="L1571">            .findFirst()</span>
<span class="nc" id="L1572">            .orElse(null);</span>

<span class="nc bnc" id="L1574" title="All 4 branches missed.">        if (kadastraalPerceelLayerNode != null &amp;&amp; kadastraalPerceelIndex != null) {</span>
<span class="nc" id="L1575">          defaultApp</span>
<span class="nc" id="L1576">              .getAppLayerSettings(kadastraalPerceelLayerNode)</span>
<span class="nc" id="L1577">              .setSearchIndexId(kadastraalPerceelIndex.getId());</span>
        }

<span class="nc" id="L1580">        AppTreeLayerNode wegdeel = defaultApp</span>
<span class="nc" id="L1581">            .getAllAppTreeLayerNode()</span>
<span class="nc" id="L1582">            .filter(node -&gt; node.getId().equals(&quot;lyr:snapshot-geoserver:sqlserver:wegdeel&quot;))</span>
<span class="nc" id="L1583">            .findFirst()</span>
<span class="nc" id="L1584">            .orElse(null);</span>

<span class="nc bnc" id="L1586" title="All 4 branches missed.">        if (wegdeel != null &amp;&amp; wegdeelIndex != null) {</span>
<span class="nc" id="L1587">          defaultApp.getAppLayerSettings(wegdeel).setSearchIndexId(wegdeelIndex.getId());</span>
        }

<span class="nc" id="L1590">        applicationRepository.save(defaultApp);</span>
      }
    }
<span class="nc" id="L1593">  }</span>

  private void createScheduledTasks() {
    try {
<span class="nc" id="L1597">      logger.info(&quot;Creating POC tasks&quot;);</span>
<span class="nc" id="L1598">      logger.info(</span>
          &quot;Created 15 minutely task with key: {}&quot;,
<span class="nc" id="L1600">          taskManagerService.createTask(</span>
              PocTask.class,
<span class="nc" id="L1602">              new TMJobDataMap(Map.of(</span>
                  Task.TYPE_KEY,
<span class="nc" id="L1604">                  TaskType.POC.getValue(),</span>
                  &quot;foo&quot;,
                  &quot;foobar&quot;,
                  Task.DESCRIPTION_KEY,
                  &quot;POC task that runs every 15 minutes&quot;)),
              /* run every 15 minutes */ &quot;0 0/15 * 1/1 * ? *&quot;));
<span class="nc" id="L1610">      logger.info(</span>
          &quot;Created hourly task with key: {}&quot;,
<span class="nc" id="L1612">          taskManagerService.createTask(</span>
              PocTask.class,
<span class="nc" id="L1614">              new TMJobDataMap(Map.of(</span>
                  Task.TYPE_KEY,
<span class="nc" id="L1616">                  TaskType.POC.getValue(),</span>
                  &quot;foo&quot;,
                  &quot;bar&quot;,
                  Task.DESCRIPTION_KEY,
                  &quot;POC task that runs every hour&quot;,
                  Task.PRIORITY_KEY,
<span class="nc" id="L1622">                  10)),</span>
              /* run every hour */ &quot;0 0 0/1 1/1 * ? *&quot;));

<span class="nc" id="L1625">      logger.info(</span>
          &quot;Created hourly failing task with key: {}&quot;,
<span class="nc" id="L1627">          taskManagerService.createTask(</span>
              FailingPocTask.class,
<span class="nc" id="L1629">              new TMJobDataMap(Map.of(</span>
                  Task.TYPE_KEY,
<span class="nc" id="L1631">                  TaskType.FAILINGPOC.getValue(),</span>
                  Task.DESCRIPTION_KEY,
                  &quot;POC task that fails every hour with low priority&quot;,
                  Task.PRIORITY_KEY,
<span class="nc" id="L1635">                  100)),</span>
              /* run every hour */ &quot;0 0 0/1 1/1 * ? *&quot;));
<span class="nc" id="L1637">      logger.info(</span>
          &quot;Created daily task with key: {}&quot;,
<span class="nc" id="L1639">          taskManagerService.createTask(</span>
              InterruptablePocTask.class,
<span class="nc" id="L1641">              new TMJobDataMap(Map.of(</span>
                  Task.TYPE_KEY,
<span class="nc" id="L1643">                  TaskType.INTERRUPTABLEPOC.getValue(),</span>
                  Task.DESCRIPTION_KEY,
                  &quot;Interruptable POC task that runs every 15 minutes&quot;,
                  Task.PRIORITY_KEY,
<span class="nc" id="L1647">                  5)),</span>
              /* run every 15 minutes */ &quot;0 0/15 * 1/1 * ? *&quot;));
<span class="nc" id="L1649">    } catch (SchedulerException e) {</span>
<span class="nc" id="L1650">      logger.error(&quot;Error creating scheduled one or more poc tasks&quot;, e);</span>
<span class="nc" id="L1651">    }</span>

<span class="nc bnc" id="L1653" title="All 2 branches missed.">    if (categories.contains(&quot;search-index&quot;)) {</span>
<span class="nc" id="L1654">      logger.info(&quot;Creating INDEX tasks&quot;);</span>
<span class="nc" id="L1655">      List.of(&quot;Begroeidterreindeel&quot;, &quot;kadastraal_perceel&quot;)</span>
<span class="nc" id="L1656">          .forEach(name -&gt; searchIndexRepository.findByName(name).ifPresent(index -&gt; {</span>
<span class="nc" id="L1657">            index.setSchedule(new TaskSchedule()</span>
                /* hour */
<span class="nc" id="L1659">                .cronExpression(&quot;0 0 0/1 1/1 * ? *&quot;)</span>
                // /* 15 min */
                // .cronExpression(&quot;0 0/15 * 1/1 * ? *&quot;)
<span class="nc" id="L1662">                .description(&quot;Update Solr index \&quot; &quot; + name + &quot;\&quot; every hour&quot;));</span>
            try {
<span class="nc" id="L1664">              final UUID uuid = taskManagerService.createTask(</span>
                  IndexTask.class,
<span class="nc" id="L1666">                  new TMJobDataMap(Map.of(</span>
                      Task.TYPE_KEY,
                      TaskType.INDEX,
                      Task.DESCRIPTION_KEY,
<span class="nc" id="L1670">                      index.getSchedule().getDescription(),</span>
                      IndexTask.INDEX_KEY,
<span class="nc" id="L1672">                      index.getId().toString(),</span>
                      Task.PRIORITY_KEY,
<span class="nc" id="L1674">                      10)),</span>
<span class="nc" id="L1675">                  index.getSchedule().getCronExpression());</span>

<span class="nc" id="L1677">              index.getSchedule().setUuid(uuid);</span>
<span class="nc" id="L1678">              searchIndexRepository.save(index);</span>

<span class="nc" id="L1680">              logger.info(&quot;Created task to update Solr index with key: {}&quot;, uuid);</span>
<span class="nc" id="L1681">            } catch (SchedulerException e) {</span>
<span class="nc" id="L1682">              logger.error(&quot;Error creating scheduled solr index task&quot;, e);</span>
<span class="nc" id="L1683">            }</span>
<span class="nc" id="L1684">          }));</span>
    }
<span class="nc" id="L1686">  }</span>

  private void createPages() throws IOException {
<span class="nc" id="L1689">    Upload logo = new Upload()</span>
<span class="nc" id="L1690">        .setCategory(Upload.CATEGORY_PORTAL_IMAGE)</span>
<span class="nc" id="L1691">        .setFilename(&quot;gradient.svg&quot;)</span>
<span class="nc" id="L1692">        .setMimeType(&quot;image/svg+xml&quot;)</span>
<span class="nc" id="L1693">        .setContent(new ClassPathResource(&quot;test/gradient-logo.svg&quot;).getContentAsByteArray())</span>
<span class="nc" id="L1694">        .setLastModified(OffsetDateTime.now(ZoneId.systemDefault()));</span>
<span class="nc" id="L1695">    uploadRepository.save(logo);</span>

<span class="nc" id="L1697">    Page about = new Page();</span>
<span class="nc" id="L1698">    about.setName(&quot;about&quot;);</span>
<span class="nc" id="L1699">    about.setType(&quot;page&quot;);</span>
<span class="nc" id="L1700">    about.setContent(&quot;About Tailormap&quot;);</span>
<span class="nc" id="L1701">    about.setContent(&quot;&quot;&quot;</span>
# About Tailormap

This is a page about *Tailormap*. It doesn't say much yet.
&quot;&quot;&quot;);
<span class="nc" id="L1706">    pageRepository.save(about);</span>

<span class="nc" id="L1708">    Page page = new Page();</span>
<span class="nc" id="L1709">    page.setName(&quot;home&quot;);</span>
<span class="nc" id="L1710">    page.setType(&quot;page&quot;);</span>
<span class="nc" id="L1711">    page.setTitle(&quot;Tailormap - Home&quot;);</span>
<span class="nc" id="L1712">    page.setContent(</span>
        &quot;&quot;&quot;
# Welcome to Tailormap!

This page is only visible when you implement a frontend to display pages, or get it (including a simple CMS)
from [B3Partners](https://www.b3partners.nl)!
&quot;&quot;&quot;);
<span class="nc" id="L1719">    page.setClassName(null);</span>
<span class="nc" id="L1720">    page.setTiles(List.of(</span>
        new PageTile()
<span class="nc" id="L1722">            .id(UUID.randomUUID().toString())</span>
<span class="nc" id="L1723">            .title(&quot;Default app&quot;)</span>
<span class="nc" id="L1724">            .applicationId(Optional.ofNullable(applicationRepository.findByName(&quot;default&quot;))</span>
<span class="nc" id="L1725">                .map(Application::getId)</span>
<span class="nc" id="L1726">                .orElse(null))</span>
<span class="nc" id="L1727">            .image(logo.getId().toString())</span>
<span class="nc" id="L1728">            .content(&quot;*Default app* tile content&quot;)</span>
<span class="nc" id="L1729">            .filterRequireAuthorization(false)</span>
<span class="nc" id="L1730">            .openInNewWindow(false),</span>
        new PageTile()
<span class="nc" id="L1732">            .id(UUID.randomUUID().toString())</span>
<span class="nc" id="L1733">            .title(&quot;Secured app&quot;)</span>
<span class="nc" id="L1734">            .applicationId(Optional.ofNullable(applicationRepository.findByName(&quot;secured&quot;))</span>
<span class="nc" id="L1735">                .map(Application::getId)</span>
<span class="nc" id="L1736">                .orElse(null))</span>
<span class="nc" id="L1737">            .filterRequireAuthorization(true)</span>
<span class="nc" id="L1738">            .content(&quot;Secure app, only shown if user has authorization&quot;)</span>
<span class="nc" id="L1739">            .openInNewWindow(false),</span>
        new PageTile()
<span class="nc" id="L1741">            .id(UUID.randomUUID().toString())</span>
<span class="nc" id="L1742">            .title(&quot;Secured app (unfiltered)&quot;)</span>
<span class="nc" id="L1743">            .applicationId(Optional.ofNullable(applicationRepository.findByName(&quot;secured&quot;))</span>
<span class="nc" id="L1744">                .map(Application::getId)</span>
<span class="nc" id="L1745">                .orElse(null))</span>
<span class="nc" id="L1746">            .filterRequireAuthorization(false)</span>
<span class="nc" id="L1747">            .content(&quot;Secure app, tile shown to everyone&quot;)</span>
<span class="nc" id="L1748">            .openInNewWindow(false),</span>
        new PageTile()
<span class="nc" id="L1750">            .id(UUID.randomUUID().toString())</span>
<span class="nc" id="L1751">            .title(&quot;About&quot;)</span>
<span class="nc" id="L1752">            .pageId(about.getId())</span>
<span class="nc" id="L1753">            .openInNewWindow(false),</span>
        new PageTile()
<span class="nc" id="L1755">            .id(UUID.randomUUID().toString())</span>
<span class="nc" id="L1756">            .title(&quot;B3Partners&quot;)</span>
<span class="nc" id="L1757">            .url(&quot;https://www.b3partners.nl/&quot;)</span>
<span class="nc" id="L1758">            .openInNewWindow(true)));</span>
<span class="nc" id="L1759">    pageRepository.save(page);</span>

<span class="nc" id="L1761">    Configuration c = new Configuration();</span>
<span class="nc" id="L1762">    c.setKey(HOME_PAGE);</span>
<span class="nc" id="L1763">    c.setValue(page.getId().toString());</span>
<span class="nc" id="L1764">    configurationRepository.save(c);</span>

<span class="nc" id="L1766">    List&lt;MenuItem&gt; globalMenuItems = List.of(</span>
<span class="nc" id="L1767">        new MenuItem().pageId(about.getId()).label(&quot;About&quot;).openInNewWindow(false),</span>
        new MenuItem()
<span class="nc" id="L1769">            .label(&quot;B3Partners website&quot;)</span>
<span class="nc" id="L1770">            .url(&quot;https://www.b3partners.nl/&quot;)</span>
<span class="nc" id="L1771">            .openInNewWindow(true)</span>
<span class="nc" id="L1772">            .exclusiveOnPageId(about.getId()));</span>
<span class="nc" id="L1773">    c = new Configuration();</span>
<span class="nc" id="L1774">    c.setKey(PORTAL_MENU);</span>
<span class="nc" id="L1775">    c.setJsonValue(new ObjectMapper().valueToTree(globalMenuItems));</span>
<span class="nc" id="L1776">    configurationRepository.save(c);</span>
<span class="nc" id="L1777">  }</span>

  private void insertTestDrawing() {
    // note that the drawing uuid is hardcoded and used in the DrawingControllerIntegrationTest
    try {
<span class="nc" id="L1782">      this.jdbcClient</span>
<span class="nc" id="L1783">          .sql(</span>
              &quot;&quot;&quot;
INSERT INTO data.drawing (id,name,description,domain_data,&quot;access&quot;,created_by,created_at,updated_by,updated_at,srid,&quot;version&quot;) VALUES
('38faa008-013e-49d4-9528-8f58c94d8791'::uuid,'Testcase','A private access drawing that is inserted as part of the testdata','{&quot;items&quot;: 1, &quot;domain&quot;: &quot;test drawings&quot;}','private','tm-admin','2025-02-27 17:53:36.095164+01','tm-admin','2025-02-27 17:54:19.384961+01',28992,1);
&quot;&quot;&quot;)
<span class="nc" id="L1788">          .update();</span>

<span class="nc" id="L1790">      this.jdbcClient</span>
<span class="nc" id="L1791">          .sql(</span>
              &quot;&quot;&quot;
INSERT INTO data.drawing_feature (drawing_id,id,geometry,properties) VALUES
('38faa008-013e-49d4-9528-8f58c94d8791'::uuid,'9637cda5-c2f5-414e-ae2f-8a8195354ee1'::uuid,'SRID=28992;POLYGON ((132300.928 458629.588, 132302.724 458633.881, 132302.947 458634.318, 132303.327 458634.91400000005, 132303.772 458635.463, 132304.277 458635.95800000004, 132304.834 458636.393, 132305.436 458636.76200000005, 132306.076 458637.061, 132306.746 458637.28599999996, 132307.437 458637.433, 132308.141 458637.502, 132308.847 458637.49, 132309.548 458637.399, 132309.586 458637.39099999995, 132310.246 458637.205, 132311.059 458639.08, 132308.945 458639.943, 132306.112 458641.216, 132305.358 458639.943, 132304.898 458639.368, 132304.292 458638.757, 132303.703 458638.277, 132302.98 458637.805, 132302.304 458637.459, 132301.497 458637.14699999994, 132300.764 458636.94999999995, 132298.981 458636.524, 132297.813 458636.3460000001, 132296.568 458636.24199999997, 132295.387 458636.223, 132294.148 458636.288, 132292.419 458636.46499999997, 132290.614 458636.73099999997, 132288.866 458637.069, 132287.14 458637.485, 132270.926 458640.482, 132267.328 458613.3950000001, 132264.028 458607.445, 132258.431 458602.51900000003, 132259.646 458600, 132260.791 458597.624, 132267.141 458592.053, 132271.287 458591.25299999997, 132284.279 458588.227, 132294.24 458585.92399999994, 132295.651 458595.245, 132296.248 458600, 132297.991 458613.87, 132300.928 458629.588))'::public.geometry,'{&quot;prop0&quot;: &quot;value0&quot;}'),
('38faa008-013e-49d4-9528-8f58c94d8791'::uuid,'21d1b15f-9b1a-48cc-9770-9a70ba1a4637'::uuid,'SRID=28992;POINT (132300 458629)'::public.geometry,'{&quot;prop0&quot;: &quot;value1&quot;, &quot;prop1&quot;: 0.0, &quot;rendering&quot;: {&quot;fill&quot;: &quot;red&quot;, &quot;stroke&quot;: &quot;black&quot;}}');
&quot;&quot;&quot;)
<span class="nc" id="L1797">          .update();</span>
<span class="nc" id="L1798">    } catch (Exception any) {</span>
<span class="nc" id="L1799">      logger.error(&quot;Error inserting test drawing in data schema, some tests may fail&quot;, any);</span>
<span class="nc" id="L1800">    }</span>
<span class="nc" id="L1801">  }</span>
}
</pre><div class="footer"><span class="right">Created with <a href="http://www.jacoco.org/jacoco">JaCoCo</a> 0.8.12.202403310830</span></div></body></html>